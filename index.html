
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow - Real-time Study Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel='icon' href="favicon.ico">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        /* Base styles */
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden; /* Prevent horizontal scrolling on the entire body */
            background-color: #0d1117; /* Darker, modern background */
            background-image: radial-gradient(ellipse at top, rgba(20, 184, 166, 0.15), transparent 60%);
            color: #e6edf3; /* Brighter default text */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .nav-item.active, .group-nav-item.active {
            background: linear-gradient(to top, rgba(20, 184, 166, 0.2), transparent);
        }
        .nav-item.active svg, .nav-item.active p, .group-nav-item.active i, .group-nav-item.active p { 
            color: #14b8a6; /* Teal-500 */
        }

        /* Page and container visibility */
        #auth-screen, .page, #app-container, .modal { display: none; }
        #auth-screen.active, .page.active, #app-container.active, .modal.active { display: flex; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* UI element styles */
        .timer-text { font-weight: 900; letter-spacing: -0.05em; }
        
        /* Pomodoro Switch Styles */
        .timer-switch-container {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #161b22; /* Darker secondary bg */
            padding: 0.5rem;
            border-radius: 9999px;
            width: fit-content;
        }
        .timer-switch-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            background-color: transparent;
            color: #9ca3af;
            font-weight: 600;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .timer-switch-btn.active {
            background-image: linear-gradient(to right, #2dd4bf, #38bdf8); /* Teal to Sky gradient */
            color: white;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.2);
        }
        #pomodoro-status {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f59e0b; /* Amber color for breaks */
            height: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Pomodoro Settings Modal Scroll Fix */
        #pomodoro-settings-modal .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2dd4bf; /* Teal-400 */
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Volume Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #4b5563;
            border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2dd4bf; /* Teal-400 */
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -6px;
        }

        /* Group study styles */
        .group-card {
            background: #161b22; /* Darker secondary bg */
            border: 1px solid #30363d; /* Subtle border */
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            cursor: pointer;
        }
        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(45, 212, 191, 0.1); /* Teal glow */
            border-color: #2dd4bf;
        }
        .group-header {
            padding: 16px;
            background: linear-gradient(135deg, #2dd4bf 0%, #38bdf8 100%); /* Teal to Sky gradient */
            color: white;
        }
        .group-category {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
            opacity: 0.9;
        }
        .group-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .group-name .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
        }
        .group-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.1rem; font-weight: 700; }
        .stat-label { font-size: 0.75rem; opacity: 0.8; }
        .group-body { padding: 16px; }
        .group-goal {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #374151;
        }
        .goal-text { font-weight: 600; color: white; margin-bottom: 6px; }
        .leader {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            color: #38bdf8; /* Sky-400 */
        }
        .leader i { color: gold; }
        .group-description {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        .group-meta {
            display: flex;
            justify-content: space-between;
            color: #9CA3AF;
            font-size: 0.8rem;
            margin-top: 12px;
        }
        .join-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background: #38bdf8; /* Sky-400 */
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
        }
        .join-btn:hover { background: #2dd4bf; }
        .join-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .joined-badge {
            display: block;
            width: 100%;
            padding: 10px;
            background: #2dd4bf; /* Teal-400 */
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
        }
        .join-btn:hover { background: #4895ef; }
        .join-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .joined-badge {
            display: block;
            width: 100%;
            padding: 10px;
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            margin-top: 12px;
        }
        .empty-group {
            text-align: center;
            padding: 40px 20px;
            color: #9CA3AF;
        }
        .empty-group i { font-size: 3rem; color: #30363d; margin-bottom: 16px; }
        .empty-group h3 { font-size: 1.5rem; margin-bottom: 12px; color: white; }
        .empty-group p { font-size: 1rem; max-width: 500px; margin: 0 auto 20px; }
        .category-option, .time-option {
            padding: 12px;
            text-align: center;
            background: #21262d;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: 600;
        }
        .category-option:hover, .time-option:hover { background: #30363d; }
        .category-option.selected, .time-option.selected {
            background: #2dd4bf;
            color: white;
            border-color: #14b8a6;
        }
        .create-group-btn {
            position: fixed;
            bottom: 80px; /* Adjusted for main nav */
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(to right, #2dd4bf, #38bdf8); /* Teal to Sky gradient */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 30;
        }
        .create-group-btn:hover { background: #2dd4bf; transform: scale(1.05); }

        /* Group Ranking Styles */
        .group-filter-btn {
            padding: 6px 12px;
            background-color: transparent;
            border-radius: 6px;
            font-weight: 500;
            color: #9CA3AF;
            transition: all 0.2s;
        }
        .group-filter-btn.active {
            background-image: linear-gradient(to right, #2dd4bf, #38bdf8);
            color: white;
            box-shadow: 0 2px 8px rgba(56, 189, 248, 0.3);
        }
        .group-card.ranking {
            cursor: default;
        }
        .group-card.ranking:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        /* Stats page styles */
        .stats-container { padding: 20px; }
        .stat-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #E5E7EB;
        }
        
        /* Ranking page styles */
        .ranking-list { padding: 20px; }
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .rank {
            font-weight: 700;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }
        .rank-1 { color: gold; }
        .rank-2 { color: silver; }
        .rank-3 { color: #cd7f32; }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #30363d;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; }
        .user-time { color: #9CA3AF; font-size: 0.9rem; }
        .ranking-tab-btn {
            background-color: transparent;
            border-bottom: 2px solid transparent;
            color: #9CA3AF;
            transition: all 0.2s;
        }
        .ranking-tab-btn.active {
            color: #2dd4bf;
            border-bottom: 2px solid #2dd4bf;
        }
        
        /* Planner page styles */
        .planner-container { padding: 20px; }
        .planner-day {
            background: #161b22;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .day-header {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        .planner-task {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #30363d;
        }
        .task-checkbox { margin-right: 10px; }
        .task-name { flex-grow: 1; }
        .task-name.completed { text-decoration: line-through; color: #6B7280; }
        
        /* New Planner Styles */
        #page-planner {
            /* The .active class handles display. This rule ensures the page is opaque and controls overflow. */
            background-color: #0d1117;
            overflow: hidden;
        }
        .planner-main-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        #planner-sidebar {
            width: 250px;
            flex-shrink: 0;
            background-color: #0d1117;
            border-right: 1px solid #30363d;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
        }
         #planner-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .planner-sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .planner-sidebar-item:hover {
            background-color: #30363d;
        }
        .planner-sidebar-item.active {
            background-color: #2dd4bf;
            color: white;
        }
         #planner-main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
         #planner-task-details {
            width: 350px;
            flex-shrink: 0;
            background-color: #0d1117;
            border-left: 1px solid #30363d;
            overflow-y: auto;
            transition: width 0.3s ease;
        }
        #planner-task-details.hidden {
            width: 0;
            padding: 0;
            overflow: hidden;
        }

        /* Task Item */
        .task-item {
            border-left-width: 4px;
        }

        /* Kanban Board */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        .kanban-column {
            background-color: #161b22;
            border-radius: 0.75rem;
            padding: 0.75rem;
        }
        .kanban-card {
             background-color: #21262d;
        }

        /* NEW Calendar View Styles */
        .calendar-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1rem;
        }
        .calendar-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .calendar-nav-btn {
            background-color: #21262d;
            border: 1px solid #30363d;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-nav-btn:hover {
            background-color: #30363d;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            flex-grow: 1;
            border-top: 1px solid #30363d;
            border-left: 1px solid #30363d;
        }
        .calendar-day-header, .calendar-day-cell {
            padding: 0.5rem;
            border-right: 1px solid #30363d;
            border-bottom: 1px solid #30363d;
        }
        .calendar-day-header {
            text-align: center;
            font-weight: 500;
            color: #9ca3af;
            font-size: 0.875rem;
        }
        .calendar-day-cell {
            min-height: 120px;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s;
        }
        .calendar-day-cell:not(.other-month):hover {
            background-color: #161b22;
        }
        .day-number {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .day-number.today {
            background: linear-gradient(to right, #2dd4bf, #38bdf8);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-day-cell.other-month .day-number {
            color: #6b7280;
        }
        .calendar-tasks-container {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .calendar-task {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background-color 0.2s;
        }
        .calendar-task:hover {
            opacity: 0.8;
        }
        .calendar-task.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .calendar-task.priority-high { background-color: #ef4444; }
        .calendar-task.priority-medium { background-color: #f59e0b; }
        .calendar-task.priority-low { background-color: #3b82f6; }
        .calendar-task.priority-none { background-color: #6b7280; }
        
        /* Planner Responsive Adjustments */
        @media (max-width: 768px) {
            .planner-main-layout {
                flex-direction: column;
            }
            #planner-sidebar {
                position: fixed;
                top: 73px; /* Height of header */
                left: 0;
                bottom: 57px; /* Height of nav */
                height: auto;
                z-index: 40;
                transform: translateX(-100%);
            }
            #planner-sidebar.open {
                transform: translateX(0);
            }
            #planner-task-details {
                position: fixed;
                top: 73px;
                right: 0;
                bottom: 57px;
                height: auto;
                width: 85%;
                max-width: 350px;
                z-index: 40;
                transform: translateX(100%);
                border-left: 1px solid #374151;
            }
            #planner-task-details.open {
                transform: translateX(0);
            }
            #planner-task-details.hidden {
                transform: translateX(100%);
            }
            .kanban-board {
                display: flex;
                overflow-x: auto;
                padding-bottom: 1rem;
            }
            .kanban-column {
                min-width: 280px;
                flex-shrink: 0;
            }
            .calendar-grid {
                gap: 2px;
            }
            .calendar-cell {
                min-height: 80px;
                padding: 4px;
            }
        }

        /* New Planner List View Styles */
        #planner-list-view-container {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: #0d1117; /* Match page bg */
        }
        .planner-search-bar {
            position: relative;
            margin-bottom: 1rem;
        }
        .planner-search-bar i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }
        .planner-search-bar input {
            width: 100%;
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem 0.75rem 2.75rem;
            color: white;
            font-size: 1rem;
            outline: none;
        }
        .planner-search-bar input::placeholder {
            color: #9ca3af;
        }
        .planner-list-section {
            flex-grow: 1;
            overflow-y: auto;
        }
        .planner-list-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .planner-list-item:hover {
            background-color: #21262d;
        }
        .planner-list-item .icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: white;
            flex-shrink: 0;
        }
        .planner-list-item .icon i {
            font-size: 0.9rem;
        }
        .planner-list-item .text {
            flex-grow: 1;
            font-weight: 500;
            font-size: 1rem;
        }
        .planner-list-item .counts {
            color: #9ca3af;
            font-size: 0.9rem;
        }
        .planner-actions {
            padding: 1rem 0.5rem 0;
            border-top: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .planner-add-project-btn {
            background: none;
            border: none;
            color: #ef4444;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            cursor: pointer;
        }
        .planner-add-project-btn i {
            font-size: 1.25rem;
        }
        .planner-actions .action-icons {
            display: flex;
            gap: 1.25rem;
            color: #9ca3af;
            font-size: 1.1rem;
        }
        .planner-actions .action-icons i {
            cursor: pointer;
        }

        /* New Planner Category View Styles */
        .planner-category-view {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: #0d1117;
        }
        .category-view-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #30363d;
            flex-shrink: 0;
        }
        .category-back-btn {
            margin-right: 1rem;
        }
        .category-view-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .category-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #30363d;
            flex-shrink: 0;
        }
        @media (min-width: 640px) {
            .category-stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .category-stat-card {
            text-align: center;
        }
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #ef4444; /* Red color from image */
        }
        .stat-label {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }
        .category-add-task-container {
            padding: 1rem;
            flex-shrink: 0;
        }
        .add-task-input-wrapper {
            display: flex;
            align-items: center;
            background-color: #161b22;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
        }
        .add-task-input-wrapper i {
            color: #9ca3af;
            margin-right: 0.75rem;
        }
        .category-add-task-input {
            background: transparent;
            border: none;
            outline: none;
            color: white;
            width: 100%;
            font-size: 1rem;
            padding: 0.5rem 0;
        }
        .category-task-list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 1rem 1rem;
        }
        .no-tasks-placeholder {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }
        .no-tasks-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .no-tasks-placeholder h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #d1d5db;
        }
        .category-task-item {
            display: flex;
            align-items: center;
            background-color: #161b22;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .task-checkbox-category {
            width: 24px;
            height: 24px;
            border: 2px solid #ef4444;
            border-radius: 50%;
            margin-right: 1rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .task-checkbox-category.completed {
            background-color: #ef4444;
            border-color: #ef4444;
        }
        .category-task-item.completed .task-title-category {
            text-decoration: line-through;
            color: #6b7280;
        }
        .task-title-category {
            flex-grow: 1;
            font-weight: 500;
        }
        .task-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: transparent;
            border: 2px solid #ef4444;
            color: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .task-play-btn:hover {
            background-color: #ef4444;
            color: white;
        }
        .completed-tasks-toggle {
            text-align: center;
            padding: 0.5rem;
            cursor: pointer;
            color: #9ca3af;
            font-size: 0.875rem;
        }


        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(13, 17, 23, 0.7); /* Darker backdrop */
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #0d1117;
            border: 1px solid transparent;
            border-image: linear-gradient(to bottom right, #14B8A6, #0EA5E9);
            border-image-slice: 1;
            box-shadow: 0 0 30px rgba(14, 165, 233, 0.1);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 1.3rem; font-weight: 600; }
        .close-modal {
            background: none;
            border: none;
            color: #9CA3AF;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Profile Settings */
        .profile-container { padding: 20px; }
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #30363d;
            margin-right: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            position: relative;
            overflow: hidden; /* To contain the image */
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-name { font-size: 1.3rem; font-weight: 600; }
        .profile-email { color: #9CA3AF; }
        .settings-item {
            padding: 15px 0;
            border-bottom: 1px solid #30363d;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .settings-item:hover {
            background-color: rgba(48, 54, 61, 0.3);
        }
        .settings-label { font-weight: 600; margin-bottom: 5px; }
        .settings-value { color: #9CA3AF; }
        
        /* Loading spinner */
        .fa-spinner { animation: spin 1s linear infinite; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive fixes */
        @media (max-width: 640px) {
            .group-card { margin-bottom: 1rem; }
            .group-stats { flex-direction: column; gap: 0.5rem; }
            .stat-item { display: flex; justify-content: space-between; align-items: center; }
            .create-group-btn { bottom: 70px; right: 15px; }
            #session-timer { font-size: 4rem; }
        }
        .subject-color-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(32px, 1fr)); /* Responsive grid */
            gap: 8px; /* Space between dots */
        }
        .subject-color-picker .color-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            outline: 2px solid transparent;
            transition: outline-color 0.2s, transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Subtle shadow */
        }
        .subject-color-picker .color-dot:hover {
            transform: scale(1.1); /* Pop effect on hover */
        }
        .subject-color-picker .color-dot.selected {
            outline-color: #3B82F6; /* Blue outline for selected */
            transform: scale(1.05); /* Slightly larger when selected */
        }
        .subject-item {
            cursor: grab; /* Indicate draggable */
            border: 2px solid #374151;
            position: relative; /* For options menu positioning */
            transition: all 0.2s ease; /* Smooth transitions for drag feedback */
        }
        .subject-item.selected {
            border-color: #3B82F6;
            background-color: #2563eb30;
        }
        .subject-item.dragging {
            opacity: 0.5;
            border: 2px dashed #3B82F6;
            background-color: #2563eb10;
        }
        .subject-item.drag-over {
            border: 2px solid #10B981; /* Green border for drag over target */
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .subject-options-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
            padding: 5px;
        }
        .subject-options-menu {
            display: none;
            position: absolute;
            right: 25px;
            top: 25px;
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 10;
            overflow: hidden; /* Ensure buttons don't spill */
        }
        .subject-options-menu.active {
            display: block;
        }
        .subject-options-menu button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }
        .subject-options-menu button:hover {
            background-color: #30363d;
        }
        .subject-options-menu .delete-btn:hover {
            background-color: #ef4444;
        }
        /* Group Detail Page */
        .member-list-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 0.75rem;
            width: 100%;
        }
        .member-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #4B5563;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            position: relative;
            flex-shrink: 0;
        }
        .member-avatar.studying {
            outline: 3px solid #10B981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
        }
        .member-status-icon {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 20px;
            height: 20px;
            background-color: #10B981;
            border-radius: 50%;
            border: 3px solid #1F2937;
        }
        .member-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .member-time {
            color: #9CA3AF;
            font-size: 0.9rem;
        }
        #group-detail-nav {
            display: none;
        }
        .chat-message {
            margin-bottom: 1rem;
            display: flex;
        }
        .chat-message.sent {
            justify-content: flex-end;
        }
        .chat-bubble {
            max-width: 75%;
            padding: 0.75rem;
            border-radius: 1rem;
        }
        .chat-bubble.sent {
            background-color: #3B82F6;
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-bubble.received {
            background-color: #21262d;
            color: white;
            border-bottom-left-radius: 0.25rem;
        }
        .chat-sender {
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-bottom: 0.25rem;
        }

        /* NEW STYLE for Studicon View */
        .studicon-member-card {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Attendance Page Styles */
        .attendance-container {
            padding: 16px;
        }
        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .attendance-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #21262d;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .attendance-nav-btn:hover {
            background: #30363d;
        }
        .attendance-title {
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
        }
        .calendar-header {
            text-align: center;
            padding: 8px;
            font-size: 0.8rem;
            color: #9CA3AF;
        }
        .calendar-day {
            aspect-ratio: 1/1;
            background: #161b22;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .calendar-day.empty {
            background: transparent;
        }
        .day-number {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .day-time {
            font-size: 0.7rem;
            color: #2dd4bf;
        }
        .calendar-day.today .day-number {
            color: #38bdf8;
            font-weight: 700;
        }
        .calendar-day.active {
            background-image: linear-gradient(to top, #2dd4bf, #38bdf8);
        }
        .calendar-day.active .day-number {
            color: white;
        }
        .calendar-day.active .day-time {
            color: white;
        }
        .attendance-stats {
            margin-top: 20px;
            padding: 16px;
            background: #161b22;
            border-radius: 12px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 12px;
        }
        .stat-box {
            background: #0d1117;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #9CA3AF;
        }
        .attendance-member-list {
            margin-top: 20px;
        }
        .member-row {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #161b22;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .member-avatar-sm {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4B5563;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .member-info {
            flex-grow: 1;
        }
        .member-name-sm {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .member-time-sm {
            font-size: 0.8rem;
            color: #9CA3AF;
        }
        .attendance-progress {
            height: 6px;
            background: #374151;
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: #3B82F6;
            border-radius: 3px;
        }
        
        /* Group Settings Modal */
        .group-settings-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .group-settings-item:hover {
            background-color: #30363d;
        }
        .group-settings-item i {
            width: 20px;
            margin-right: 12px;
            color: #9CA3AF;
        }
        
        /* Edit Group Info Modal Styles */
        #edit-group-info-modal .modal-content {
            max-width: 500px;
        }
        .edit-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: #21262d;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .edit-group-item:hover {
            background-color: #30363d;
        }
        .edit-group-item .value {
            color: #9CA3AF;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.info { background-image: linear-gradient(to right, #2dd4bf, #38bdf8); }
        .toast.success { background-color: #10B981; }
        .toast.error { background-color: #EF4444; }

        /* Confirmation Modal */
        #confirmation-modal .modal-content {
            text-align: center;
        }
        #confirmation-modal-message {
            margin-bottom: 20px;
            color: #D1D5DB;
        }
        #confirmation-modal-buttons {
            display: flex;
            gap: 10px;
        }
        #confirmation-modal-buttons button {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #confirm-btn { background-color: #EF4444; color: white; }
        #confirm-btn:hover { background-color: #DC2626; }
        #cancel-btn { background-color: #4B5563; color: white; }
        #cancel-btn:hover { background-color: #6B7280; }

        /* New Dashboard Styles */
        #insights-container {
            background-color: #0f172a; /* slate-900 */
            color: #f1f5f9; /* slate-100 */
        }
        .card {
            background-color: #1e293b; /* slate-800 */
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #334155; /* slate-700 */
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(45, 212, 191, 0.1);
        }
        .nav-btn {
            padding: 0.5rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        .nav-btn.active {
            background-color: #2dd4bf; /* Teal-400 */
            color: #0d1117;
            box-shadow: 0 0 15px rgba(45, 212, 191, 0.5);
        }
        .nav-btn:not(.active) {
            background-color: #334155; /* slate-700 */
            color: #cbd5e1; /* slate-300 */
        }
        .nav-btn:not(.active):hover {
            background-color: #475569; /* slate-600 */
        }
        .view {
            display: none;
        }
        .view.active {
            display: grid;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .session-log-item {
            position: relative;
        }
        .log-options-menu {
            display: none;
            position: absolute;
            right: 1rem;
            top: 2.5rem;
            background-color: #334155;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 20;
            overflow: hidden;
        }
        .log-options-menu.active {
            display: block;
        }
        .log-options-menu button {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem;
            text-align: left;
            color: #f1f5f9;
        }
        .log-options-menu button:hover {
            background-color: #475569;
        }
        #pull-to-refresh {
            text-align: center;
            padding: 10px;
            color: #94a3b8;
            transition: height 0.3s ease;
            overflow: hidden;
            height: 0;
        }

        /* New Group Study Button */
        #group-study-timer-btn {
            background-color: #1f2937;
            color: #9ca3af;
            font-weight: 600;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: fit-content;
            margin: 1rem auto 0; /* Center it below the switch */
            padding: 0.5rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #group-study-timer-btn:hover {
            background-image: linear-gradient(to right, #2dd4bf, #38bdf8);
            color: white;
            box-shadow: 0 2px 8px rgba(56, 189, 248, 0.3);
        }

        /* Group Detail Header Dropdown */
        .group-detail-header-dropdown {
            position: relative;
            display: inline-block;
        }

        .group-detail-header-dropdown select {
            background-color: #161b22;
            color: white;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1rem;
            font-weight: 600;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 30px; /* Space for arrow */
            cursor: pointer;
            outline: none;
        }

        .group-detail-header-dropdown::after {
            content: 'â–¼';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
            pointer-events: none;
        }

        /* Avatar Selection Styles */
        .avatar-picker {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .avatar-option {
            position: relative;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .avatar-option.selected {
            border-color: #2dd4bf; /* Teal-400 */
            transform: scale(1.1);
        }
        .avatar-upload-label {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: rgba(0,0,0,0.6);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen antialiased">

    <input type="file" id="image-upload-input" class="hidden" accept="image/*">
    <input type="file" id="profile-picture-upload" class="hidden" accept="image/*">

    <div id="auth-screen" class="active flex-col items-center justify-center h-full p-4 fade-in">
        <div class="w-full max-w-sm text-center">
             <div class="flex items-center justify-center mb-6">
                 <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                     <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z" fill="url(#paint0_linear_logo)"></path>
                     <path d="M9 8H15V10H11V12H14V14H11V16H9V8Z" fill="white"></path>
                     <defs>
                         <linearGradient id="paint0_linear_logo" x1="2" y1="12" x2="22" y2="12" gradientUnits="userSpaceOnUse">
                             <stop stop-color="#14B8A6"></stop>
                             <stop offset="1" stop-color="#0EA5E9"></stop>
                         </linearGradient>
                     </defs>
                 </svg>
                 <span class="text-4xl font-bold ml-3 bg-clip-text text-transparent bg-gradient-to-r from-teal-400 to-sky-400">FocusFlow</span>
             </div>
             <p class="text-gray-400 mb-8">Your Ultimate Study Companion</p>
             <div id="auth-form-container" class="bg-gray-800 p-8 rounded-2xl shadow-lg">
                 <form id="login-form" class="space-y-4">
                     <h2 class="text-2xl font-bold text-white mb-4">Login</h2>
                     <input type="email" id="login-email" placeholder="Email" class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400" required>
                     <input type="password" id="login-password" placeholder="Password" class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400" required>
                     <button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">Sign In</button>
                 </form>
                 <form id="signup-form" class="hidden space-y-4">
                     <h2 class="text-2xl font-bold text-white mb-4">Create Account</h2>
                     <input type="email" id="signup-email" placeholder="Email" class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400" required>
                     <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400" required minlength="6">
                     <button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">Sign Up</button>
                 </form>
                 <p id="auth-error" class="text-red-400 text-sm mt-4 h-5"></p>
                 <div class="flex items-center my-6">
                     <hr class="flex-grow border-gray-600">
                     <span class="mx-4 text-gray-500">OR</span>
                     <hr class="flex-grow border-gray-600">
                 </div>
                 <button id="google-signin-btn" class="w-full bg-white text-gray-800 font-semibold py-3 rounded-lg flex items-center justify-center transition hover:bg-gray-200">
                     <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48">
                         <path fill="#4285F4" d="M43.611 20.083H24v8.838h11.002c-0.463 2.878-2.18 5.424-4.852 7.199l7.217 5.626C43.02 37.21 46 29.54 46 20.083z"/>
                         <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.897-5.781l-7.217-5.626c-2.13 1.442-4.852 2.308-7.68 2.308-5.878 0-10.845-3.965-12.624-9.26l-7.42 5.781C6.383 39.04 14.46 48 24 48z"/>
                         <path fill="#FBBC05" d="M11.376 28.71c-0.565-1.71-0.565-3.526 0-5.236l-7.42-5.781C1.678 21.24 0 26.52 0 32.14c0 5.62 1.678 10.9 4.053 14.18l7.323-5.61z"/>
                         <path fill="#EA4335" d="M24 10.73c3.52 0 6.565 1.218 9.015 3.655l6.345-6.345C35.93 2.13 30.48 0 24 0 14.46 0 6.383 8.96 2.053 17.71l7.42 5.781c1.779-5.295 6.746-9.26 12.624-9.26z"/>
                     </svg>
                     Sign in with Google
                 </button>
                 
                 <button id="anonymous-signin-btn" class="w-full mt-4 bg-gray-600 text-white font-semibold py-3 rounded-lg flex items-center justify-center transition hover:bg-gray-500">
                    <i class="fas fa-user-secret mr-3"></i>
                    Continue as Guest
                 </button>
                 <p class="mt-8 text-sm text-gray-400">
                     <span id="login-toggle-text">Don't have an account?</span>
                     <button id="auth-toggle-btn" class="font-semibold text-blue-400 hover:text-blue-300">Sign Up</button>
                 </p>
             </div>
        </div>
    </div>

    <div id="page-username-setup" class="page flex-col items-center justify-center h-full p-4 fade-in">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-white mb-2">Welcome to FocusFlow!</h1>
            <p class="text-gray-400 mb-8">Let's set up your profile.</p>
            <div class="bg-gray-800 p-8 rounded-2xl shadow-lg">
                <form id="username-setup-form" class="space-y-4">
                    <div class="avatar-picker" id="username-avatar-picker">
                        </div>
                    <input type="text" id="username-input" placeholder="Enter your username" class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400" required minlength="3">
                    <p id="username-error" class="text-red-400 text-sm h-5"></p>
                    <button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">Save Profile</button>
                </form>
            </div>
        </div>
    </div>

    <div id="app-container" class="flex-col h-screen">
        <main id="main" class="flex-grow overflow-y-auto no-scrollbar">
            <div id="page-timer" class="page active flex-col h-full">
                <header class="p-4 md:p-6 flex items-center justify-between z-20">
                     <div class="flex items-center">
                         <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                             <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z" fill="url(#paint0_linear_logo_header)"></path>
                             <path d="M9 8H15V10H11V12H14V14H11V16H9V8Z" fill="white"></path>
                             <defs>
                                 <linearGradient id="paint0_linear_logo_header" x1="2" y1="12" x2="22" y2="12" gradientUnits="userSpaceOnUse">
                                     <stop stop-color="#14B8A6"></stop>
                                     <stop offset="1" stop-color="#0EA5E9"></stop>
                                 </linearGradient>
                             </defs>
                         </svg>
                         <span class="text-2xl font-bold ml-2 bg-clip-text text-transparent bg-gradient-to-r from-teal-400 to-sky-400">FocusFlow</span>
                     </div>
                     <div class="flex items-center space-x-4">
                         <button id="groups-btn" class="w-10 h-10 rounded-full bg-sky-900/50 border border-sky-800 flex items-center justify-center text-gray-400 hover:bg-sky-800/60 transition">
                             <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                 <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                             </svg>
                         </button>
                         <button id="profile-btn" class="w-10 h-10 rounded-full bg-sky-900/50 border border-sky-800 flex items-center justify-center text-gray-400 hover:bg-sky-800/60 transition overflow-hidden">
                             <div id="header-avatar" class="w-full h-full flex items-center justify-center bg-blue-500 text-white font-bold">U</div>
                         </button>
                     </div>
                </header>
                <div class="relative flex-grow flex items-center justify-center -mt-16">
                    <div class="relative text-center z-10 bg-gray-900/50 backdrop-blur-sm p-4 sm:p-8 rounded-full">
                        <div class="timer-switch-container mx-auto mb-4">
                            <button id="normal-timer-btn" class="timer-switch-btn active">Normal</button>
                            <button id="pomodoro-timer-btn" class="timer-switch-btn">Pomodoro</button>
                        </div>
                        <button id="group-study-timer-btn" class="text-sm">
                            <i class="fas fa-users-line"></i> Group Study
                        </button>
                        <p id="active-subject-display" class="text-xl font-semibold text-blue-400 h-7 mb-2"></p>
                        <p id="pomodoro-status"></p>
                        <h2 id="session-timer" class="text-7xl md:text-8xl timer-text text-white">00:00:00</h2>
                        <p id="total-time-display" class="text-gray-400 mt-2">Total Today: 00:00:00</p>
                        <p id="total-break-time-display" class="text-gray-400 mt-1">Total Break: 00:00:00</p>
                        <div id="timer-controls" class="mt-8">
                            <button id="start-studying-btn" class="bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-4 px-8 rounded-full text-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">Start Studying</button>
                            <button id="stop-studying-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-10 rounded-full text-lg transition-transform transform hover:scale-105">Stop</button>
                            <button id="manual-start-btn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-full text-lg transition-transform transform hover:scale-105">Start Next</button>
                            <button id="pause-btn" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-10 rounded-full text-lg transition-transform transform hover:scale-105">Pause</button>
                            <button id="resume-btn" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-full text-lg transition-transform transform hover:scale-105">Resume</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-stats" class="page flex-col h-full overflow-y-auto no-scrollbar">
                <header class="p-4 md:p-6 flex items-center justify-between z-20 border-b border-gray-800 sticky top-0 bg-gray-900">
                    <button class="back-button text-gray-400 hover:text-white" data-target="timer">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-100">Stats & Insights</h1>
                    <div class="w-6"></div> 
                </header>
                <div id="insights-container" class="p-4 md:p-6 bg-[#0d1117]">
                    </div>
            </div>
            
            <div id="page-ranking" class="page flex-col h-full overflow-y-auto no-scrollbar">
                <header class="p-4 md:p-6 flex items-center justify-between z-20 border-b border-gray-800 sticky top-0 bg-gray-900">
                    <button class="back-button text-gray-400 hover:text-white" data-target="timer">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-100">Leaderboard</h1>
                    <div class="w-6"></div> </header>
                <div class="px-4 pt-4">
                    <div class="flex space-x-1" id="ranking-period-tabs">
                        <button class="ranking-tab-btn flex-1 py-2 px-4 rounded-t-lg font-semibold text-sm" data-period="daily">Daily</button>
                        <button class="ranking-tab-btn flex-1 py-2 px-4 rounded-t-lg font-semibold text-sm active" data-period="weekly">Last 7 Days</button>
                        <button class="ranking-tab-btn flex-1 py-2 px-4 rounded-t-lg font-semibold text-sm" data-period="monthly">Last 30 Days</button>
                    </div>
                </div>
                <div id="ranking-list" class="ranking-list">
                                    </div>
            </div>
            
            <div id="page-planner" class="page flex-col h-full overflow-y-auto no-scrollbar">
                <header class="p-4 md:p-6 flex items-center justify-between z-20 border-b border-gray-800 sticky top-0 bg-gray-900">
                    <button class="back-button text-gray-400 hover:text-white" data-target="timer">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                     <div class="flex items-center gap-2">
                         <button id="planner-menu-toggle" class="p-2 rounded-full hover:bg-gray-700 md:hidden"><i class="fas fa-bars"></i></button>
                         <h1 id="planner-header-title" class="text-xl font-bold text-gray-100">Planner</h1>
                     </div>
                    <div id="planner-view-controls" class="flex items-center bg-gray-700 rounded-md p-1">
                         <button data-view="list" class="planner-view-btn p-1 px-2 rounded text-sm"><i class="fas fa-list mr-1"></i>List</button>
                         <button data-view="board" class="planner-view-btn p-1 px-2 rounded text-sm"><i class="fas fa-grip-horizontal mr-1"></i>Board</button>
                         <button data-view="calendar" class="planner-view-btn p-1 px-2 rounded text-sm"><i class="fas fa-calendar-alt mr-1"></i>Calendar</button>
                    </div>
                </header>
                <div class="planner-main-layout">
                    <aside id="planner-sidebar"></aside>
                    <main id="planner-main-content">
                        </main>
                    <aside id="planner-task-details" class="hidden">
                        </aside>
                </div>
            </div>

            <div id="page-profile" class="page flex-col h-full overflow-y-auto no-scrollbar">
                <header class="p-4 md:p-6 flex items-center justify-between z-20 border-b border-gray-800 sticky top-0 bg-gray-900">
                    <button class="back-button text-gray-400 hover:text-white" data-target="timer">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-100">Profile & Settings</h1>
                    <div class="w-6"></div> 
                </header>
                <div class="profile-container">
                    <div id="profile-authenticated-view">
                        <div class="profile-header">
                            <div id="profile-page-avatar" class="profile-avatar bg-blue-500">
                                 </div>
                            <div>
                                <div id="profile-page-name" class="profile-name">User Name</div>
                                <div id="profile-page-email" class="profile-email">user@example.com</div>
                            </div>
                        </div>
                        <div class="card text-center p-4 bg-yellow-500/10 border-yellow-500/30 mb-6 rounded-lg">
                            <h3 class="font-bold text-lg text-yellow-400">Current Streak</h3>
                            <p class="text-4xl font-black text-white" id="profile-streak-display">0 days</p>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">Achievements</h3>
                            <div id="achievements-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-4 text-center">
                                </div>
                        </div>
                        <div id="settings-account" class="settings-item"><div class="settings-label">Account</div><div class="settings-value">Edit profile information</div></div>
                        <div id="settings-pomodoro" class="settings-item"><div class="settings-label">Pomodoro Timer</div><div class="settings-value">Customize durations & sounds</div></div>
                        <div id="settings-study-goal" class="settings-item"><div class="settings-label">Study Goals</div><div id="study-goal-value" class="settings-value">Not set</div></div>
                        <div id="sign-out-btn" class="mt-6 text-center text-red-400 font-semibold cursor-pointer py-3 bg-red-500/10 rounded-lg hover:bg-red-500/20">Sign Out</div>
                    </div>
                    
                    <div id="profile-anonymous-view" class="hidden text-center p-8">
                        <i class="fas fa-user-secret text-6xl text-gray-500 mb-4"></i>
                        <h2 class="text-2xl font-bold mb-2">You are using FocusFlow as a guest.</h2>
                        <p class="text-gray-400 mb-6">Create an account to save your progress, join groups, and access all features.</p>
                        <button id="go-to-auth-btn" class="w-full max-w-xs mx-auto bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">
                            Sign Up / Log In
                        </button>
                    </div>

                    </div>
            </div>

            <div id="page-my-groups" class="page flex-col h-full overflow-y-auto no-scrollbar">
                <header class="p-4 md:p-6 flex items-center justify-between z-20 border-b border-gray-800 sticky top-0 bg-gray-900">
                    <button class="back-button text-gray-400 hover:text-white" data-target="timer">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-100">My Groups</h1>
                    <button id="go-to-find-groups-btn" class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-700 hover:bg-gray-600">
                        <i class="fas fa-search"></i>
                    </button>
                </header>
                <div id="my-groups-list" class="p-4"></div>
            </div>
            
            <div id="page-find-groups" class="page flex-col h-full overflow-y-auto no-scrollbar">
                <header class="p-4 md:p-6 flex items-center justify-between z-20 border-b border-gray-800 sticky top-0 bg-gray-900">
                    <button class="back-button text-gray-400 hover:text-white" data-target="my-groups">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-100">Group Rankings</h1>
                    <div class="w-10"></div>
                </header>
                <div class="p-4 border-b border-gray-800 sticky top-[73px] bg-gray-900 z-10">
                    <div class="flex space-x-1 bg-gray-800 p-1 rounded-lg mb-4" id="group-ranking-sort-tabs">
                        <button class="group-filter-btn flex-1" data-sort="new">New</button>
                        <button class="group-filter-btn flex-1" data-sort="attendance">Attendance</button>
                        <button class="group-filter-btn flex-1 active" data-sort="studytime">Studytime</button>
                    </div>
                    <div class="flex items-center justify-center space-x-6 text-sm" id="group-ranking-filters">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" data-filter="univ" class="w-4 h-4 bg-gray-700 rounded text-blue-500 focus:ring-blue-500 border-gray-600">
                            <span>Univ</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" data-filter="available" class="w-4 h-4 bg-gray-700 rounded text-blue-500 focus:ring-blue-500 border-gray-600">
                            <span>Available</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" data-filter="public" class="w-4 h-4 bg-gray-700 rounded text-blue-500 focus:ring-blue-500 border-gray-600">
                            <span>Public</span>
                        </label>
                    </div>
                </div>
                <div id="all-groups-list" class="p-4"></div>
                <button id="go-to-create-group-btn" class="create-group-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div id="page-create-group" class="page flex-col h-full overflow-y-auto no-scrollbar">
                <header class="p-4 md:p-6 flex items-center justify-between z-20 border-b border-gray-800 sticky top-0 bg-gray-900">
                    <button class="back-button text-gray-400 hover:text-white" data-target="find-groups">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-100">Create New Group</h1>
                    <button id="create-group-done-btn" class="px-4 py-2 bg-gradient-to-r from-teal-500 to-sky-500 rounded-lg font-semibold text-white transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">Done</button>
                </header>
                <div class="p-4 md:p-6">
                    <form id="create-group-form" class="space-y-6">
                        <div><label class="block mb-2 font-semibold">Group Name</label><input id="group-name-input" type="text" class="w-full bg-gray-700 rounded-lg p-3" placeholder="e.g., University Calculus" required></div>
                        <div><label class="block mb-2 font-semibold">Password (optional)</label><input id="group-password-input" type="text" class="w-full bg-gray-700 rounded-lg p-3" placeholder="Leave blank for public group"></div>
                        <div><label class="block mb-2 font-semibold">Category</label><div class="grid grid-cols-2 gap-2"><div class="category-option selected">General study</div><div class="category-option">Language study</div><div class="category-option">Secondary School</div><div class="category-option">University</div></div></div>
                        <div><label class="block mb-2 font-semibold">Time Goal</label><div class="grid grid-cols-3 gap-2"><div class="time-option selected">1</div><div class="time-option">2</div><div class="time-option">3</div><div class="time-option">4</div><div class="time-option">5</div><div class="time-option">6</div></div></div>
                        <div><label class="block mb-2 font-semibold">Capacity</label><div class="flex items-center justify-center bg-gray-700 rounded-lg p-3"><button type="button" id="decrease-capacity" class="px-4 text-xl">-</button><div id="capacity-value" class="flex-grow text-center font-bold text-lg">15</div><button type="button" id="increase-capacity" class="px-4 text-xl">+</button></div></div>
                        <div><label class="block mb-2 font-semibold">Description</label><textarea id="group-description-input" class="w-full bg-gray-700 rounded-lg p-3 h-24" placeholder="Describe your group's purpose" required></textarea></div>
                    </form>
                </div>
            </div>
            
            <div id="page-group-detail" class="page flex-col h-full overflow-y-auto no-scrollbar">
                <header class="p-4 md:p-6 flex items-center z-20 border-b border-gray-800 sticky top-0 bg-gray-900">
                    <button class="back-button text-gray-400 hover:text-white" data-target="my-groups">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div id="group-selector-container" class="group-detail-header-dropdown">
                         <select id="group-selector"></select>
                    </div>
                    
                    <button id="group-rules-header-btn" class="ml-2 text-gray-400 hover:text-white p-2 rounded-full flex items-center justify-center hover:bg-gray-700 transition" title="Group Rules">
                        <i class="fas fa-gavel"></i>
                    </button>

                    <div class="ml-auto flex items-center gap-2">
                        <div id="ranking-scope-switch" class="hidden timer-switch-container bg-gray-800 p-1">
                            <button id="group-ranking-scope-btn" class="timer-switch-btn text-xs px-3 py-1 active">Group</button>
                            <button id="global-ranking-scope-btn" class="timer-switch-btn text-xs px-3 py-1">Global</button>
                        </div>

                        <div id="group-desktop-controls" class="hidden">
                            <div class="hidden md:flex items-center gap-2">
                                <div id="group-view-switch" class="timer-switch-container bg-gray-800 p-1">
                                    <button id="realtime-view-btn" data-view-target="realtime" class="timer-switch-btn text-xs px-3 py-1 active">Realtime</button>
                                    <button id="studicon-view-btn" data-view-target="studicon" class="timer-switch-btn text-xs px-3 py-1">Studicon</button>
                                </div>
                                <button id="studicon-store-btn" class="text-gray-400 hover:text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700">
                                    <i class="fas fa-store"></i>
                                </button>
                                <div id="group-settings-btn-container" class="w-10 h-10"></div>
                            </div>
                        </div>
                    </div>
                </header>
                <div id="group-mobile-controls" class="md:hidden sticky top-[73px] bg-gray-900 z-10 border-b border-gray-800 p-2 flex items-center justify-between hidden">
                    <div id="group-view-switch-mobile" class="timer-switch-container bg-gray-800 p-1 m-0">
                        <button id="realtime-view-btn-mobile" data-view-target="realtime" class="timer-switch-btn text-xs px-3 py-1 active">Realtime</button>
                        <button id="studicon-view-btn-mobile" data-view-target="studicon" class="timer-switch-btn text-xs px-3 py-1">Studicon</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="studicon-store-btn-mobile" class="text-gray-400 hover:text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700">
                            <i class="fas fa-store"></i>
                        </button>
                        <div id="group-settings-btn-container-mobile" class="w-10 h-10">
                        </div>
                    </div>
                </div>
                <div id="group-detail-content" class="flex-grow overflow-y-auto no-scrollbar">
                </div>
                <nav id="group-detail-nav" class="bg-gray-800 border-t border-gray-700 grid grid-cols-5 sticky bottom-0">
                    <button class="group-nav-item p-3 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-700 transition-colors active" data-subpage="home">
                        <i class="fas fa-home"></i>
                        <p class="text-xs mt-1">Home</p>
                    </button>
                    <button class="group-nav-item p-3 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-700 transition-colors" data-subpage="attendance">
                        <i class="fas fa-calendar-check"></i>
                        <p class="text-xs mt-1">Attendance</p>
                    </button>
                    <button class="group-nav-item p-3 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-700 transition-colors" data-subpage="rankings">
                        <i class="fas fa-chart-bar"></i>
                        <p class="text-xs mt-1">Rankings</p>
                    </button>
                    <button class="group-nav-item p-3 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-700 transition-colors" data-subpage="invite">
                        <i class="fas fa-user-plus"></i>
                        <p class="text-xs mt-1">Invite</p>
                    </button>
                    <button class="group-nav-item p-3 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-700 transition-colors" data-subpage="chat">
                        <i class="fas fa-comments"></i>
                        <p class="text-xs mt-1">Chat</p>
                    </button>
                </nav>
            </div>
        </main>
        <nav id="main-nav" class="bg-gray-800 border-t border-gray-700 grid grid-cols-5 sticky bottom-0">
            <button class="nav-item p-3 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-700 transition-colors active" data-page="timer"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-xs mt-1">Timer</p></button>
            <button class="nav-item p-3 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-700 transition-colors" data-page="stats"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><p class="text-xs mt-1">Stats</p></button>
            <button class="nav-item p-3 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-700 transition-colors" data-page="ranking"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg><p class="text-xs mt-1">Ranking</p></button>
            <button class="nav-item p-3 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-700 transition-colors" data-page="planner"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg><p class="text-xs mt-1">Planner</p></button>
            <button id="add-subject-btn" class="p-3 flex flex-col items-center justify-center text-sky-400 hover:bg-gray-700 transition-colors"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-xs mt-1">Add Subject</p></button>
        </nav>
    </div>

    <div id="toast-container"></div>
    <div id="add-subject-modal" class="modal"><div class="modal-content"><div class="modal-header"><div id="add-subject-modal-title" class="modal-title">Add New Subject</div><button class="close-modal">&times;</button></div><form id="add-subject-form"><input type="hidden" id="edit-subject-id"><div class="mb-4"><label for="add-subject-name" class="block text-gray-300 mb-2">Subject Name</label><input type="text" id="add-subject-name" class="w-full bg-gray-700 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400" required></div><div class="mb-4"><label class="block text-gray-300 mb-2">Color</label><div class="subject-color-picker"><div class="color-dot bg-red-500" data-color="bg-red-500"></div><div class="color-dot bg-blue-500 selected" data-color="bg-blue-500"></div><div class="color-dot bg-green-500" data-color="bg-green-500"></div><div class="color-dot bg-yellow-500" data-color="bg-yellow-500"></div><div class="color-dot bg-purple-500" data-color="bg-purple-500"></div><div class="color-dot bg-pink-500" data-color="bg-pink-500"></div><div class="color-dot bg-indigo-500" data-color="bg-indigo-500"></div><div class="color-dot bg-teal-500" data-color="bg-teal-500"></div><div class="color-dot bg-orange-500" data-color="bg-orange-500"></div><div class="color-dot bg-cyan-500" data-color="bg-cyan-500"></div><div class="color-dot bg-lime-500" data-color="bg-lime-500"></div><div class="color-dot bg-fuchsia-500" data-color="bg-fuchsia-500"></div><div class="color-dot bg-rose-500" data-color="bg-rose-500"></div><div class="color-dot bg-sky-500" data-color="bg-sky-500"></div><div class="color-dot bg-emerald-500" data-color="bg-emerald-500"></div><div class="color-dot bg-amber-500" data-color="bg-amber-500"></div><div class="color-dot bg-violet-500" data-color="bg-violet-500"></div></div></div><button type="submit" id="add-subject-submit-btn" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">Add Subject</button></form></div></div>
    <div id="start-session-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Start New Session</div><button id="close-start-session-modal" class="close-modal">&times;</button></div><form id="start-session-form"><div id="subject-selection-list" class="mb-4 max-h-60 overflow-y-auto space-y-2"></div><div class="flex items-center gap-4 mt-4"><button type="button" id="open-add-subject-modal-from-start" class="w-full text-center py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-medium transition">Add New Subject</button><button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">Start Timer</button></div></form></div></div>
    <div id="add-task-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Add New Task</div><button class="close-modal">&times;</button></div><form id="add-task-form"><div class="mb-4"><label for="add-task-name" class="block text-gray-300 mb-2">Task Description</label><input type="text" id="add-task-name" class="w-full bg-gray-700 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400" required></div><div class="mb-4"><label for="add-task-date" class="block text-gray-300 mb-2">Date</label><input type="date" id="add-task-date" class="w-full bg-gray-700 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400" required></div><button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">Add Task</button></form></div></div>
    <div id="password-prompt-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Enter Group Password</div><button class="close-modal">&times;</button></div><form id="password-prompt-form"><input type="password" id="group-password-prompt-input" class="w-full bg-gray-700 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400" required><div class="flex gap-2 mt-4"><button type="button" class="close-modal w-full py-2 bg-gray-600 rounded-lg">Cancel</button><button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-2 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">Submit</button></div></form></div></div>
    <div id="confirmation-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="confirmation-modal-title" class="modal-title">Are you sure?</h2><button class="close-modal">&times;</button></div><p id="confirmation-modal-message">This action cannot be undone.</p><div id="confirmation-modal-buttons"><button id="cancel-btn">Cancel</button><button id="confirm-btn">Confirm</button></div></div></div>
    
    <div id="study-goal-modal" class="modal">
        <div class="modal-content"><div class="modal-header"><div class="modal-title">Set Study Goal</div><button class="close-modal">&times;</button></div><form id="study-goal-form"><div class="mb-4"><label for="study-goal-input" class="block text-gray-300 mb-2">Daily Study Goal (hours)</label><input type="number" id="study-goal-input" class="w-full bg-gray-700 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400" required min="1" max="24"></div><button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105">Set Goal</button></form></div></div>

    <div id="pomodoro-settings-modal" class="modal"><div class="modal-content no-scrollbar"><div class="modal-header"><div class="modal-title">Pomodoro Settings</div><button class="close-modal">&times;</button></div><form id="pomodoro-settings-form" class="space-y-4"><div class="grid grid-cols-1 gap-4"><div><label for="pomodoro-work-duration" class="block text-sm font-medium text-gray-300">Focus Duration (minutes)</label><input type="number" id="pomodoro-work-duration" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 mt-1 text-white" min="1" required></div><div><label for="pomodoro-short-break-duration" class="block text-sm font-medium text-gray-300">Short Break (minutes)</label><input type="number" id="pomodoro-short-break-duration" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 mt-1 text-white" min="1" required></div><div><label for="pomodoro-long-break-duration" class="block text-sm font-medium text-gray-300">Long Break (minutes)</label><input type="number" id="pomodoro-long-break-duration" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 mt-1 text-white" min="1" required></div><div><label for="pomodoro-long-break-interval" class="block text-sm font-medium text-gray-300">Long Break Interval (sessions)</label><input type="number" id="pomodoro-long-break-interval" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 mt-1 text-white" min="2" required></div></div><hr class="border-gray-600 my-2"><h3 class="text-lg font-semibold text-gray-200">Alarms</h3><div class="grid grid-cols-1 gap-4"><div><label for="pomodoro-volume" class="block text-sm font-medium text-gray-300">Volume</label><input type="range" id="pomodoro-volume" min="0" max="1" step="0.1" class="w-full mt-1"></div><div><label for="pomodoro-start-sound" class="block text-sm font-medium text-gray-300">Starting Bell</label><select id="pomodoro-start-sound" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 mt-1 text-white"></select></div><div><label for="pomodoro-focus-sound" class="block text-sm font-medium text-gray-300">Focus Alarm (End of Break)</label><select id="pomodoro-focus-sound" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 mt-1 text-white"></select></div><div><label for="pomodoro-break-sound" class="block text-sm font-medium text-gray-300">Break Alarm (End of Focus)</label><select id="pomodoro-break-sound" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 mt-1 text-white"></select></div></div><hr class="border-gray-600 my-2"><h3 class="text-lg font-semibold text-gray-200">Automation</h3><div class="space-y-3"> <div class="flex items-center justify-between"><span class="text-sm font-medium text-gray-300">Auto-start next focus session?</span><label class="toggle-switch"><input type="checkbox" id="pomodoro-auto-start-focus"><span class="slider"></span></label></div><div class="flex items-center justify-between"><span class="text-sm font-medium text-gray-300">Auto-start next break?</span><label class="toggle-switch"><input type="checkbox" id="pomodoro-auto-start-break"><span class="slider"></span></label></div></div><button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-sky-500/40 hover:scale-105 mt-4">Save Settings</button></form></div></div>

    <!-- START: Added Missing Modals -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Profile</div><button class="close-modal">&times;</button>
            </div>
            <form id="edit-profile-form">
                <div class="mb-4">
                    <label for="edit-username-input" class="block text-gray-300 mb-2">Username</label>
                    <input type="text" id="edit-username-input" class="w-full bg-gray-700 rounded-lg p-3 text-white" required minlength="3">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg">Save Profile</button>
            </form>
        </div>
    </div>
    <div id="group-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Group Settings</div><button class="close-modal">&times;</button></div><div class="space-y-2"><div class="group-settings-item" data-action="edit-info"><i class="fas fa-edit"></i><span>Edit Group Info</span></div><div class="group-settings-item" data-action="group-rules"><i class="fas fa-gavel"></i><span>Group Rules</span></div><div class="group-settings-item" data-action="wake-up-group"><i class="fas fa-bullhorn"></i><span>Wake Up Group</span></div><div class="group-settings-item" data-action="kick-member"><i class="fas fa-user-minus"></i><span>Kick Member</span></div><div class="group-settings-item" data-action="promote-member"><i class="fas fa-crown"></i><span>Promote Member</span></div><div class="group-settings-item" data-action="member-logs"><i class="fas fa-history"></i><span>Member Logs</span></div><div class="group-settings-item text-red-400" data-action="leave-group"><i class="fas fa-sign-out-alt"></i><span>Leave Group</span></div></div></div></div>
    <div id="studicon-store-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Choose Your Studicon</div><button class="close-modal">&times;</button></div><div><div id="studicon-category-tabs" class="flex space-x-1 border-b border-gray-700 mb-4"></div><div id="studicon-picker" class="avatar-picker max-h-60 overflow-y-auto"></div><button id="save-studicon-btn" class="w-full mt-4 bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg">Save</button></div></div></div>
    <div id="edit-group-info-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Edit Group Information</div><button class="close-modal">&times;</button></div><form id="edit-group-info-form" class="space-y-4"><input type="hidden" id="edit-group-id-input"><div><label class="block text-sm font-medium text-gray-300">Group Name</label><input id="edit-group-name" type="text" class="w-full bg-gray-700 rounded-lg p-2 mt-1" required></div><div><label class="block text-sm font-medium text-gray-300">Description</label><textarea id="edit-group-description" class="w-full bg-gray-700 rounded-lg p-2 mt-1 h-24" required></textarea></div><div><label class="block text-sm font-medium text-gray-300">Category</label><select id="edit-group-category" class="w-full bg-gray-700 rounded-lg p-2 mt-1"><option>General study</option><option>Language study</option><option>Secondary School</option><option>University</option></select></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-300">Time Goal (h)</label><input id="edit-group-goal" type="number" min="1" max="10" class="w-full bg-gray-700 rounded-lg p-2 mt-1"></div><div><label class="block text-sm font-medium text-gray-300">Capacity</label><input id="edit-group-capacity" type="number" min="2" max="100" class="w-full bg-gray-700 rounded-lg p-2 mt-1"></div></div><div><label class="block text-sm font-medium text-gray-300">Password (optional)</label><input id="edit-group-password" type="text" class="w-full bg-gray-700 rounded-lg p-2 mt-1" placeholder="Leave blank for public"></div><button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg">Save Changes</button></form></div></div>
    <div id="group-rules-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Group Rules</div><div id="group-rules-controls"></div><button class="close-modal">&times;</button></div><div id="group-rules-display" class="text-gray-300 whitespace-pre-wrap"></div><div id="group-rules-edit-container" class="hidden"><textarea id="group-rules-textarea" class="w-full bg-gray-700 rounded-lg p-3 h-48"></textarea><button id="save-group-rules-btn" class="w-full mt-2 bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-2 rounded-lg">Save Rules</button></div></div></div>
    <div id="image-view-modal" class="modal"><div class="modal-content p-1 bg-transparent"><img id="fullscreen-image" src="" class="max-w-full max-h-[90vh]"><button class="close-modal absolute top-2 right-2 text-white bg-black/50 rounded-full w-8 h-8">&times;</button></div></div>
    <div id="user-profile-modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">User Profile</div><button class="close-modal">&times;</button></div><div id="user-profile-loading"><i class="fas fa-spinner fa-spin fa-2x"></i></div><div id="user-profile-details" class="hidden"><div class="flex items-center mb-4"><div id="user-profile-avatar" class="profile-avatar bg-blue-500 mr-4"></div><div><div id="user-profile-name" class="profile-name"></div></div></div><div class="space-y-2 text-sm"><div class="flex justify-between"><span>Total Today:</span><span id="user-profile-total-today" class="font-semibold"></span></div><div class="flex justify-between"><span>Total Overall:</span><span id="user-profile-total-overall" class="font-semibold"></span></div><div class="flex justify-between"><span>Last Active:</span><span id="user-profile-last-active" class="font-semibold"></span></div></div></div></div></div>
    <div id="quick-add-task-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Add Task for <span id="quick-add-task-date"></span></h2><button class="close-modal">&times;</button></div><form id="quick-add-task-form"><input type="hidden" id="quick-add-task-date-input"><input id="quick-add-task-title-input" type="text" class="w-full bg-gray-700 rounded-lg p-3 text-white" placeholder="e.g., Review chapter 5" required><button type="submit" class="w-full mt-3 bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-2 rounded-lg">Add Task</button></form></div></div>
    <div id="edit-session-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Edit Session</h2><button class="close-modal">&times;</button></div><form id="edit-session-form"><input type="hidden" id="edit-session-id"><input type="hidden" id="edit-session-old-duration"><input type="hidden" id="edit-session-ended-at"><div class="mb-4"><label for="edit-session-duration" class="block text-gray-300 mb-2">Duration (minutes)</label><input type="number" id="edit-session-duration" class="w-full bg-gray-700 rounded-lg p-3" min="1" required></div><button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg">Save Changes</button></form></div></div>
    <div id="avatar-character-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Choose Character</h2><button class="close-modal">&times;</button></div><div id="avatar-character-picker" class="avatar-picker max-h-60 overflow-y-auto"></div><button id="save-character-avatar-btn" class="w-full mt-4 bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg">Save Character</button></div></div>
    <div id="project-select-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Move to Project</h2><button class="close-modal">&times;</button></div><div id="project-select-list" class="space-y-1 max-h-60 overflow-y-auto"></div></div></div>
    <div id="repeat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Repeat Settings</h2><button class="close-modal">&times;</button></div><form id="repeat-settings-form"><div class="mb-4"><label for="repeat-type-select" class="block text-gray-300 mb-2">Repeat Frequency</label><select id="repeat-type-select" class="w-full bg-gray-700 rounded-lg p-3"><option value="none">None</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option><option value="yearly">Yearly</option></select></div><button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold py-3 rounded-lg">Set Repeat</button></form></div></div>
    <!-- END: Added Missing Modals -->

        <script type="module">
        // Supabase SDK
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const supabaseUrl = 'https://ofysppndssyllkolxjky.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9meXNwcG5kc3N5bGxrb2x4amt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNDg1MTAsImV4cCI6MjA3MjcyNDUxMH0.x6_aRXrbxSOP7I71oSooWx8x8dedczrtemoUEWiDta8';
    const supabase = createClient(supabaseUrl, supabaseKey);
    const auth = supabase.auth;
    const storage = supabase.storage;

    function isValidUUID(uuid) {
        if (typeof uuid !== 'string' || !uuid) return false;
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        return uuidRegex.test(uuid);
    }

    const nowIso = () => new Date().toISOString();

    async function fetchProfile(userId, columns = '*') {
        if (!userId) return null;
        const { data, error } = await supabase
            .from('profiles')
            .select(columns)
            .eq('id', userId)
            .maybeSingle();
        if (error) throw error;
        return data || null;
    }

    async function updateProfile(userId, values) {
        if (!userId) throw new Error('updateProfile requires a user id');
        const { error } = await supabase
            .from('profiles')
            .update(values)
            .eq('id', userId);
        if (error) throw error;
    }

    // This function now fetches from the 'profiles' table instead of 'users'.
    async function fetchUserPrivate(userId, columns = '*') {
        if (!userId) return null;
        const { data, error } = await supabase
            .from('profiles') // Changed from 'users'
            .select(columns)
            .eq('id', userId)
            .maybeSingle();
        if (error) throw error;
        return data || null;
    }

    // This function now updates the 'profiles' table instead of 'users'.
    async function updateUserPrivate(userId, values) {
        if (!userId) throw new Error('updateUserPrivate requires a user id');
        const { error } = await supabase
            .from('profiles') // Changed from 'users'
            .update(values)
            .eq('id', userId);
        if (error) throw error;
    }

    async function fetchLatestSession(userId) {
        if (!userId) return null;
        const { data, error } = await supabase
            .from('sessions')
            .select('*')
            .eq('profile_id', userId)
            .order('endedAt', { ascending: false })
            .limit(1);
        if (error) throw error;
        return data && data.length > 0 ? data[0] : null;
    }

    async function fetchSessionsSince(userId, startIso) {
        if (!userId) return [];
        let query = supabase
            .from('sessions')
            .select('durationSeconds, type, endedAt')
            .eq('profile_id', userId);
        if (startIso) {
            query = query.gte('endedAt', startIso);
        }
        const { data, error } = await query;
        if (error) throw error;
        return data || [];
    }

    async function fetchGroup(groupId) {
        if (!groupId) return null;
        const { data, error } = await supabase
            .from('groups')
            .select('*')
            .eq('id', groupId)
            .maybeSingle();
        if (error) throw error;
        return data || null;
    }

    async function updateGroup(groupId, values) {
        if (!groupId) throw new Error('updateGroup requires a group id');
        const { error } = await supabase
            .from('groups')
            .update(values)
            .eq('id', groupId);
        if (error) throw error;
    }

    let currentUser = null;

    // restore user on page load + watch changes
    async function restoreUser() {
        const { data: { user } } = await auth.getUser();
        currentUser = user ?? null;
    }
    auth.onAuthStateChange((event, session) => {
        currentUser = session?.user ?? null;
        // This is a more robust way to handle auth state changes.
        // We only want to re-route the user on sign-in or sign-out events.
        // For user updates (like changing a profile picture), we just want to refresh
        // the profile data without navigating them away from their current page.
        if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
            routeAfterAuth();
        } else if (event === 'USER_UPDATED' && currentUser) {
            loadMyProfile();
        }
    });

    // ensure profile row exists (call after sign up / first login)
    async function ensureProfileRow() {
        const { data: { user } } = await auth.getUser();
        if (!user || !isValidUUID(user.id)) return;

        const local = (user.email || 'user').split('@')[0]
                       .toLowerCase().replace(/[^a-z0-9_]+/g, '_');
        const fallbackUsername = `${local}_${user.id.slice(0,6)}`;

        await supabase.from('profiles').upsert(
            {
                id: user.id,
                email: user.email ?? null,
                username: fallbackUsername,             // satisfies NOT NULL
                photo_url: `https://api.dicebear.com/8.x/lorelei/svg?seed=${encodeURIComponent(local)}`
            },
            { onConflict: 'id' }
        );
    }

    // Decide what to show after auth changes / signup / login
    async function routeAfterAuth() {
        const { data: { user } } = await auth.getUser();
        currentUser = user ?? null;

        // Not logged in or malformed ID â†’ stay on auth screen
        if (!currentUser || !isValidUUID(currentUser.id)) {
            showPage('auth-screen');
            return;
        }

        // Make sure a profile row exists
        await ensureProfileRow();

        // Read profile to check if setup is complete
        const { data: prof, error } = await supabase
            .from('profiles')
            .select('username, photo_url, completed_setup')
            .eq('id', currentUser.id)
            .single();

        if (error) {
            console.error('profile fetch error', error);
            // Fallback: send to setup if we canâ€™t read
            showPage('page-username-setup');
            return;
        }

        // If username missing/placeholder or explicit flag not set â†’ setup page
        const needsSetup =
            !prof ||
            !prof.username ||
            prof.username.trim().length < 3 ||
            prof.completed_setup === false;

        if (needsSetup) {
            showPage('page-username-setup');
        } else {
            await loadMyProfile();
            // This is the critical fix: Attach all real-time listeners after the user is verified.
            setupRealtimeListeners();
            // Ensure daily totals persist across refreshes
            await loadDailyTotal();
            showPage('page-timer');
        }
    }
        const ACHIEVEMENTS = {
    'novice_scholar': { name: 'Novice Scholar', description: 'Study for a total of 1 hour.' },
    'dedicated_learner': { name: 'Dedicated Learner', description: 'Study for a total of 10 hours.' },
    'marathoner': { name: 'Marathoner', description: 'Complete a single study session over 2 hours.' },
    'consistent_coder': { name: 'Consistent Coder', description: 'Maintain a 7-day study streak.' }
};
        const PRESET_AVATARS = [
            'https://api.dicebear.com/8.x/lorelei/svg?seed=Mimi',
            'https://api.dicebear.com/8.x/lorelei/svg?seed=Max',
            'https://api.dicebear.com/8.x/lorelei/svg?seed=Leo',
            'https://api.dicebear.com/8.x/lorelei/svg?seed=Muffin',
            'https://api.dicebear.com/8.x/pixel-art/svg?seed=Buddy',
            'https://api.dicebear.com/8.x/pixel-art/svg?seed=Coco',
            'https://api.dicebear.com/8.x/pixel-art/svg?seed=Gizmo',
            'https://api.dicebear.com/8.x/pixel-art/svg?seed=Jasper'
        ];
        const STUDICONS = {
            'Minimalist': [
                'https://api.dicebear.com/8.x/miniavs/svg?seed=Angel', 'https://api.dicebear.com/8.x/miniavs/svg?seed=Annie',
                'https://api.dicebear.com/8.x/miniavs/svg?seed=Charlie', 'https://api.dicebear.com/8.x/miniavs/svg?seed=Misty',
                'https://api.dicebear.com/8.x/miniavs/svg?seed=Garfield', 'https://api.dicebear.com/8.x/miniavs/svg?seed=Sheba',
                'https://api.dicebear.com/8.x/miniavs/svg?seed=Midnight', 'https://api.dicebear.com/8.x/miniavs/svg?seed=Snuggles',
                'https://api.dicebear.com/8.x/miniavs/svg?seed=Pumpkin', 'https://api.dicebear.com/8.x/miniavs/svg?seed=Patches',
            ],
            'Pixel Art': [
                'https://api.dicebear.com/8.x/pixel-art/svg?seed=Buddy', 'https://api.dicebear.com/8.x/pixel-art/svg?seed=Coco',
                'https://api.dicebear.com/8.x/pixel-art/svg?seed=Gizmo', 'https://api.dicebear.com/8.x/pixel-art/svg?seed=Jasper',
                'https://api.dicebear.com/8.x/pixel-art/svg?seed=Loki', 'https://api.dicebear.com/8.x/pixel-art/svg?seed=Milo',
                'https://api.dicebear.com/8.x/pixel-art/svg?seed=Oscar', 'https://api.dicebear.com/8.x/pixel-art/svg?seed=Peanut',
                'https://api.dicebear.com/8.x/pixel-art/svg?seed=Rocky', 'https://api.dicebear.com/8.x/pixel-art/svg?seed=Shadow',
            ],
            'Adventurer': [
                'https://api.dicebear.com/8.x/adventurer/svg?seed=Bandit', 'https://api.dicebear.com/8.x/adventurer/svg?seed=Bear',
                'https://api.dicebear.com/8.x/adventurer/svg?seed=Callie', 'https://api.dicebear.com/8.x/adventurer/svg?seed=Cleo',
                'https://api.dicebear.com/8.x/adventurer/svg?seed=Cookie', 'https://api.dicebear.com/8.x/adventurer/svg?seed=Dusty',
                'https://api.dicebear.com/8.x/adventurer/svg?seed=Felix', 'https://api.dicebear.com/8.x/adventurer/svg?seed=George',
                'https://api.dicebear.com/8.x/adventurer/svg?seed=Jack', 'https://api.dicebear.com/8.x/adventurer/svg?seed=Kiki',
            ],
            'Bottts': [
                'https://api.dicebear.com/8.x/bottts/svg?seed=Abby', 'https://api.dicebear.com/8.x/bottts/svg?seed=Baby',
                'https://api.dicebear.com/8.x/bottts/svg?seed=Boo', 'https://api.dicebear.com/8.x/bottts/svg?seed=Bubba',
                'https://api.dicebear.com/8.x/bottts/svg?seed=Cali', 'https://api.dicebear.com/8.x/bottts/svg?seed=Chance',
                'https://api.dicebear.com/8.x/bottts/svg?seed=Cuddles', 'https://api.dicebear.com/8.x/bottts/svg?seed=Frankie',
                'https://api.dicebear.com/8.x/bottts/svg?seed=Harley', 'https://api.dicebear.com/8.x/bottts/svg?seed=Lilly',
            ],
        };
        // --- Web Worker Implementation ---
        const workerCode = `
            let timerInterval = null;
            let endTime = 0;
            let remainingTimeOnPause = 0;
            let isPaused = false;
            let currentPhaseDuration = 0;

            function tick() {
                if (isPaused) return;
                const now = Date.now();
                const timeLeft = Math.round((endTime - now) / 1000);

                if (timeLeft > 0) {
                    self.postMessage({ type: 'tick', timeLeft: timeLeft });
                } else {
                    self.postMessage({ type: 'tick', timeLeft: 0 });
                    clearInterval(timerInterval);
                    timerInterval = null;
                    self.postMessage({ type: 'phase_ended' }); 
                    // The main thread will handle the transition via the Service Worker alarm
                }
            }

            self.onmessage = function(e) {
                const { command, duration } = e.data;
                switch(command) {
                    case 'start':
                        isPaused = false;
                        if (timerInterval) clearInterval(timerInterval);
                        currentPhaseDuration = duration;
                        endTime = Date.now() + duration * 1000;
                        timerInterval = setInterval(tick, 1000);
                        tick();
                        break;
                    case 'pause':
                        if (timerInterval) {
                            isPaused = true;
                            remainingTimeOnPause = endTime - Date.now();
                            clearInterval(timerInterval); // Stop the interval when paused
                            timerInterval = null;
                        }
                        break;
                    case 'resume':
                        if (isPaused && remainingTimeOnPause > 0) {
                            isPaused = false;
                            endTime = Date.now() + remainingTimeOnPause;
                            timerInterval = setInterval(tick, 1000);
                            tick();
                            remainingTimeOnPause = 0;
                        }
                        break;
                    case 'stop':
                        if (timerInterval) clearInterval(timerInterval);
                        timerInterval = null;
                        endTime = 0;
                        remainingTimeOnPause = 0;
                        isPaused = false;
                        break;
                }
            };
        `;
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const pomodoroWorker = new Worker(URL.createObjectURL(blob));

        // --- FIX START: Listen for messages from the Pomodoro Web Worker ---
        pomodoroWorker.onmessage = (e) => {
            const { type, timeLeft } = e.data;
            if (type === 'tick' && sessionTimerDisplay) {
                // Update the timer display on every tick from the worker
                sessionTimerDisplay.textContent = formatPomodoroTime(timeLeft);
            } else if (type === 'phase_ended') {
                // This is a local trigger from the worker when a phase ends.
                // It's the primary way the UI transitions when the app is in the foreground.
                console.log('Worker signaled phase end. Handling transition locally.');
                
                const oldState = pomodoroState;
                if (oldState === 'idle') return; // Safety check, don't transition if already stopped

                let newState;
                if (oldState === 'work') {
                    // A work session just finished. Check if it's time for a long break.
                    const completedWorkSessions = currentUserData.pomodoroCycle || 0;
                    const isLongBreakTime = completedWorkSessions > 0 && (completedWorkSessions % pomodoroSettings.long_break_interval === 0);
                    newState = isLongBreakTime ? 'long_break' : 'short_break';
                } else {
                    // A break just finished. Time to get back to work.
                    newState = 'work';
                }

                // Call the existing handler function to manage the transition.
                handlePomodoroPhaseEnd({ newState, oldState });
            }
        };
        // --- FIX END ---

        // --- Service Worker Communication Functions ---
        function scheduleSWAlarm(payload) {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'SCHEDULE_ALARM',
                    payload: payload
                });
            }
        }

        function cancelSWAlarm(timerId) {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'CANCEL_ALARM',
                    payload: { timerId: timerId }
                });
            }
        }


        // --- Application Setup ---
        const getCurrentDate = () => new Date();

        // --- App State ---
        let currentUserData = {};
        let dashboardCharts = {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let userSessions = [];
        let isAudioUnlocked = false;
        let isAddingSubjectFromStartSession = false; // Flag to track modal origin

        // --- FIX START: Add the function to handle Pomodoro phase transitions ---
        async function handlePomodoroPhaseEnd(data) {
            const { newState, oldState } = data;
        
            // Play the appropriate sound for the end of the phase
            playSound(oldState === 'work' ? pomodoroSounds.break : pomodoroSounds.focus, pomodoroSounds.volume);
        
            // Save the session that just ended
            const sessionDuration = oldState === 'work' 
                ? pomodoroSettings.work * 60
                : (oldState === 'short_break' ? pomodoroSettings.short_break * 60 : pomodoroSettings.long_break * 60);
        
            const sessionType = oldState === 'work' ? 'study' : 'break';
            const subject = oldState === 'work' ? activeSubject : oldState.replace('_', ' ');
            await saveSession(subject, sessionDuration, sessionType);
        
            // Check auto-start settings to decide what to do next
            const shouldAutoStart = (newState === 'work' && pomodoroSettings.autoStartFocus) || 
                                    (newState.includes('break') && pomodoroSettings.autoStartBreak);
        
            if (shouldAutoStart) {
                await startNextPomodoroPhase(newState);
            } else {
                // If not auto-starting, show the manual start button
                pomodoroState = 'idle'; 
                nextPomodoroPhase = newState;
                document.getElementById('manual-start-btn').classList.remove('hidden');
                document.getElementById('stop-studying-btn').classList.add('hidden');
                document.getElementById('pause-btn').classList.add('hidden');
                pomodoroStatusDisplay.textContent = `Ready for ${newState.replace('_', ' ')}`;
            }
        }
        // --- FIX END ---

/**
 * Sends a notification request to the Supabase Edge Function.
 * @param {object} messageData - Includes title, options.body, newState and oldState.
 */
async function triggerServerNotification(messageData) {
    if (!currentUser) {
        console.error('User not authenticated, cannot send server notification.');
        showToast('Please sign in to enable server notifications.', 'error');
        return;
    }
    try {
        const { data, error } = await supabase.functions.invoke('send-pomodoro-notification', {
            body: {
                userId: currentUser.id,
                appId,
                title: messageData.title,
                body: messageData.options.body,
                newState: messageData.newState,
                oldState: messageData.oldState
            }
        });
        if (error) throw error;
        console.log('Server notification triggered:', data);
    } catch (error) {
        console.error('Error triggering server notification:', error);
        showToast('Failed to schedule notification.', 'error');
    }
}

        // Timer State
        // Add these lines
let isPaused = false;
let pauseStartTime = 0;
        let timerInterval = null;
        let sessionStartTime = 0;
        let totalTimeTodayInSeconds = 0;
        let totalBreakTimeTodayInSeconds = 0; // New: Track total break time today
        let activeSubject = '';
        let groupDetailUnsubscribers = [];
        let memberTimerIntervals = [];
        let currentGroupId = null;
        let groupRealtimeData = {
            members: {},
            sessions: {}
        };
        
        // Break Timer State (for idle time)
        let breakTimerInterval = null;
        let breakStartTime = 0;

        // Drag & Drop State
        let draggedItem = null;

        // --- Pomodoro State ---
        let timerMode = 'normal'; // 'normal' or 'pomodoro'
        let pomodoroState = 'idle'; // 'work', 'short_break', 'long_break', 'idle'
        let nextPomodoroPhase = null; // To store the next phase for manual start
        let pomodoroSettings = {
            work: 25,
            short_break: 5,
            long_break: 15,
            long_break_interval: 4,
            autoStartBreak: true,
            autoStartFocus: true
        };
        let pomodoroSounds = {
            start: "tone_simple_beep", 
            focus: "tone_chime_chord",
            break: "tone_metal_bell",
            volume: 1.0
        };
        const availableSounds = {
            'None': '',
            '8-Bit Powerup': 'tone_powerup',
            'Alarm Beep': 'tone_alarm_beep',
            'Alien Signal': 'tone_alien_signal',
            'Arcade Hit': 'tone_arcade_hit',
            'Bass Drop': 'tone_bass_drop',
            'Beep Sequence': 'tone_beep_sequence',
            'Bell': 'tone_metal_bell',
            'Bird': 'tone_bird',
            'Bubble Pop': 'tone_bubble_pop',
            'Bubbles': 'tone_bubbles',
            'Buzzer': 'tone_buzzer',
            'Cat Purr': 'tone_purr',
            'Celesta': 'tone_celesta',
            'Chime Chord': 'tone_chime_chord',
            'Chimes': 'tone_chimes',
            'Chiptune Arp': 'tone_chiptune_arp',
            'Choir Aah': 'tone_choir_aah',
            'Clock Tick': 'tone_clock_tick',
            'Coin Collect': 'tone_coin_collect',
            'Computer Voice': 'tone_computer_voice',
            'Cosmic Ping': 'tone_cosmic_ping',
            'Cosmic Rumble': 'tone_cosmic_rumble',
            'Crickets': 'tone_crickets',
            'Crystal': 'tone_crystal',
            'Cybernetic': 'tone_cybernetic',
            'Data Stream': 'tone_data_stream',
            'Deep Drone': 'tone_deep_drone',
            'Dial-up': 'tone_dial_up',
            'Digital': 'tone_digital',
            'Digital Sweep': 'tone_digital_sweep',
            'Disintegrate': 'tone_disintegrate',
            'Dreamy Arp': 'tone_dreamy_arp',
            'Drone Pulse': 'tone_drone_pulse',
            'Electric Piano': 'tone_electric_piano',
            'Energy Charge': 'tone_energy_charge',
            'Engine Start': 'tone_engine_start',
            'Error Beep': 'tone_error_beep',
            'Explosion': 'tone_explosion',
            'Fairy Twinkle': 'tone_fairy_twinkle',
            'Flute': 'tone_flute',
            'Forcefield': 'tone_forcefield',
            'Game Over': 'tone_game_over',
            'Glass Tap': 'tone_glass_tap',
            'Glitch': 'tone_glitch',
            'Gong': 'tone_gong',
            'Guitar Harmonic': 'tone_guitar_harmonic',
            'Harp': 'tone_harp',
            'Heartbeat': 'tone_heartbeat',
            'High Score': 'tone_high_score',
            'Hologram': 'tone_hologram',
            'Hyperspace': 'tone_hyperspace',
            'Kalimba': 'tone_kalimba',
            'Keyboard Click': 'tone_keyboard',
            'Kitchen': 'tone_kitchen',
            'Laser': 'tone_laser',
            'Low Battery': 'tone_low_battery',
            'Mechanical': 'tone_mechanical',
            'Metal Bell': 'tone_metal_bell',
            'Modem': 'tone_modem',
            'Morse Code': 'tone_morse',
            'Music Box': 'tone_music_box',
            'Noise Alarm': 'tone_noise_alarm',
            'Notification Pop': 'tone_notification_pop',
            'Ocean Wave': 'tone_ocean',
            'Ominous Drone': 'tone_ominous_drone',
            'Page Turn': 'tone_page_turn',
            'Phase Shift': 'tone_phase_shift',
            'Pluck': 'tone_pluck',
            'Portal': 'tone_portal',
            'Power Down': 'tone_power_down',
            'Rain on Window': 'tone_rain_on_window',
            'Rainfall': 'tone_rainfall',
            'Retro Game': 'tone_retro_game',
            'Riser': 'tone_riser',
            'Robot Beep': 'tone_robot_beep',
            'Scanner': 'tone_scanner',
            'Sci-Fi Pad': 'tone_sci_fi_pad',
            'Simple Beep': 'tone_simple_beep',
            'Singing Bowl': 'tone_singing_bowl',
            'Soft Marimba': 'tone_soft_marimba',
            'Sonar Ping': 'tone_sonar',
            'Starship Hum': 'tone_starship_hum',
            'Static': 'tone_static',
            'Steam Train': 'tone_steam_train',
            'Steel Drum': 'tone_steel_drum',
            'Strummed Chord': 'tone_strummed_chord',
            'Stutter': 'tone_stutter',
            'Subtle Beep': 'tone_subtle_beep',
            'Synth Pluck': 'tone_synth_pluck',
            'Synthwave': 'tone_synthwave',
            'Teleporter': 'tone_teleporter',
            'Thunder': 'tone_thunder',
            'Tibetan Bowl': 'tone_tibetan_bowl',
            'Typewriter': 'tone_typewriter',
            'UI Confirm': 'tone_ui_confirm',
            'Vibrating Bell': 'tone_vibrating_bell',
            'Vinyl Crackles': 'tone_vinyl_crackles',
            'Violin Pizzicato': 'tone_pizzicato',
            'Warning Horn': 'tone_warning_horn',
            'Water Drop': 'tone_water_drop',
            'Wind Chimes': 'tone_wind_chimes',
            'Wobble': 'tone_wobble',
            'Wood': 'tone_wood',
            'Xylophone': 'tone_xylophone',
            'Zen Garden': 'tone_zen_garden',
        };

        // Attendance State
        let attendanceMonth = getCurrentDate().getMonth();
        let attendanceYear = getCurrentDate().getFullYear();

        // --- UI Elements ---
        const authError = document.getElementById('auth-error');
        const sessionTimerDisplay = document.getElementById('session-timer');
        const totalTimeDisplay = document.getElementById('total-time-display');
        const totalBreakTimeDisplay = document.getElementById('total-break-time-display');
        const activeSubjectDisplay = document.getElementById('active-subject-display');
        const pomodoroStatusDisplay = document.getElementById('pomodoro-status');

        window.viewImage = function(src) {
            const modal = document.getElementById('image-view-modal');
            const img = document.getElementById('fullscreen-image');
            if (modal && img) {
                img.src = src;
                modal.classList.add('active');
            }
        }

        const PROFILE_BUCKET = 'profile-pictures';
        const BUCKET_IS_PRIVATE = false; // <-- set to true if your bucket is private

        async function uploadProfilePicture(file) {
            try {
                if (!currentUser) { showToast('Please sign in first.', 'info'); return; }
                if (!file || !file.type?.startsWith('image/')) { showToast('Pick a valid image.', 'error'); return; }
                if (file.size > 5 * 1024 * 1024) { showToast('Max size 5MB.', 'error'); return; }

                const ext = file.name.split('.').pop();
                const filePath = `${currentUser.id}/profile.${ext}`;

                // upload with contentType + upsert
                const { error: upErr } = await storage
                    .from(PROFILE_BUCKET)
                    .upload(filePath, file, { upsert: true, contentType: file.type });
                if (upErr) throw upErr;

                // public or signed URL
                let publicUrl = '';
                if (!BUCKET_IS_PRIVATE) {
                    const { data } = storage.from(PROFILE_BUCKET).getPublicUrl(filePath);
                    // FIX: Store the clean base URL without any cache-busting parameters.
                    publicUrl = data?.publicUrl || '';
                } else {
                    const { data, error: sErr } = await storage
                        .from(PROFILE_BUCKET)
                        .createSignedUrl(filePath, 60 * 60 * 24); // 24h
                    if (sErr) throw sErr;
                    // FIX: Store the clean base URL without any cache-busting parameters.
                    publicUrl = data?.signedUrl || '';
                }
                if (!publicUrl) throw new Error('Could not get file URL');

                // save URL in your profiles table column: photo_url
                const { error: upProfileErr } = await supabase
                    .from('profiles')
                    .update({ photo_url: publicUrl })
                    .eq('id', currentUser.id);
                if (upProfileErr) throw upProfileErr;

                // FIX: Also update the user's metadata in Supabase Auth.
                // This keeps the auth session in sync with the profile table, preventing
                // stale data from being shown on re-login.
                const { error: updateUserError } = await auth.updateUser({
                    data: { photo_url: publicUrl }
                });
                if (updateUserError) throw updateUserError;

                // refresh UI
                await loadMyProfile();
                showToast('Profile picture updated!', 'success');
            } catch (e) {
                console.error('uploadProfilePicture error', e);
                showToast('Upload failed. Check RLS/storage policies & bucket visibility.', 'error');
            }
        }

        // helper to load your own profile (photo + username, etc.)
        async function loadMyProfile() {
            if (!currentUser) return;
            const { data, error } = await supabase
                .from('profiles')
                .select('*') // Select all fields to get streak, achievements, etc.
                .eq('id', currentUser.id)
                .maybeSingle();
            
            if (error) { 
                console.error('Failed to load profile:', error);
                return; 
            }
            
            if (data) {
                // This function will now update all parts of the profile UI
                updateProfileUI(data); 
            }
        }


        async function handleImageUpload(file, groupId) {
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file.', 'error');
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showToast('Image is too large (max 5MB).', 'error');
                return;
            }
            showToast('Uploading image...', 'info');

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}.${fileExt}`;
                const filePath = `${groupId}/${fileName}`;
                const { error: uploadError } = await storage
                    .from('group-images')
                    .upload(filePath, file);
                if (uploadError) throw uploadError;

                const { data: publicUrlData } = storage
                    .from('group-images')
                    .getPublicUrl(filePath);
                const publicUrl = publicUrlData.publicUrl;

                const { data: userData, error: userError } = await supabase
                    .from('profiles').select('username')
                    .eq('id', currentUser.id)
                    .single();
                if (userError) throw userError;

                const { error: insertError } = await supabase
                    .from('group_messages')
                    .insert({
                        group_id: groupId,
                        image_url: publicUrl,
                        text: '',
                        sender_id: currentUser.id,
                        sender_name: userData.username,
                        created_at: new Date().toISOString()
                    });
                if (insertError) throw insertError;
            } catch (error) {
                console.error('Error uploading image:', error);
                showToast('Image upload failed.', 'error');
            }
        }

        // call when a Pomodoro finishes
        // studySeconds: number of seconds studied in the session
        async function recordPomodoroSession(studySeconds = 25 * 60) {
            try {
                if (!currentUser) { showToast('Sign in to record progress.', 'info'); return; }

                // read existing counters (simple & safe without RPC)
                const { data: prof, error: readErr } = await supabase
                    .from('profiles')
                    .select('total_study_sessions, current_streak, last_study_date')
                    .eq('id', currentUser.id)
                    .maybeSingle();
                if (readErr) throw readErr;

                const today = new Date().toISOString().slice(0, 10);
                const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);

                const prevStreak = prof?.current_streak ?? 0;
                const prevLast = prof?.last_study_date ?? null;

                let newStreak = prevStreak;
                if (prevLast === today) {
                    // already studied today â†’ streak unchanged
                } else if (prevLast === yesterday) {
                    newStreak = prevStreak + 1;
                } else {
                    newStreak = 1;
                }

                const newSessions = (prof?.total_study_sessions ?? 0) + 1;

                const { error: upErr } = await supabase
                    .from('profiles')
                    .update({
                        total_study_sessions: newSessions,
                        current_streak: newStreak,
                        last_study_date: today
                    })
                    .eq('id', currentUser.id);
                if (upErr) throw upErr;

                showToast('Session saved!', 'success');
                // refresh leaderboard if visible
                // await loadLeaderboard();
            } catch (e) {
                console.error('recordPomodoroSession error', e);
                showToast('Could not save session. Check RLS on profiles.', 'error');
            }
        }

        // fetch & render leaderboard
        async function loadLeaderboard(limit = 50) {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, username, photo_url, total_study_sessions, current_streak')
                    .order('total_study_sessions', { ascending: false })
                    .limit(limit);

                if (error) throw error;

                // TODO: render in your UI
                // leaderboardEl.innerHTML = data.map((u, i) => `
                //   <li>
                //     <img src="${u.photo_url || '/assets/default-avatar.png'}" />
                //     <span>#${i+1}</span>
                //     <span>${u.username || 'Anon'}</span>
                //     <span>${u.total_study_sessions} sessions</span>
                //   </li>`).join('');
            } catch (e) {
                console.error('loadLeaderboard error', e);
                showToast('Could not load leaderboard. Check RLS (select on profiles).', 'error');
            }
        }

        // --- UI Helper Functions ---
        
        function pick(...args) {
            for (const arg of args) {
                if (arg !== undefined && arg !== null) {
                    return arg;
                }
            }
            return undefined;
        }

        /**
         * Sends a message to the Service Worker to schedule a notification.
         * This is the key to reliable background timers on mobile.
         * @param {number} delayInMs - The delay in milliseconds until the notification should be shown.
         * @param {string} title - The title of the notification.
         * @param {object} options - The options for the notification (e.g., body, icon, tag).
         */
        function scheduleTransitionNotification(delayInMs, title, options) {
            // First, make sure Service Workers and Notifications are supported.
            if (!('serviceWorker' in navigator) || !('Notification' in window)) {
                console.warn('Service Workers or Notifications are not supported in this browser.');
                return;
            }

            // Ask for permission if we don't have it yet.
            // This should ideally be done upon a clear user action, like enabling Pomodoro mode.
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        // Permission granted, now schedule.
                        scheduleNow(delayInMs, title, options);
                    }
                });
            } else if (Notification.permission === 'granted') {
                scheduleNow(delayInMs, title, options);
            }
            
            function scheduleNow(delay, title, opts) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.active.postMessage({
                        type: 'SCHEDULE_NOTIFICATION',
                        payload: {
                            delay: delay,
                            title: title,
                            options: opts
                        }
                    });
                });
            }
        }


        async function playSound(soundId, volume) {
            if (!soundId || soundId.trim() === '') return;
            
            await Tone.start();

            try {
                if (soundId.startsWith('tone_')) {
                    const now = Tone.now();
                    const settings = { volume: Tone.gainToDb(volume) };
                    
                    // Helper to create, trigger, and dispose of a synth to prevent memory leaks
                    const triggerSynth = (synthType, options, note, duration, connection) => {
                        const s = new synthType(options);
                        if (connection) {
                            s.connect(connection);
                        } else {
                            s.toDestination();
                        }
                        s.triggerAttackRelease(note, duration, now);
                        // Dispose after the sound has finished playing
                        const durationSeconds = Tone.Time(duration).toSeconds();
                        setTimeout(() => s.dispose(), (durationSeconds + 0.5) * 1000);
                    };
                    
                     const triggerPolySynth = (synthType, options, notes, duration) => {
                        const poly = new Tone.PolySynth(synthType, options).toDestination();
                        poly.triggerAttackRelease(notes, duration, now);
                        const durationSeconds = Tone.Time(duration).toSeconds();
                        setTimeout(() => poly.dispose(), (durationSeconds + 1) * 1000);
                    };

                    switch (soundId) {
                        // --- Simple Tones & Beeps ---
                        case 'tone_simple_beep':
                            triggerSynth(Tone.Oscillator, { ...settings, type: "sine", frequency: "C5" }, "C5", 0.2);
                            break;
                        case 'tone_subtle_beep':
                            triggerSynth(Tone.Oscillator, { volume: Tone.gainToDb(volume * 0.5), type: "sine", frequency: "A5" }, "A5", 0.15);
                            break;
                        case 'tone_alarm_beep':
                            triggerSynth(Tone.Synth, { ...settings, oscillator: { type: 'square' } }, "F#5", "0.2s");
                            break;
                        case 'tone_buzzer':
                            triggerSynth(Tone.Synth, { ...settings, oscillator: { type: 'sawtooth' } }, "C3", "0.3s");
                            break;
                        case 'tone_error_beep':
                            const errorSynth = new Tone.Synth({ ...settings, oscillator: { type: 'triangle' } }).toDestination();
                            errorSynth.triggerAttackRelease("B4", "16n", now);
                            errorSynth.triggerAttackRelease("F4", "16n", now + 0.2);
                            setTimeout(() => errorSynth.dispose(), 600);
                            break;
                        case 'tone_ui_confirm':
                            const confirmSynth = new Tone.Synth({ ...settings, oscillator: { type: 'sine' } }).toDestination();
                            confirmSynth.triggerAttackRelease("C5", "16n", now);
                            confirmSynth.triggerAttackRelease("G5", "16n", now + 0.1);
                            setTimeout(() => confirmSynth.dispose(), 500);
                            break;
                        case 'tone_warning_horn':
                            triggerSynth(Tone.Synth, { ...settings, oscillator: { type: 'sawtooth' } }, "A3", "1s");
                            break;
                        case 'tone_beep_sequence':
                            const seqSynth = new Tone.Synth(settings).toDestination();
                            seqSynth.triggerAttackRelease("C5", "16n", now);
                            seqSynth.triggerAttackRelease("E5", "16n", now + 0.15);
                            seqSynth.triggerAttackRelease("G5", "16n", now + 0.3);
                            setTimeout(() => seqSynth.dispose(), 800);
                            break;
                        case 'tone_low_battery':
                            const lowBattSynth = new Tone.Synth(settings).toDestination();
                            lowBattSynth.triggerAttackRelease("G4", "8n", now);
                            lowBattSynth.triggerAttackRelease("E4", "8n", now + 0.2);
                            lowBattSynth.triggerAttackRelease("C4", "8n", now + 0.4);
                            setTimeout(() => lowBattSynth.dispose(), 1000);
                            break;
                        case 'tone_robot_beep':
                            triggerSynth(Tone.Synth, { ...settings, oscillator: { type: 'square' } }, "A4", "16n");
                            break;
                        case 'tone_computer_voice':
                            const compSynth = new Tone.Synth({ ...settings, oscillator: { type: 'square' } }).toDestination();
                            compSynth.triggerAttackRelease("A3", "16n", now);
                            compSynth.triggerAttackRelease("D4", "16n", now + 0.15);
                            compSynth.triggerAttackRelease("F4", "16n", now + 0.3);
                            setTimeout(() => compSynth.dispose(), 800);
                            break;
                        case 'tone_digital':
                             triggerSynth(Tone.FMSynth, { ...settings, harmonicity: 3, modulationIndex: 10 }, "C6", "32n");
                             break;

                        // --- Melodic & Chords ---
                        case 'tone_chime_chord':
                            triggerPolySynth(Tone.Synth, { volume: settings.volume, oscillator: {type: 'sine'} }, ["C5", "E5", "G5"], "0.5s");
                            break;
                        case 'tone_chimes':
                            triggerPolySynth(Tone.MetalSynth, { volume: settings.volume, harmonicity: 8, resonance: 800, octaves: 1.5 }, ["C5", "E5", "G5", "B5"], "1s");
                            break;
                        case 'tone_synth_pluck':
                            triggerSynth(Tone.Synth, settings, "C4", "8n");
                            break;
                        case 'tone_pluck':
                            triggerSynth(Tone.PluckSynth, settings, "C4", "4n");
                            break;
                        case 'tone_music_box':
                            const mbSynth = new Tone.PluckSynth({ ...settings, attackNoise: 0.5, dampening: 4000, resonance: 0.9 }).toDestination();
                            const mbReverb = new Tone.Reverb(1.5).toDestination();
                            mbSynth.connect(mbReverb);
                            mbSynth.triggerAttackRelease("C5", "1n", now);
                            mbSynth.triggerAttackRelease("G5", "1n", now + 0.5);
                            mbSynth.triggerAttackRelease("E5", "1n", now + 1);
                            setTimeout(() => { mbSynth.dispose(); mbReverb.dispose(); }, 2500);
                            break;
                         case 'tone_xylophone':
                            triggerSynth(Tone.PluckSynth, { ...settings, attackNoise: 1, dampening: 7000, resonance: 0.98 }, "C5", "4n");
                            break;
                        case 'tone_celesta':
                            triggerSynth(Tone.MetalSynth, { ...settings, harmonicity: 7, resonance: 900, octaves: 2 }, "C5", "1s");
                            break;
                        case 'tone_chiptune_arp':
                            const arpSynth = new Tone.Synth({ ...settings, oscillator: { type: 'pulse', width: 0.4 } }).toDestination();
                            const notes = ["C4", "E4", "G4", "C5", "G4", "E4"];
                            notes.forEach((note, i) => arpSynth.triggerAttackRelease(note, "16n", now + i * 0.1));
                            setTimeout(() => arpSynth.dispose(), 1000);
                            break;
                        case 'tone_dreamy_arp':
                            const dreamSynth = new Tone.FMSynth({ ...settings, harmonicity: 1.5, modulationIndex: 5 }).toDestination();
                            const dreamReverb = new Tone.Reverb(3).toDestination();
                            dreamSynth.connect(dreamReverb);
                            const dreamNotes = ["C4", "G4", "B4", "E5"];
                            dreamNotes.forEach((note, i) => dreamSynth.triggerAttackRelease(note, "4n", now + i * 0.3));
                            setTimeout(() => { dreamSynth.dispose(); dreamReverb.dispose(); }, 2500);
                            break;
                        case 'tone_electric_piano':
                            triggerSynth(Tone.FMSynth, { ...settings, harmonicity: 3, modulationIndex: 10, envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.8 } }, "C4", "2n");
                            break;
                        case 'tone_flute':
                            triggerSynth(Tone.Synth, { ...settings, oscillator: { type: 'sine' }, envelope: { attack: 0.1, decay: 0.2, sustain: 0.3, release: 0.5 } }, "C5", "1s");
                            break;
                        case 'tone_guitar_harmonic':
                            triggerSynth(Tone.PluckSynth, { ...settings, attackNoise: 0.1, dampening: 8000, resonance: 0.95 }, "C5", "1n");
                            break;
                        case 'tone_harp':
                             triggerPolySynth(Tone.PluckSynth, { volume: settings.volume, attackNoise: 0.2, dampening: 5000, resonance: 0.9 }, ["C4", "E4", "G4", "B4", "D5"], "1n");
                            break;
                        case 'tone_kalimba':
                            triggerSynth(Tone.PluckSynth, { ...settings, attackNoise: 0.8, dampening: 3000, resonance: 0.8 }, "C4", "4n");
                            break;
                        case 'tone_pizzicato':
                            triggerSynth(Tone.PluckSynth, { ...settings, attackNoise: 0.05, dampening: 1500, resonance: 0.5 }, "C4", "8n");
                            break;
                        case 'tone_soft_marimba':
                             triggerSynth(Tone.Synth, { ...settings, oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.8, sustain: 0, release: 0.1 } }, "C4", "2n");
                            break;
                        case 'tone_steel_drum':
                            triggerSynth(Tone.MetalSynth, { ...settings, harmonicity: 3.5, modulationIndex: 20, resonance: 1000 }, "C4", "2n");
                            break;
                        case 'tone_strummed_chord':
                            const strumSynth = new Tone.PolySynth(Tone.PluckSynth, { volume: settings.volume, attackNoise: 0.1, dampening: 4000 }).toDestination();
                            const chord = ["C4", "E4", "G4", "C5"];
                            chord.forEach((note, i) => strumSynth.triggerAttack(note, now + i * 0.03));
                            strumSynth.releaseAll(now + 1);
                            setTimeout(() => strumSynth.dispose(), 1500);
                            break;
                        case 'tone_synthwave':
                            triggerPolySynth(Tone.Synth, { volume: settings.volume, oscillator: {type: 'fatsawtooth'}, envelope: {attack: 0.1, decay: 0.5, sustain: 0.3, release: 1} }, ["C3", "E3", "G3"], "1s");
                            break;
                        
                        // --- Game & UI Sounds ---
                        case 'tone_arcade_hit':
                            triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0 } }, null, "8n");
                            break;
                        case 'tone_coin_collect':
                            const coinSynth = new Tone.Synth({ ...settings }).toDestination();
                            coinSynth.triggerAttackRelease("E6", "16n", now);
                            coinSynth.triggerAttackRelease("G6", "16n", now + 0.1);
                            setTimeout(() => coinSynth.dispose(), 500);
                            break;
                        case 'tone_laser':
                            const laserSynth = new Tone.Synth(settings).toDestination();
                            laserSynth.frequency.rampTo("C4", 0.1, now);
                            laserSynth.triggerAttackRelease("A5", "8n", now);
                            setTimeout(() => laserSynth.dispose(), 500);
                            break;
                        case 'tone_powerup':
                            const powerupSynth = new Tone.Synth(settings).toDestination();
                            const p_notes = ["C5", "E5", "G5", "C6"];
                            p_notes.forEach((note, i) => powerupSynth.triggerAttackRelease(note, "16n", now + i * 0.1));
                            setTimeout(() => powerupSynth.dispose(), 800);
                            break;
                        case 'tone_game_over':
                            const goSynth = new Tone.Synth({ ...settings, oscillator: { type: 'sawtooth' } }).toDestination();
                            const go_notes = [{n: "C4", t: 0}, {n: "G3", t: 0.2}, {n: "E3", t: 0.4}, {n: "C3", t: 0.6}];
                            go_notes.forEach(note => goSynth.triggerAttackRelease(note.n, "8n", now + note.t));
                            setTimeout(() => goSynth.dispose(), 1200);
                            break;
                        case 'tone_high_score':
                            const hsSynth = new Tone.Synth(settings).toDestination();
                            const hs_notes = ["A4", "C5", "E5", "A5", "E5"];
                            hs_notes.forEach((note, i) => hsSynth.triggerAttackRelease(note, "16n", now + i * 0.1));
                            setTimeout(() => hsSynth.dispose(), 1000);
                            break;
                        case 'tone_notification_pop':
                            triggerSynth(Tone.MembraneSynth, { ...settings, pitchDecay: 0.01, octaves: 4 }, "G5", "32n");
                            break;
                        case 'tone_retro_game':
                            triggerSynth(Tone.Synth, { ...settings, oscillator: { type: 'square' } }, "A4", "16n");
                            break;
                        case 'tone_stutter':
                            const stutterSynth = new Tone.Synth(settings).toDestination();
                            for (let i = 0; i < 4; i++) {
                                stutterSynth.triggerAttackRelease("C5", "32n", now + i * 0.05);
                            }
                            setTimeout(() => stutterSynth.dispose(), 500);
                            break;
                            
                        // --- Percussive & Effects ---
                        case 'tone_metal_bell':
                            triggerSynth(Tone.MetalSynth, { ...settings, envelope: { decay: 1.2 } }, "C5", "1s");
                            break;
                        case 'tone_noise_alarm':
                            triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: "pink" }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.1, release: 0.8 } }, null, "1s");
                            break;
                        case 'tone_wobble':
                            const wobbleSynth = new Tone.Synth({ ...settings, oscillator: { type: "fmsquare", modulationType: "sawtooth", modulationIndex: 2 } }).toDestination();
                            wobbleSynth.triggerAttackRelease("C3", "4n", now);
                            setTimeout(() => wobbleSynth.dispose(), 1000);
                            break;
                        case 'tone_bird':
                            const birdSynth = new Tone.Synth({ ...settings, oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }).toDestination();
                            birdSynth.frequency.setValueAtTime("G5", now);
                            birdSynth.frequency.linearRampToValueAtTime("A5", now + 0.1);
                            birdSynth.frequency.linearRampToValueAtTime("G5", now + 0.2);
                            birdSynth.triggerAttack(now).triggerRelease(now + 0.2);
                            setTimeout(() => birdSynth.dispose(), 500);
                            break;
                        case 'tone_bubble_pop':
                            triggerSynth(Tone.MembraneSynth, { ...settings, pitchDecay: 0.01, octaves: 4 }, "C4", "32n");
                            break;
                        case 'tone_bubbles':
                            const bubbleSynth = new Tone.MembraneSynth({ ...settings, pitchDecay: 0.02, octaves: 5 }).toDestination();
                            for (let i = 0; i < 5; i++) {
                                bubbleSynth.triggerAttackRelease(`C${4+i}`, "16n", now + i * 0.1);
                            }
                            setTimeout(() => bubbleSynth.dispose(), 1000);
                            break;
                        case 'tone_explosion':
                            const exSynth = new Tone.NoiseSynth({ ...settings, noise: { type: 'white' }, envelope: { attack: 0.01, decay: 1, sustain: 0, release: 0.5 } }).toDestination();
                            const exFilter = new Tone.Filter(1000, "lowpass").toDestination();
                            exSynth.connect(exFilter);
                            exFilter.frequency.rampTo(100, 1, now);
                            exSynth.triggerAttackRelease("1s", now);
                            setTimeout(() => { exSynth.dispose(); exFilter.dispose(); }, 1500);
                            break;
                        case 'tone_gong':
                            triggerSynth(Tone.MetalSynth, { ...settings, frequency: 150, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5, envelope: { attack: 0.01, decay: 2.5, release: 1 } }, "C2", "2s");
                            break;
                        case 'tone_water_drop':
                            triggerSynth(Tone.MembraneSynth, { ...settings, pitchDecay: 0.05, octaves: 10, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.14, sustain: 0.01, release: 0.2 } }, "C7", "8n");
                            break;
                        case 'tone_bass_drop':
                            const bdSynth = new Tone.MembraneSynth({ ...settings, pitchDecay: 0.8, octaves: 4, envelope: { attack: 0.1, decay: 1, sustain: 0.5, release: 1 } }).toDestination();
                            bdSynth.triggerAttackRelease("C1", "1n", now);
                            setTimeout(() => bdSynth.dispose(), 2000);
                            break;
                        case 'tone_crickets':
                            const cricketSynth = new Tone.NoiseSynth({ ...settings, noise: { type: 'white' }, envelope: { attack: 0.01, decay: 0.05, sustain: 0 } }).toDestination();
                            const cricketFilter = new Tone.Filter(8000, "bandpass").toDestination();
                            cricketSynth.connect(cricketFilter);
                            for (let i = 0; i < 5; i++) {
                                cricketSynth.triggerAttack(now + i * 0.2);
                            }
                            setTimeout(() => { cricketSynth.dispose(); cricketFilter.dispose(); }, 1500);
                            break;
                        case 'tone_disintegrate':
                            triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: 'pink', fadeOut: 0.5 }, envelope: { attack: 0.01, decay: 0.5, sustain: 0 } }, null, "0.5s");
                            break;
                        case 'tone_engine_start':
                            const engineSynth = new Tone.NoiseSynth({ ...settings, noise: { type: 'brown' } }).toDestination();
                            const engineFilter = new Tone.Filter(100, "lowpass").toDestination();
                            engineSynth.connect(engineFilter);
                            engineFilter.frequency.rampTo(1000, 1, now);
                            engineSynth.triggerAttackRelease("1s", now);
                            setTimeout(() => { engineSynth.dispose(); engineFilter.dispose(); }, 1500);
                            break;
                        case 'tone_glass_tap':
                            triggerSynth(Tone.MetalSynth, { ...settings, harmonicity: 12, resonance: 1200, octaves: 1, envelope: { attack: 0.001, decay: 0.1, release: 0.1 } }, "C6", "16n");
                            break;
                        case 'tone_glitch':
                            const glitchSynth = new Tone.Synth({ ...settings, oscillator: { type: 'square' } }).toDestination();
                            for (let i = 0; i < 5; i++) {
                                glitchSynth.triggerAttackRelease(Math.random() * 1000 + 500, "32n", now + Math.random() * 0.2);
                            }
                            setTimeout(() => glitchSynth.dispose(), 500);
                            break;
                        case 'tone_heartbeat':
                            const hbSynth = new Tone.MembraneSynth({ ...settings, pitchDecay: 0.2, octaves: 2 }).toDestination();
                            hbSynth.triggerAttackRelease("C2", "8n", now);
                            hbSynth.triggerAttackRelease("C2", "8n", now + 0.3);
                            setTimeout(() => hbSynth.dispose(), 800);
                            break;
                        case 'tone_hyperspace':
                            const hsNoise = new Tone.NoiseSynth({ ...settings, noise: { type: 'white' } }).toDestination();
                            const hsFilter = new Tone.Filter(200, "highpass").toDestination();
                            hsNoise.connect(hsFilter);
                            hsFilter.frequency.rampTo(5000, 0.5, now);
                            hsNoise.triggerAttackRelease("0.5s", now);
                            setTimeout(() => { hsNoise.dispose(); hsFilter.dispose(); }, 1000);
                            break;
                        case 'tone_keyboard':
                            triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.05, sustain: 0 } }, null, "32n");
                            break;
                        case 'tone_kitchen':
                            triggerPolySynth(Tone.MetalSynth, { volume: settings.volume, harmonicity: 15, resonance: 1000, octaves: 1 }, ["C5", "G5", "A5"], "16n");
                            break;
                        case 'tone_mechanical':
                            triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: 'white' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 } }, null, "8n");
                            break;
                        case 'tone_morse':
                            const morseSynth = new Tone.Synth(settings).toDestination();
                            morseSynth.triggerAttackRelease("C5", "32n", now); // S
                            morseSynth.triggerAttackRelease("C5", "32n", now + 0.1);
                            morseSynth.triggerAttackRelease("C5", "32n", now + 0.2);
                            morseSynth.triggerAttackRelease("C5", "16n", now + 0.4); // O
                            morseSynth.triggerAttackRelease("C5", "16n", now + 0.6);
                            morseSynth.triggerAttackRelease("C5", "16n", now + 0.8);
                            morseSynth.triggerAttackRelease("C5", "32n", now + 1.1); // S
                            morseSynth.triggerAttackRelease("C5", "32n", now + 1.2);
                            morseSynth.triggerAttackRelease("C5", "32n", now + 1.3);
                            setTimeout(() => morseSynth.dispose(), 1800);
                            break;
                        case 'tone_ocean':
                            const oceanNoise = new Tone.NoiseSynth({ ...settings, noise: { type: 'brown' } }).toDestination();
                            const oceanFilter = new Tone.AutoFilter("4n").toDestination().start();
                            oceanNoise.connect(oceanFilter);
                            oceanNoise.triggerAttack(now);
                            setTimeout(() => { oceanNoise.dispose(); oceanFilter.dispose(); }, 2000);
                            break;
                        case 'tone_page_turn':
                            triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: 'white' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0 } }, null, "8n");
                            break;
                        case 'tone_power_down':
                            const pdSynth = new Tone.Synth(settings).toDestination();
                            pdSynth.frequency.rampTo("C2", 0.5, now);
                            pdSynth.triggerAttackRelease("C4", "0.5s", now);
                            setTimeout(() => pdSynth.dispose(), 1000);
                            break;
                        case 'tone_purr':
                            const purrNoise = new Tone.NoiseSynth({ ...settings, noise: { type: 'brown' } }).toDestination();
                            const purrLFO = new Tone.LFO("20hz", -15, 0).start();
                            purrLFO.connect(purrNoise.volume);
                            purrNoise.triggerAttack(now);
                            setTimeout(() => { purrNoise.dispose(); purrLFO.dispose(); }, 1500);
                            break;
                        case 'tone_rain_on_window':
                        case 'tone_rainfall':
                             triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: 'pink' }, envelope: { attack: 0.5, decay: 1, sustain: 1, release: 1 } }, null, "2s");
                            break;
                        case 'tone_riser':
                            const riserNoise = new Tone.NoiseSynth({ ...settings, noise: { type: 'white' } }).toDestination();
                            const riserFilter = new Tone.Filter(200, "lowpass").toDestination();
                            riserNoise.connect(riserFilter);
                            riserFilter.frequency.rampTo(5000, 1, now);
                            riserNoise.triggerAttackRelease("1s", now);
                            setTimeout(() => { riserNoise.dispose(); riserFilter.dispose(); }, 1500);
                            break;
                        case 'tone_scanner':
                            const scanSynth = new Tone.Synth(settings).toDestination();
                            const scanLFO = new Tone.LFO("2hz", 400, 1000).start();
                            scanLFO.connect(scanSynth.frequency);
                            scanSynth.triggerAttack(now);
                            setTimeout(() => { scanSynth.dispose(); scanLFO.dispose(); }, 1000);
                            break;
                        case 'tone_singing_bowl':
                        case 'tone_tibetan_bowl':
                             triggerSynth(Tone.MetalSynth, { ...settings, harmonicity: 1.2, resonance: 1200, octaves: 1.5, envelope: { attack: 0.1, decay: 3, release: 0.5 } }, "C3", "3s");
                            break;
                        case 'tone_static':
                            triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: 'white' } }, null, "1s");
                            break;
                        case 'tone_steam_train':
                            const steamSynth = new Tone.NoiseSynth({ ...settings, noise: { type: 'white' }, envelope: { attack: 0.05, decay: 0.2, sustain: 0 } }).toDestination();
                            for (let i = 0; i < 4; i++) {
                                steamSynth.triggerAttack(now + i * 0.3);
                            }
                            setTimeout(() => steamSynth.dispose(), 1500);
                            break;
                        case 'tone_teleporter':
                            const teleSynth = new Tone.FMSynth({ ...settings, modulationIndex: 20 }).toDestination();
                            teleSynth.frequency.rampTo(2000, 0.3, now);
                            teleSynth.triggerAttackRelease("0.3s", now);
                            setTimeout(() => teleSynth.dispose(), 800);
                            break;
                        case 'tone_thunder':
                            triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: 'brown' }, envelope: { attack: 0.1, decay: 2, sustain: 0 } }, null, "2s");
                            break;
                        case 'tone_typewriter':
                            const twSynth = new Tone.PluckSynth({ ...settings, attackNoise: 0.5, dampening: 1000 }).toDestination();
                            twSynth.triggerAttackRelease("C5", "32n", now);
                            setTimeout(() => twSynth.dispose(), 300);
                            break;
                        case 'tone_vibrating_bell':
                            triggerSynth(Tone.MetalSynth, { ...settings, vibratoAmount: 0.5, vibratoRate: 5, envelope: { decay: 2 } }, "C4", "2s");
                            break;
                        case 'tone_vinyl_crackles':
                            triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: 'pink' }, envelope: { attack: 0.2, decay: 1, sustain: 1 } }, null, "2s");
                            break;
                        case 'tone_wind_chimes':
                            triggerPolySynth(Tone.MetalSynth, { volume: settings.volume, harmonicity: 5, resonance: 1000, octaves: 2 }, ["C5", "E5", "G5", "A5", "C6"], "2n");
                            break;
                        case 'tone_wood':
                            triggerSynth(Tone.MembraneSynth, { ...settings, pitchDecay: 0.01, octaves: 1 }, "C3", "16n");
                            break;
                        case 'tone_xylophone':
                            triggerSynth(Tone.PluckSynth, { ...settings, attackNoise: 1, dampening: 7000, resonance: 0.98 }, "C5", "4n");
                            break;
                        case 'tone_zen_garden':
                            triggerSynth(Tone.PluckSynth, { ...settings, attackNoise: 0.1, dampening: 3000, resonance: 0.9, release: 2 }, "C5", "1n");
                            break;
                        
                        // --- Sci-Fi & Ambient ---
                        case 'tone_alien_signal':
                            triggerSynth(Tone.FMSynth, { ...settings, harmonicity: 1.5, modulationIndex: 10, modulation: { type: 'sine' } }, "A4", "1s");
                            break;
                        case 'tone_choir_aah':
                            triggerPolySynth(Tone.AMSynth, { volume: settings.volume, harmonicity: 1.5, envelope: { attack: 0.5, decay: 1, sustain: 0.5, release: 1 } }, ["C4", "E4", "G4"], "2s");
                            break;
                        case 'tone_cosmic_ping':
                            const pingSynth = new Tone.Synth(settings).toDestination();
                            const pingReverb = new Tone.Reverb(2).toDestination();
                            pingSynth.connect(pingReverb);
                            pingSynth.triggerAttackRelease("G5", "16n", now);
                            setTimeout(() => { pingSynth.dispose(); pingReverb.dispose(); }, 2500);
                            break;
                        case 'tone_cosmic_rumble':
                            triggerSynth(Tone.NoiseSynth, { ...settings, noise: { type: 'brown' }, envelope: { attack: 1, decay: 2, sustain: 1 } }, null, "3s");
                            break;
                        case 'tone_crystal':
                            triggerSynth(Tone.PluckSynth, { ...settings, attackNoise: 0.2, dampening: 6000, resonance: 0.98, release: 2 }, "C6", "1n");
                            break;
                        case 'tone_cybernetic':
                            triggerSynth(Tone.FMSynth, { ...settings, harmonicity: 2, modulationIndex: 15, envelope: { attack: 0.1, decay: 0.5 } }, "G3", "1s");
                            break;
                        case 'tone_data_stream':
                            const dsSynth = new Tone.Synth({ ...settings, oscillator: { type: 'square' } }).toDestination();
                            for (let i = 0; i < 8; i++) {
                                dsSynth.triggerAttackRelease(Math.random() * 500 + 800, "32n", now + i * 0.05);
                            }
                            setTimeout(() => dsSynth.dispose(), 800);
                            break;
                        case 'tone_deep_drone':
                            triggerSynth(Tone.Oscillator, { ...settings, frequency: "C2", type: 'sawtooth' }, "C2", "3s");
                            break;
                        case 'tone_dial_up':
                            const dialSynth = new Tone.Synth(settings).toDestination();
                            const dialNoise = new Tone.NoiseSynth({ ...settings, noise: { type: 'white' } }).toDestination();
                            dialSynth.triggerAttackRelease("F5", "0.2s", now);
                            dialSynth.triggerAttackRelease("A5", "0.2s", now + 0.3);
                            dialNoise.triggerAttackRelease("0.5s", now + 0.6);
                            setTimeout(() => { dialSynth.dispose(); dialNoise.dispose(); }, 1500);
                            break;
                        case 'tone_digital_sweep':
                            const sweepSynth = new Tone.Synth(settings).toDestination();
                            sweepSynth.frequency.rampTo(2000, 0.5, now);
                            sweepSynth.triggerAttackRelease("C4", "0.5s", now);
                            setTimeout(() => sweepSynth.dispose(), 1000);
                            break;
                        case 'tone_drone_pulse':
                            const dpSynth = new Tone.AMSynth(settings).toDestination();
                            const dpLFO = new Tone.LFO("2hz", -10, 0).start();
                            dpLFO.connect(dpSynth.volume);
                            dpSynth.triggerAttackRelease("A2", "2s", now);
                            setTimeout(() => { dpSynth.dispose(); dpLFO.dispose(); }, 2500);
                            break;
                        case 'tone_energy_charge':
                            const ecSynth = new Tone.Synth(settings).toDestination();
                            ecSynth.frequency.rampTo("C6", 1, now);
                            ecSynth.triggerAttack("C4", now);
                            ecSynth.triggerRelease(now + 1);
                            setTimeout(() => ecSynth.dispose(), 1500);
                            break;
                        case 'tone_fairy_twinkle':
                            triggerPolySynth(Tone.PluckSynth, { volume: settings.volume, resonance: 0.9 }, ["C6", "E6", "G6", "B6"], "8n");
                            break;
                        case 'tone_forcefield':
                            const ffSynth = new Tone.AMSynth({ ...settings, harmonicity: 5 }).toDestination();
                            const ffLFO = new Tone.LFO("8hz", -20, 0).start();
                            ffLFO.connect(ffSynth.volume);
                            ffSynth.triggerAttackRelease("C4", "2s", now);
                            setTimeout(() => { ffSynth.dispose(); ffLFO.dispose(); }, 2500);
                            break;
                        case 'tone_hologram':
                            const holoSynth = new Tone.FMSynth({ ...settings, harmonicity: 1.5 }).toDestination();
                            const holoFilter = new Tone.AutoFilter("1n").toDestination().start();
                            holoSynth.connect(holoFilter);
                            holoSynth.triggerAttackRelease("C4", "2s", now);
                            setTimeout(() => { holoSynth.dispose(); holoFilter.dispose(); }, 2500);
                            break;
                        case 'tone_modem':
                             const modemSynth = new Tone.FMSynth({ ...settings, harmonicity: 5, modulationIndex: 10 }).toDestination();
                             modemSynth.triggerAttackRelease("A4", "0.5s", now);
                             setTimeout(() => modemSynth.dispose(), 1000);
                            break;
                        case 'tone_ominous_drone':
                            triggerSynth(Tone.AMSynth, { ...settings, harmonicity: 0.5 }, "C2", "3s");
                            break;
                        case 'tone_phase_shift':
                            const psSynth = new Tone.Synth(settings).toDestination();
                            const phaser = new Tone.Phaser({ frequency: 0.5, octaves: 3, baseFrequency: 350 }).toDestination();
                            psSynth.connect(phaser);
                            psSynth.triggerAttackRelease("C4", "2s", now);
                            setTimeout(() => { psSynth.dispose(); phaser.dispose(); }, 2500);
                            break;
                        case 'tone_portal':
                            const portalNoise = new Tone.NoiseSynth({ ...settings, noise: { type: 'pink' } }).toDestination();
                            const portalFilter = new Tone.AutoFilter("0.5s").toDestination().start();
                            portalNoise.connect(portalFilter);
                            portalNoise.triggerAttackRelease("2s", now);
                            setTimeout(() => { portalNoise.dispose(); portalFilter.dispose(); }, 2500);
                            break;
                        case 'tone_sci_fi_pad':
                            triggerPolySynth(Tone.FMSynth, { volume: settings.volume, harmonicity: 0.5, modulationIndex: 2, envelope: { attack: 1, release: 1 } }, ["C3", "G3", "Bb3"], "3s");
                            break;
                        case 'tone_sonar':
                            const sonarSynth = new Tone.Synth(settings).toDestination();
                            const feedbackDelay = new Tone.FeedbackDelay("8n", 0.5).toDestination();
                            sonarSynth.connect(feedbackDelay);
                            sonarSynth.triggerAttackRelease("C5", "16n", now);
                            setTimeout(() => { sonarSynth.dispose(); feedbackDelay.dispose(); }, 1500);
                            break;
                        case 'tone_starship_hum':
                            triggerSynth(Tone.AMSynth, { ...settings, harmonicity: 0.8 }, "A1", "3s");
                            break;

                        default:
                            console.warn(`Sound not found: ${soundId}. Playing default.`);
                            triggerSynth(Tone.Synth, { ...settings, oscillator: { type: 'triangle' } }, "C5", "8n");
                            break;
                    }
                } else {
                    // Fallback for any non-tone sounds (legacy or future additions)
                    const audio = new Audio(soundId);
                    audio.volume = volume;
                    audio.play().catch(error => console.warn(`Could not play sound: ${soundId}. Error: ${error.message}`));
                }
            } catch (e) {
                console.warn("Error playing sound:", e);
            }
        }


        function unlockAudio() {
            if (isAudioUnlocked) return;
            // Attempt to start Tone.js audio context
            Tone.start().then(() => {
                isAudioUnlocked = true;
                console.log("Tone.js audio context started.");
            }).catch(e => console.warn("Tone.js audio context failed to start:", e));

            // Also play a silent audio for broader browser compatibility
            const silentAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=');
            silentAudio.play().then(() => {
                // This part might not be strictly necessary if Tone.start() is successful,
                // but it's a robust fallback for general audio unlock.
            }).catch(e => console.warn("Silent audio unlock failed.", e));
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                       container.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        function showConfirmationModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            modal.querySelector('#confirmation-modal-title').textContent = title;
            modal.querySelector('#confirmation-modal-message').textContent = message;
            modal.classList.add('active');

            const confirmBtn = modal.querySelector('#confirm-btn');
            const cancelBtn = modal.querySelector('#cancel-btn');
            const closeModalBtns = modal.querySelectorAll('.close-modal');

            const cleanup = () => {
                modal.classList.remove('active');
                confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
            };

            confirmBtn.onclick = () => {
                onConfirm();
                cleanup();
            };
            cancelBtn.onclick = cleanup;
            closeModalBtns.forEach(btn => btn.onclick = cleanup);
        }

        function resetAndShowAddSubjectModal() {
            const modal = document.getElementById('add-subject-modal');
            modal.classList.add('active');
            
            document.getElementById('add-subject-form').reset();
            document.getElementById('edit-subject-id').value = ''; 
            document.getElementById('add-subject-modal-title').textContent = 'Add New Subject';
            document.getElementById('add-subject-submit-btn').textContent = 'Add Subject';
            
            const colorPicker = modal.querySelector('.subject-color-picker');
            if (colorPicker) {
                colorPicker.querySelectorAll('.color-dot').forEach(el => el.classList.remove('selected'));
                const defaultColor = colorPicker.querySelector('[data-color="bg-blue-500"]');
                if (defaultColor) defaultColor.classList.add('selected');
            }
        }

        async function showUserProfileModal(userId) {
            if (!userId) return;

            const modal = document.getElementById('user-profile-modal');
            const loadingEl = document.getElementById('user-profile-loading');
            const detailsEl = document.getElementById('user-profile-details');

            modal.classList.add('active');
            loadingEl.classList.remove('hidden');
            detailsEl.classList.add('hidden');

            try {
                const [profileData, privateData, lastSession] = await Promise.all([
                    fetchProfile(userId),
                    fetchUserPrivate(userId),
                    fetchLatestSession(userId)
                ]);

                if (!profileData) {
                    throw new Error('User data not found.');
                }

                const todayStr = getCurrentDate().toISOString().split('T')[0];
                const totalTodaySource = profileData.total_time_today || privateData?.total_time_today || null;
                const totalTodaySeconds = (totalTodaySource && totalTodaySource.date === todayStr)
                    ? (totalTodaySource.seconds || 0)
                    : 0;

                let lastActiveText = 'No sessions yet';
                if (lastSession?.endedAt) {
                    const endedAt = new Date(lastSession.endedAt);
                    if (!isNaN(endedAt)) {
                        lastActiveText = `${timeSince(endedAt)} ago`;
                    }
                }

                const avatarEl = document.getElementById('user-profile-avatar');
                if (profileData.photo_url) {
                    avatarEl.innerHTML = `<img src="${profileData.photo_url}" alt="${profileData.username}" class="w-full h-full object-cover">`;
                } else {
                    const initial = profileData.username ? profileData.username.charAt(0).toUpperCase() : 'U';
                    avatarEl.innerHTML = `<span>${initial}</span>`;
                }

                document.getElementById('user-profile-name').textContent = profileData.username || 'Anonymous';
                document.getElementById('user-profile-total-today').textContent = formatTime(totalTodaySeconds);
                document.getElementById('user-profile-total-overall').textContent = formatTime(profileData.total_study_seconds || 0, false);
                document.getElementById('user-profile-last-active').textContent = lastActiveText;

                loadingEl.classList.add('hidden');
                detailsEl.classList.remove('hidden');

            } catch (error) {
                console.error('Error fetching user profile:', error);
                modal.classList.remove('active');
                showToast('Could not load user profile.', 'error');
            }
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            if (!pageId) return;
            
            if (pageId === 'page-planner') {
                plannerState.calendarYear = new Date().getFullYear();
                plannerState.calendarMonth = new Date().getMonth();
            }

            if (pageId !== 'page-group-detail') {
                groupDetailUnsubscribers.forEach(unsub => unsub());
                groupDetailUnsubscribers = [];
                memberTimerIntervals.forEach(clearInterval);
                memberTimerIntervals = [];
                groupRealtimeData = { members: {}, sessions: {} };
            }

            document.getElementById('auth-screen').classList.remove('active');
            document.getElementById('app-container').classList.remove('active', 'flex');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            if (pageId.startsWith('page-')) {
                 document.getElementById('app-container').classList.add('active', 'flex');
                 const targetPage = document.getElementById(pageId);
                 if(targetPage) targetPage.classList.add('active');
            } else {
                 const targetScreen = document.getElementById(pageId);
                 if(targetScreen) targetScreen.classList.add('active');
            }
            
            const mainNav = document.getElementById('main-nav');
            const groupNav = document.getElementById('group-detail-nav');
            const mainNavPages = ['page-timer', 'page-stats', 'page-ranking', 'page-planner'];

            mainNav.style.display = 'none';
            if (groupNav) groupNav.style.display = 'none';

            if (mainNavPages.includes(pageId)) {
                mainNav.style.display = 'grid';
            } else if (pageId === 'page-group-detail') {
                if (groupNav) groupNav.style.display = 'grid';
            }
            
            if (pageId === 'page-stats') {
                renderStatsPage(userSessions);
            }
        }

        function formatTime(seconds, includeSeconds = true) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            
            if (includeSeconds) {
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
            const hDisplay = h > 0 ? `${h}h ` : '';
            return `${hDisplay}${m}m`;
        }

        function formatPomodoroTime(seconds) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        async function startTimer(subject) {
            if (!subject) {
                showToast("Please select a subject first.", "error");
                return;
            }
            unlockAudio();

            // Stop and save any active break session before starting a new study session
            if (breakTimerInterval) {
                clearInterval(breakTimerInterval);
                const elapsedBreakSeconds = Math.floor((Date.now() - breakStartTime) / 1000);
                if (elapsedBreakSeconds > 0) {
                    await saveSession('Break', elapsedBreakSeconds, 'break'); // Save break session
                }
                breakTimerInterval = null;
                breakStartTime = 0;
            }
            // Clear break status from UI
            pomodoroStatusDisplay.textContent = ''; // Clear the "On Break" status

            // --- New: Check and save idle time before starting a new study session ---
            if (currentUser) {
                const lastSession = await fetchLatestSession(currentUser.id);
                if (lastSession?.endedAt && lastSession.type === 'study') {
                    const endedAt = new Date(lastSession.endedAt);
                    const now = Date.now();
                    if (!isNaN(endedAt) && endedAt.getTime() < now) {
                        const idleDurationSeconds = Math.floor((now - endedAt.getTime()) / 1000);
                        if (idleDurationSeconds > 0) {
                            await saveSession('Idle Break', idleDurationSeconds, 'break');
                        }
                    }
                }
            }
            // --- End New idle time tracking ---


            activeSubject = subject;
            activeSubjectDisplay.textContent = activeSubject;
            
            if(timerInterval) clearInterval(timerInterval);

            if (timerMode === 'normal') {
                sessionStartTime = Date.now();
                timerInterval = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - sessionStartTime) / 1000);
                    sessionTimerDisplay.textContent = formatTime(elapsedSeconds);
                }, 1000);
            } else { // Pomodoro Mode
                pomodoroState = 'work';
                playSound(pomodoroSounds.start, pomodoroSounds.volume);
                
                const workDurationSeconds = pomodoroSettings.work * 60;
                pomodoroWorker.postMessage({ command: 'start', duration: workDurationSeconds });
                
                // Use the new reliable SW alarm
                await triggerServerNotification({
        title: 'Focus complete!',
        options: { body: `Time for a short break.`, tag: 'pomodoro-transition' }, // Options for the FCM notification
        newState: 'short_break',
        oldState: 'work',
    });

                pomodoroStatusDisplay.textContent = `Work (1/${pomodoroSettings.long_break_interval})`;
                pomodoroStatusDisplay.style.color = '#3b82f6';
            }

            document.getElementById('start-studying-btn').classList.add('hidden');
            document.getElementById('stop-studying-btn').classList.remove('hidden');
            document.getElementById('pause-btn').classList.remove('hidden');
            document.getElementById('manual-start-btn').classList.add('hidden');

            if (currentUser) {
                await updateUserPrivate(currentUser.id, { studying: { subject: activeSubject, startTime: nowIso(), type: 'study' } });
            }
        }
        
        async function stopTimer() {
            // Stop the UI timer in the web worker
            pomodoroWorker.postMessage({ command: 'stop' });

            // --- ADD THIS BLOCK TO RESET PAUSE STATE ---
            isPaused = false;
            pauseStartTime = 0;
            // --- END OF ADDED BLOCK ---

            // If a Pomodoro session was running, save any partial time and cancel the background alarm
            if (timerMode === 'pomodoro' && pomodoroState !== 'idle') {
                const workDuration = pomodoroSettings.work * 60;
                // Calculate elapsed time based on what's left on the display
                const displayTime = sessionTimerDisplay.textContent;
                const timeLeftInSeconds = (parseInt(displayTime.split(':')[0], 10) * 60) + parseInt(displayTime.split(':')[1], 10);
                const elapsedSeconds = workDuration - timeLeftInSeconds;
                
                if (pomodoroState === 'work' && elapsedSeconds > 0) {
                    await saveSession(activeSubject, elapsedSeconds, 'study');
                }
            }
            // If a normal timer was running, stop it and save the session
            else if (timerMode === 'normal' && timerInterval) {
                clearInterval(timerInterval);
                const elapsedMillis = Date.now() - sessionStartTime;
                const sessionDurationSeconds = Math.floor(elapsedMillis / 1000);
                if (sessionDurationSeconds > 0) {
                    await saveSession(activeSubject, sessionDurationSeconds, 'study');
                }
            }
            
            // Reset all timer-related state variables and UI elements
            timerInterval = null;
            pomodoroState = 'idle';
            activeSubjectDisplay.textContent = '';
            sessionTimerDisplay.textContent = timerMode === 'pomodoro' ? formatPomodoroTime(pomodoroSettings.work * 60) : formatTime(0);
            pomodoroStatusDisplay.textContent = timerMode === 'pomodoro' ? 'Ready for Pomodoro' : '';
            pomodoroStatusDisplay.style.color = '#9ca3af';

            // Reset button visibility
            document.getElementById('start-studying-btn').classList.remove('hidden');
            document.getElementById('stop-studying-btn').classList.add('hidden');
            // --- ADD THESE 2 LINES TO HIDE PAUSE/RESUME ---
            document.getElementById('pause-btn').classList.add('hidden');
            document.getElementById('resume-btn').classList.add('hidden');
            // --- END OF ADDED LINES ---
            document.getElementById('manual-start-btn').classList.add('hidden');

            // Update user status in Supabase to show they are no longer studying
            if (currentUser) {
                await updateUserPrivate(currentUser.id, { studying: null });
            }
        }
        
        function pauseTimer() {
            if (timerMode === 'normal' && timerInterval) {
                clearInterval(timerInterval);
                isPaused = true;
                pauseStartTime = Date.now();
                document.getElementById('pause-btn').classList.add('hidden');
                document.getElementById('resume-btn').classList.remove('hidden');
            } else if (timerMode === 'pomodoro' && !isPaused) {
                pomodoroWorker.postMessage({ command: 'pause' });
                isPaused = true;
                document.getElementById('pause-btn').classList.add('hidden');
                document.getElementById('resume-btn').classList.remove('hidden');
            }
        }
        
        function resumeTimer() {
            if (timerMode === 'normal' && isPaused) {
                const pauseDuration = Date.now() - pauseStartTime;
                sessionStartTime += pauseDuration;
                timerInterval = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - sessionStartTime) / 1000);
                    sessionTimerDisplay.textContent = formatTime(elapsedSeconds);
                }, 1000);
                isPaused = false;
                pauseStartTime = 0;
                document.getElementById('pause-btn').classList.remove('hidden');
                document.getElementById('resume-btn').classList.add('hidden');
            } else if (timerMode === 'pomodoro' && isPaused) {
                pomodoroWorker.postMessage({ command: 'resume' });
                isPaused = false;
                document.getElementById('pause-btn').classList.remove('hidden');
                document.getElementById('resume-btn').classList.add('hidden');
            }
        }

        // --- NEW: Helper to start the next Pomodoro phase ---
        async function startNextPomodoroPhase(state) {
            pomodoroState = state;
            
            let durationSeconds = 0;
            let statusText = '';
            let transitionMessage = {};

            const currentCycle = Math.floor((currentUserData.pomodoroCycle || 0) / 2);
            
            if (state === 'work') {
                durationSeconds = pomodoroSettings.work * 60;
                const nextState = ((currentCycle + 1) % pomodoroSettings.long_break_interval === 0) ? 'long_break' : 'short_break';
                statusText = `Work (${currentCycle + 1}/${pomodoroSettings.long_break_interval})`;
                transitionMessage = {
                    type: 'TIMER_ENDED',
                    newState: nextState,
                    oldState: 'work',
                    title: 'Focus complete!',
                    options: { body: `Time for a ${nextState.replace('_', ' ')}.`, tag: 'pomodoro-transition' }
                };
            } else { // It's a break
                durationSeconds = state === 'short_break' ? pomodoroSettings.short_break * 60 : pomodoroSettings.long_break * 60;
                statusText = state.replace('_', ' ');
                transitionMessage = {
                    type: 'TIMER_ENDED',
                    newState: 'work',
                    oldState: state,
                    title: 'Break is over!',
                    options: { body: 'Time to get back to focus.', tag: 'pomodoro-transition' }
                };
            }
            
            // Start the UI timer
            pomodoroWorker.postMessage({ command: 'start', duration: durationSeconds });
            pomodoroStatusDisplay.textContent = statusText;
            pomodoroStatusDisplay.style.color = state.includes('break') ? '#f59e0b' : '#3b82f6';

            await triggerServerNotification(transitionMessage);

            // Update cycle in Supabase only after a break is completed (meaning a work session is starting)
            if (state === 'work') {
                const newCycleCount = (currentUserData.pomodoroCycle || 0) + 1;
                if (currentUser) {
                    await updateUserPrivate(currentUser.id, { pomodoroCycle: newCycleCount });
                }
            }
        }

        function updateBreakTimerDisplay() {
            if (breakStartTime === 0) return;
            const elapsedSeconds = Math.floor((Date.now() - breakStartTime) / 1000);
            sessionTimerDisplay.textContent = formatTime(elapsedSeconds); // Show break time on main timer display
            pomodoroStatusDisplay.textContent = 'On Break'; // Indicate break status
            pomodoroStatusDisplay.style.color = '#f59e0b'; // Break color
        }
        
        function updateTotalTimeDisplay() {
            totalTimeDisplay.textContent = `Total Today: ${formatTime(totalTimeTodayInSeconds)}`;
            totalBreakTimeDisplay.textContent = `Total Break: ${formatTime(totalBreakTimeTodayInSeconds)}`;
        }

        async function saveSession(subject, durationSeconds, sessionType = 'study') { // Default to 'study'
            if (!currentUser || durationSeconds <= 0) {
                return;
            }

            // --- START: ADDED GUEST LOGIC ---
            // For anonymous users, just update local state without saving to Supabase
            if (currentUser.isAnonymous) {
                if (sessionType === 'study') {
                    totalTimeTodayInSeconds += durationSeconds;
                } else {
                    totalBreakTimeTodayInSeconds += durationSeconds;
                }
                updateTotalTimeDisplay();
                showToast(`Session of ${formatTime(durationSeconds, false)} saved locally! Sign up to save your progress.`, "success", 4000);
                return;
            }
            // --- END: ADDED GUEST LOGIC ---

            const MAX_BREAK_SECONDS = 3 * 3600; // 3 hours in seconds
            const cappedDuration = (sessionType === 'break' && durationSeconds > MAX_BREAK_SECONDS) ? MAX_BREAK_SECONDS : durationSeconds;

            try {
                // Fetch current profile
                const { data: userData, error: fetchErr } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                if (fetchErr) throw fetchErr;

                const todayStr = new Date().toISOString().split('T')[0];
                const profileUpdate = {};

                if (sessionType === 'study') {
                    const yesterdayStr = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                    const lastStudyDay = userData.last_study_day || '';
                    let currentStreak = userData.current_streak || 0;
                    if (lastStudyDay !== todayStr) {
                        currentStreak = (lastStudyDay === yesterdayStr) ? currentStreak + 1 : 1;
                        profileUpdate.current_streak = currentStreak;
                        profileUpdate.last_study_day = todayStr;
                    }

                    const currentDailyStudy = (userData.total_time_today?.date === todayStr) ? userData.total_time_today.seconds : 0;
                    profileUpdate.total_study_seconds = (userData.total_study_seconds || 0) + cappedDuration;
                    profileUpdate.total_time_today = { date: todayStr, seconds: currentDailyStudy + cappedDuration };
                    totalTimeTodayInSeconds = currentDailyStudy + cappedDuration;
                } else { // 'break'
                    const currentDailyBreak = (userData.total_break_time_today?.date === todayStr) ? userData.total_break_time_today.seconds : 0;
                    profileUpdate.total_break_seconds = (userData.total_break_seconds || 0) + cappedDuration;
                    profileUpdate.total_break_time_today = { date: todayStr, seconds: currentDailyBreak + cappedDuration };
                    totalBreakTimeTodayInSeconds = currentDailyBreak + cappedDuration;
                }

                // Update profile totals
                await supabase
                    .from('profiles')
                    .update(profileUpdate)
                    .eq('id', currentUser.id);

                // Log session
                await supabase.from('sessions').insert({
                    profile_id: currentUser.id,
                    subject: subject,
                    durationSeconds: cappedDuration,
                    endedAt: new Date().toISOString(),
                    type: sessionType
                });

                // Update UI and check for achievements
                updateTotalTimeDisplay();
                showToast(`Session of ${formatTime(cappedDuration, false)} saved!`, "success");
                if (sessionType === 'study') {
                    await checkAndAwardAchievements(cappedDuration);
                }

            } catch (error) {
                console.error("Error saving session: ", error);
                showToast("Error saving session.", "error");
            }
        }
        async function checkAndAwardAchievements(completedSessionDuration) {
    if (!currentUser) return;

    try {
        const profile = await fetchProfile(currentUser.id);
        if (!profile) return;

        const unlocked = Array.isArray(profile.unlocked_achievements) ? profile.unlocked_achievements : [];
        const totalStudySeconds = profile.total_study_seconds || 0;
        const currentStreak = profile.current_streak || 0;
        const updated = new Set(unlocked);

        if (!updated.has('novice_scholar') && totalStudySeconds >= 3600) {
            updated.add('novice_scholar');
        }
        if (!updated.has('dedicated_learner') && totalStudySeconds >= 36000) {
            updated.add('dedicated_learner');
        }
        if (!updated.has('marathoner') && completedSessionDuration >= 7200) {
            updated.add('marathoner');
        }
        if (!updated.has('consistent_coder') && currentStreak >= 7) {
            updated.add('consistent_coder');
        }

        const newlyUnlocked = Array.from(updated).filter(a => !unlocked.includes(a));
        if (newlyUnlocked.length > 0) {
            await updateProfile(currentUser.id, { unlocked_achievements: Array.from(updated) });
            const achievement = ACHIEVEMENTS[newlyUnlocked[0]];
            showToast(`Achievement Unlocked: ${achievement.name}!`, 'success');
        }
    } catch (error) {
        console.error('Error checking achievements:', error);
    }
}

        async function loadDailyTotal() {
            if (!currentUser) return;

            // --- START: ADDED GUEST LOGIC ---
            if (currentUser.isAnonymous) {
                totalTimeTodayInSeconds = 0;
                totalBreakTimeTodayInSeconds = 0;
                updateTotalTimeDisplay();
                return;
            }
            // --- END: ADDED GUEST LOGIC ---

            const profile = await fetchProfile(currentUser.id);
            const todayStr = getCurrentDate().toISOString().split('T')[0];

            totalTimeTodayInSeconds = 0;
            totalBreakTimeTodayInSeconds = 0;

            if (profile) {
                const studyToday = profile.total_time_today;
                if (studyToday && studyToday.date === todayStr) {
                    totalTimeTodayInSeconds = studyToday.seconds || 0;
                }

                const breakToday = profile.total_break_time_today;
                if (breakToday && breakToday.date === todayStr) {
                    totalBreakTimeTodayInSeconds = breakToday.seconds || 0;
                }
            }
            if(totalTimeDisplay && totalBreakTimeDisplay) { // Should refer to the HTML element
                updateTotalTimeDisplay();
            }
        }

        function updateProfileUI(userData) {
            // --- START: MODIFIED PROFILE UI LOGIC ---
            const profileAuthView = document.getElementById('profile-authenticated-view');
            const profileAnonView = document.getElementById('profile-anonymous-view');
            const headerAvatar = document.getElementById('header-avatar');

            if (!userData || (currentUser && currentUser.isAnonymous)) {
                // Show guest view
                if(profileAuthView) profileAuthView.classList.add('hidden');
                if(profileAnonView) profileAnonView.classList.remove('hidden');
                if(headerAvatar) headerAvatar.innerHTML = `<i class="fas fa-user-secret text-xl"></i>`;
                return;
            }

            // Show authenticated view
            if(profileAuthView) profileAuthView.classList.remove('hidden');
            if(profileAnonView) profileAnonView.classList.add('hidden');
            // --- END: MODIFIED PROFILE UI LOGIC ---

            currentUserData = userData; 
            const username = userData.username || 'Anonymous';
            const email = userData.email || '';
            const photoURL = userData.photo_url;
            const studyGoal = userData.study_goal_hours;

            document.getElementById('profile-page-name').textContent = username;
            document.getElementById('profile-page-email').textContent = email;
            
            const profileAvatar = document.getElementById('profile-page-avatar');
            
            // FIX: Make avatar updates more robust by checking if elements exist.
            // This prevents a crash if the UI updates while the user is navigating.
            [headerAvatar, profileAvatar].forEach(el => {
                if (el) { // Only update if the element is found in the DOM
                    if (photoURL) {
                        const imageUrlWithCacheBuster = `${photoURL.split('?')[0]}?t=${new Date().getTime()}`;
                        el.innerHTML = `<img src="${imageUrlWithCacheBuster}" alt="${username}" class="w-full h-full object-cover">`;
                    } else {
                        const initial = username ? username.charAt(0).toUpperCase() : 'U';
                        el.innerHTML = `<span>${initial}</span>`;
                    }
                }
            });
            
            const studyGoalValueEl = document.getElementById('study-goal-value');
            if (studyGoal) {
                studyGoalValueEl.textContent = `${studyGoal} hours/day`;
            } else {
                studyGoalValueEl.textContent = 'Not set';
            }
            const streakDisplay = document.getElementById('profile-streak-display');
if (streakDisplay) {
    const streak = userData.current_streak || 0;
    streakDisplay.textContent = `${streak} day${streak === 1 ? '' : 's'}`;
}

const achievementsGrid = document.getElementById('achievements-grid');
if (achievementsGrid) {
    const unlocked = userData.unlocked_achievements || [];
    achievementsGrid.innerHTML = Object.keys(ACHIEVEMENTS).map(key => {
        const hasUnlocked = unlocked.includes(key);
        const achievement = ACHIEVEMENTS[key];
        return `
            <div class="p-2 ${hasUnlocked ? 'opacity-100' : 'opacity-30'}" title="${achievement.name}: ${achievement.description}">
                <i class="fas fa-trophy text-4xl ${hasUnlocked ? 'text-yellow-400' : 'text-gray-500'}"></i>
                <p class="text-xs mt-1 font-semibold">${achievement.name}</p>
            </div>
        `;
    }).join('');
}
        }

        function setupRealtimeListeners() {
            if (!currentUser) return;

            // Profile updates
            supabase.channel('profiles-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'profiles',
                    filter: `id=eq.${currentUser.id}`
                }, () => loadMyProfile())
                .subscribe();

            // Subjects
            supabase.channel('subjects-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'subjects',
                    filter: `profile_id=eq.${currentUser.id}`
                }, () => loadSubjects())
                .subscribe();
            loadSubjects();

            // Sessions
            supabase.channel('sessions-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'sessions',
                    filter: `profile_id=eq.${currentUser.id}`
                }, () => loadSessions())
                .subscribe();
            loadSessions();

            // --- NEW PLANNER LISTENERS ---
            setupPlannerListeners();
        }

        async function loadSubjects() {
            if (!currentUser) return;
            const { data, error } = await supabase
                .from('subjects')
                .select('*')
                .eq('profile_id', currentUser.id)
                .order('order');
            if (error) {
                console.error('Failed to load subjects', error);
                return;
            }
            renderSubjectSelectionList(data || []);
        }

        async function loadSessions() {
            if (!currentUser) return;
            const { data, error } = await supabase
                .from('sessions')
                .select('*')
                .eq('profile_id', currentUser.id)
                .order('endedAt', { ascending: false });
            if (error) {
                console.error('Failed to load sessions', error);
                return;
            }
            userSessions = (data || []).map(s => {
                if (!s.endedAt) return null; // Skip sessions that somehow have no end date
                const endedAtDate = new Date(s.endedAt);
                // Check if the date is valid. An invalid date's time is NaN.
                if (isNaN(endedAtDate.getTime())) {
                    console.warn('Skipping session with invalid endedAt date:', s);
                    return null;
                }
                return {
                    id: s.id,
                    subject: s.subject,
                    durationSeconds: s.durationSeconds,
                    endedAt: endedAtDate,
                    type: s.type || 'study'
                };
            }).filter(Boolean); // Filter out any null entries from invalid dates
            
            if (document.getElementById('page-stats').classList.contains('active')) {
                renderStatsPage(userSessions);
            }
            if (document.getElementById('page-ranking').classList.contains('active')) {
                const activeTab = document.querySelector('#ranking-period-tabs .ranking-tab-btn.active');
                renderLeaderboard(activeTab ? activeTab.dataset.period : 'weekly');
            }
        }
        
        // =================================================================================
        // ============================ NEW PLANNER LOGIC START ============================
        // =================================================================================

        let plannerState = {
            lists: [],
            tasks: [],
            activeListId: 'inbox',
            selectedTaskId: null,
            currentView: 'list', // 'list', 'board', 'calendar'
            activeCategory: 'list', // 'list', 'today', 'tomorrow', 'thisweek', etc.
            showCompletedInCategory: false,
            plannerUnsubscribers: [],
            calendarYear: new Date().getFullYear(),
            calendarMonth: new Date().getMonth(),
        };
        
        async function setupPlannerListeners() {
            if (!currentUser || !isValidUUID(currentUser.id)) return;
          
            // 1. Stop old subscriptions
            plannerState.plannerUnsubscribers.forEach(unsub => unsub());
            plannerState.plannerUnsubscribers = [];
          
            // 2. Initial fetch of lists
            const { data: lists, error: listsError } = await supabase
              .from('lists')
              .select('*')
              .eq('created_by', currentUser.id)   // or whichever column marks ownership
            if (listsError) {
              console.error('Failed to load lists:', listsError);
            } else {
              plannerState.lists = lists || [];
              renderPlannerPage();
            }
          
            // 3. Initial fetch of tasks
            const { data: tasks, error: tasksError } = await supabase
              .from('tasks')
              .select('*')
              .eq('created_by', currentUser.id)
            if (tasksError) {
              console.error('Failed to load tasks:', tasksError);
            } else {
              plannerState.tasks = tasks || [];
              renderPlannerPage();
            }
          
            // 4. Realtime subscription for lists
            const listsSub = supabase
              .channel('lists-changes')
              .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'lists' },
                async (payload) => {
                  console.log('List change:', payload);
                  // simplest: refetch fresh data
                  const { data, error } = await supabase
                    .from('lists')
                    .select('*')
                    .eq('created_by', currentUser.id)
                  if (!error) {
                    plannerState.lists = data || [];
                    renderPlannerPage();
                  }
                }
              )
              .subscribe();
          
            // 5. Realtime subscription for tasks
            const tasksSub = supabase
              .channel('tasks-changes')
              .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'tasks' },
                async (payload) => {
                  console.log('Task change:', payload);
                  const { data, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .eq('created_by', currentUser.id)
                  if (!error) {
                    plannerState.tasks = data || [];
                    renderPlannerPage();
                  }
                }
              )
              .subscribe();
          
            // 6. Save unsubscribers
            plannerState.plannerUnsubscribers = [
              () => supabase.removeChannel(listsSub),
              () => supabase.removeChannel(tasksSub),
            ];
          }
          

        function renderPlannerPage() {
            if (!document.getElementById('page-planner').classList.contains('active')) return;

            renderPlannerSidebar();
            renderPlannerMainContent();
            renderPlannerTaskDetails();
        }

        function renderPlannerSidebar() {
            const sidebar = document.getElementById('planner-sidebar');
            if (!sidebar) return;
          
            const inboxTasks = plannerState.tasks.filter(t => t.list_id === null && !t.completed).length;
          
            sidebar.innerHTML = `
              <div id="planner-sidebar-header">
                <h2 class="text-lg font-bold">Projects</h2>
                <button id="add-list-btn" class="p-1 rounded-full hover:bg-gray-700"><i class="fas fa-plus"></i></button>
              </div>
              <nav class="flex-grow space-y-1">
                <div class="planner-sidebar-item ${plannerState.activeListId === 'inbox' ? 'active' : ''}" data-list-id="inbox">
                  <i class="fas fa-inbox w-5 mr-3"></i>
                  <span class="flex-grow">Inbox</span>
                  <span class="text-xs bg-gray-600 px-2 py-0.5 rounded-full">${inboxTasks}</span>
                </div>
                ${plannerState.lists.map(list => {
                  const taskCount = plannerState.tasks.filter(t => t.list_id === list.id && !t.completed).length;
                  return `
                    <div class="planner-sidebar-item ${plannerState.activeListId === list.id ? 'active' : ''}" data-list-id="${list.id}">
                      <i class="fas fa-folder w-5 mr-3"></i>
                      <span class="flex-grow">${list.name}</span>
                      <span class="text-xs bg-gray-600 px-2 py-0.5 rounded-full">${taskCount}</span>
                    </div>
                  `;
                }).join('')}
              </nav>
            `;
          }          

          function renderPlannerMainContent() {
            const mainContent = document.getElementById('planner-main-content');
            if (!mainContent) return;
          
            const activeList = plannerState.activeListId === 'inbox'
              ? { id: 'inbox', name: 'Inbox' }
              : plannerState.lists.find(l => l.id === plannerState.activeListId);
          
            document.getElementById('planner-header-title').textContent = activeList?.name || 'Planner';
          
            document.querySelectorAll('.planner-view-btn').forEach(btn => {
              btn.classList.toggle('bg-blue-600', btn.dataset.view === plannerState.currentView);
              btn.classList.toggle('text-white', btn.dataset.view === plannerState.currentView);
            });
          
            const tasksForCurrentList = plannerState.tasks.filter(t => {
              if (plannerState.activeListId === 'inbox') {
                return t.list_id === null;
              }
              return t.list_id === plannerState.activeListId;
            });
          
            const sidebar = document.getElementById('planner-sidebar');
            const detailsPanel = document.getElementById('planner-task-details');
          
            if (sidebar) sidebar.style.display = '';
            mainContent.style.padding = '';
            if (detailsPanel) detailsPanel.classList.add('hidden');
          
            switch (plannerState.currentView) {
              case 'list':
                if (sidebar) sidebar.style.display = 'none';
                if (detailsPanel) detailsPanel.classList.add('hidden');
                mainContent.style.padding = '0';
          
                if (plannerState.activeCategory && plannerState.activeCategory !== 'list') {
                  renderPlannerCategoryView(plannerState.activeCategory);
                } else {
                  document.getElementById('planner-header-title').textContent = 'Planner';
                  renderPlannerListView(plannerState.tasks);
                }
                break;
              case 'board':
                renderPlannerBoardView(tasksForCurrentList);
                break;
              case 'calendar':
                renderPlannerCalendarView(tasksForCurrentList);
                break;
            }
          }          
        
          function renderPlannerListView(allTasks) {
            const mainContent = document.getElementById('planner-main-content');
          
            const today = new Date(); today.setHours(0,0,0,0);
            const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
          
            const startOfWeek = new Date(today);
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            startOfWeek.setDate(diff);
          
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23,59,59,999);
          
            const isSameDay = (d1, d2) =>
              d1.getFullYear() === d2.getFullYear() &&
              d1.getMonth() === d2.getMonth() &&
              d1.getDate() === d2.getDate();
          
            const todayTasks = allTasks.filter(t => t.due_date && isSameDay(new Date(t.due_date), today) && !t.completed);
            const tomorrowTasks = allTasks.filter(t => t.due_date && isSameDay(new Date(t.due_date), tomorrow) && !t.completed);
            const thisWeekTasks = allTasks.filter(t => {
              if (!t.due_date || t.completed) return false;
              const taskDate = new Date(t.due_date);
              return taskDate >= startOfWeek && taskDate <= endOfWeek;
            });
            const plannedTasks = allTasks.filter(t => t.due_date && !t.completed);
            const completedTasks = allTasks.filter(t => t.completed);
            const inboxTasks = allTasks.filter(t => t.list_id === null && !t.completed);
          
            const categories = [
              { name: 'Today', icon: 'fa-sun', color: 'bg-yellow-500', count: todayTasks.length },
              { name: 'Tomorrow', icon: 'fa-cloud-sun', color: 'bg-orange-400', count: tomorrowTasks.length },
              { name: 'This Week', icon: 'fa-calendar-week', color: 'bg-purple-500', count: thisWeekTasks.length },
              { name: 'Planned', icon: 'fa-calendar-alt', color: 'bg-blue-500', count: plannedTasks.length },
              { name: 'Events', icon: 'fa-calendar-star', color: 'bg-green-500', count: 0 },
              { name: 'Completed', icon: 'fa-check-circle', color: 'bg-gray-500', count: completedTasks.length },
              { name: 'Tasks', icon: 'fa-tasks', color: 'bg-indigo-500', count: inboxTasks.length },
            ];
          
            mainContent.innerHTML = `
              <div id="planner-list-view-container">
                <div class="planner-search-bar">
                  <i class="fas fa-search"></i>
                  <input type="text" placeholder="Search">
                </div>
                <div class="planner-list-section no-scrollbar">
                  ${categories.map(cat => `
                    <div class="planner-list-item" data-category="${cat.name.toLowerCase()}">
                      <div class="icon ${cat.color}"><i class="fas ${cat.icon}"></i></div>
                      <span class="text">${cat.name}</span>
                      <div class="counts">${cat.count}</div>
                    </div>
                  `).join('')}
                </div>
                <div class="planner-actions">
                  <button class="planner-add-project-btn">
                    <i class="fas fa-plus-circle"></i>
                    <span>Add Project</span>
                  </button>
                  <div class="action-icons">
                    <i class="fas fa-flag"></i>
                    <i class="fas fa-folder-open"></i>
                  </div>
                </div>
              </div>
            `;
          }          

          function renderPlannerCategoryView(category) {
            const mainContent = document.getElementById('planner-main-content');
            const allTasks = plannerState.tasks;
            let tasksToShow = [];
            let title = category.charAt(0).toUpperCase() + category.slice(1);
          
            const today = new Date(); today.setHours(0,0,0,0);
            const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
            const isSameDay = (d1, d2) =>
              d1.getFullYear() === d2.getFullYear() &&
              d1.getMonth() === d2.getMonth() &&
              d1.getDate() === d2.getDate();
          
            switch (category) {
              case 'today':
                tasksToShow = allTasks.filter(t => t.due_date && isSameDay(new Date(t.due_date), today));
                break;
              case 'tomorrow':
                tasksToShow = allTasks.filter(t => t.due_date && isSameDay(new Date(t.due_date), tomorrow));
                break;
              case 'this week':
                title = 'This Week';
                const startOfWeek = new Date(today);
                const dayOfWeek = today.getDay();
                const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                startOfWeek.setDate(diff);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23,59,59,999);
                tasksToShow = allTasks.filter(t => {
                  if (!t.due_date) return false;
                  const taskDate = new Date(t.due_date);
                  return taskDate >= startOfWeek && taskDate <= endOfWeek;
                });
                break;
              case 'planned':
                tasksToShow = allTasks.filter(t => t.due_date && !t.completed);
                break;
              case 'completed':
                tasksToShow = allTasks.filter(t => t.completed);
                break;
              case 'events':
                tasksToShow = [];
                break;
            }          

            // --- 2. Calculate Stats ---
            const uncompletedTasks = tasksToShow.filter(t => !t.completed);
            const tasksToBeCompletedCount = uncompletedTasks.length;
            const completedTasks = tasksToShow.filter(t => t.completed);
            const completedTasksCount = completedTasks.length;

            const estimatedTimeMinutes = uncompletedTasks.reduce((total, task) => total + (task.estimatedMinutes || 0), 0);
            const estimatedHours = Math.floor(estimatedTimeMinutes / 60).toString().padStart(2, '0');
            const estimatedMins = (estimatedTimeMinutes % 60).toString().padStart(2, '0');

            const elapsedTimeMinutes = uncompletedTasks.reduce((total, task) => {
                const session = userSessions.find(s => s.subject === task.title && s.type === 'study');
                return total + (session ? session.durationSeconds / 60 : 0);
            }, 0);
            const elapsedHours = Math.floor(elapsedTimeMinutes / 60).toString().padStart(2, '0');
            const elapsedMins = (elapsedTimeMinutes % 60).toString().padStart(2, '0');
            
            let tasksToRender;
            if (category === 'completed') {
                tasksToRender = tasksToShow;
            } else {
                tasksToRender = plannerState.showCompletedInCategory ? tasksToShow.filter(t => t.completed) : uncompletedTasks;
            }

            // --- 3. Generate HTML ---
            mainContent.innerHTML = `
                <div class="planner-category-view">
                    <header class="category-view-header">
                        <button class="category-back-btn text-gray-400 hover:text-white">
                             <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 class="category-view-title">${title}</h2>
                    </header>
                    <div class="category-stats-grid">
                        <div class="category-stat-card">
                            <div class="stat-value">${estimatedHours}:${estimatedMins}</div>
                            <div class="stat-label">Estimated Time</div>
                        </div>
                        <div class="category-stat-card">
                            <div class="stat-value">${tasksToBeCompletedCount}</div>
                            <div class="stat-label">Tasks to be Completed</div>
                        </div>
                        <div class="category-stat-card">
                            <div class="stat-value">${elapsedHours}:${elapsedMins}</div>
                            <div class="stat-label">Elapsed Time</div>
                        </div>
                         <div class="category-stat-card">
                            <div class="stat-value">${completedTasksCount}</div>
                            <div class="stat-label">Completed Tasks</div>
                        </div>
                    </div>
                    <div class="category-add-task-container">
                        <form id="category-add-task-form">
                            <div class="add-task-input-wrapper">
                                <i class="fas fa-plus"></i>
                                <input type="text" id="category-add-task-input" class="category-add-task-input" placeholder="Add a task...">
                            </div>
                        </form>
                    </div>
                    <div class="category-task-list-container no-scrollbar">
                        ${tasksToRender.length > 0 ? tasksToRender.map(task => `
                             <div class="category-task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}">
                                <div class="task-checkbox-category ${task.completed ? 'completed' : ''}"></div>
                                <span class="task-title-category">${task.title}</span>
                                <button class="task-play-btn"><i class="fas fa-play"></i></button>
                            </div>
                        `).join('') : `
                             <div class="no-tasks-placeholder">
                                <i class="fas fa-calendar-check"></i>
                                <h3>No Tasks</h3>
                                <p>Tap the input box above to add a new task.</p>
                            </div>
                        `}
                    </div>
                    ${completedTasks.length > 0 ? `
                        <div class="completed-tasks-toggle">
                            ${plannerState.showCompletedInCategory ? 'Hide' : 'Show'} Completed Tasks <i class="fas fa-chevron-down"></i>
                        </div>
                    ` : ''}
                </div>
            `;
        }          
        
        function renderPlannerTaskItem(task) {
            const priorityColors = { high: 'border-red-500', medium: 'border-yellow-500', low: 'border-blue-500', none: 'border-transparent' };
            const isSelected = plannerState.selectedTaskId === task.id;
            return `
              <div class="task-item flex items-center p-3 rounded-lg cursor-pointer transition-all duration-200 ${priorityColors[task.priority] || 'border-l-transparent'} ${isSelected ? 'bg-blue-900/50' : 'bg-gray-800 hover:bg-gray-700'}" data-task-id="${task.id}">
                <input type="checkbox" class="task-checkbox-planner w-5 h-5 bg-gray-700 rounded-full text-blue-500 focus:ring-blue-500 mr-4 flex-shrink-0" ${task.completed ? 'checked' : ''} />
                <span class="flex-grow ${task.completed ? 'line-through text-gray-500' : ''}">${task.title}</span>
                ${task.due_date ? `<span class="text-xs text-gray-400 ml-4">${new Date(task.due_date).toLocaleDateString()}</span>` : ''}
              </div>
            `;
          }          

        function renderPlannerBoardView(tasks) {
             const mainContent = document.getElementById('planner-main-content');
             const columns = {
                high: { name: 'High Priority', tasks: [], color: 'bg-red-500' },
                medium: { name: 'Medium Priority', tasks: [], color: 'bg-yellow-500' },
                low: { name: 'Low Priority', tasks: [], color: 'bg-blue-500' },
                none: { name: 'No Priority', tasks: [], color: 'bg-gray-400' },
            };
            tasks.filter(t => !t.completed).forEach(task => (columns[task.priority] || columns.none).tasks.push(task));

            mainContent.innerHTML = `
                <div class="kanban-board">
                    ${Object.entries(columns).map(([key, col]) => `
                        <div class="kanban-column">
                            <h3 class="font-semibold p-2 mb-2 ${col.color} text-white rounded-md">${col.name}</h3>
                            <div class="space-y-2">
                                ${col.tasks.map(task => `
                                    <div class="kanban-card p-3 rounded-md shadow-sm cursor-pointer" data-task-id="${task.id}">
                                        <p>${task.title}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderPlannerCalendarView(tasks) {
            const mainContent = document.getElementById('planner-main-content');
            const { calendarYear, calendarMonth } = plannerState;
            const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
          
            const firstDayOfMonth = new Date(calendarYear, calendarMonth, 1);
            const lastDayOfMonth = new Date(calendarYear, calendarMonth + 1, 0);
            const lastDayOfPrevMonth = new Date(calendarYear, calendarMonth, 0);
          
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();
            const endDayOfWeek = lastDayOfMonth.getDay();
          
            let calendarDays = [];
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
              const day = lastDayOfPrevMonth.getDate() - i;
              const date = new Date(lastDayOfPrevMonth.getFullYear(), lastDayOfPrevMonth.getMonth(), day);
              calendarDays.push({ day, date, isOtherMonth: true });
            }
            for (let day = 1; day <= daysInMonth; day++) {
              const date = new Date(calendarYear, calendarMonth, day);
              calendarDays.push({ day, date, isOtherMonth: false });
            }
            for (let i = 1; i <= 6 - endDayOfWeek; i++) {
              const date = new Date(calendarYear, calendarMonth + 1, i);
              calendarDays.push({ day: i, date, isOtherMonth: true });
            }
          
            mainContent.innerHTML = `
              <div class="calendar-container">
                <div class="calendar-header">
                  <div class="calendar-title">${monthNames[calendarMonth]} ${calendarYear}</div>
                  <div class="calendar-nav">
                    <button class="calendar-nav-btn" data-direction="prev"><i class="fas fa-chevron-left"></i></button>
                    <button class="calendar-nav-btn" data-direction="today">Today</button>
                    <button class="calendar-nav-btn" data-direction="next"><i class="fas fa-chevron-right"></i></button>
                  </div>
                </div>
                <div class="calendar-grid">
                  ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(day => `<div class="calendar-day-header">${day}</div>`).join('')}
                  ${calendarDays.map(({ day, date, isOtherMonth }) => {
                    const today = new Date();
                    const isToday = date.toDateString() === today.toDateString();
                    const tasksForDay = tasks.filter(t => t.due_date && new Date(t.due_date).toDateString() === date.toDateString());
          
                    return `
                      <div class="calendar-day-cell ${isOtherMonth ? 'other-month' : ''}" data-date="${date.toISOString().split('T')[0]}">
                        <div class="day-number ${isToday ? 'today' : ''}">${day}</div>
                        <div class="calendar-tasks-container">
                          ${tasksForDay.map(task => `
                            <div class="calendar-task priority-${task.priority} ${task.completed ? 'completed' : ''}" data-task-id="${task.id}">
                              ${task.title}
                            </div>
                          `).join('')}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `;
          }          

        function renderPlannerTaskDetails() {
            const detailsPanel = document.getElementById('planner-task-details');
            if (!detailsPanel) return;
          
            const selectedTask = plannerState.tasks.find(t => t.id === plannerState.selectedTaskId);
          
            if (!selectedTask) {
              detailsPanel.classList.add('hidden');
              detailsPanel.innerHTML = '';
              return;
            }
          
            detailsPanel.classList.toggle('open', !!selectedTask);
            detailsPanel.classList.toggle('hidden', !selectedTask);
          
            const taskListId = selectedTask.list_id ?? null;
          
            const listName = taskListId
              ? (plannerState.lists.find(l => l.id === taskListId)?.name || 'Tasks')
              : 'Tasks';
          
            const createdDate = selectedTask.created_at
              ? new Date(selectedTask.created_at).toLocaleDateString(undefined, { month: 'long', day: 'numeric' })
              : 'Today';
          
            const priorityClasses = {
              high: 'text-red-500',
              medium: 'text-yellow-500',
              low: 'text-blue-500',
              none: 'text-gray-400'
            };
            const priority = selectedTask.priority || 'none';
            const repeatText = selectedTask.repeat ? `Repeats ${selectedTask.repeat.type}` : 'None';
            const repeatTextColor = selectedTask.repeat ? 'text-gray-300' : 'text-gray-500';
          
            detailsPanel.innerHTML = `
              <div class="p-4 h-full flex flex-col bg-gray-800 text-white">
                <!-- Header -->
                <div class="flex-shrink-0 flex items-center mb-4">
                  <input type="checkbox" class="task-checkbox-planner w-6 h-6 bg-gray-700 rounded-full text-blue-500 focus:ring-blue-500 mr-4 flex-shrink-0" ${selectedTask.completed ? 'checked' : ''} />
                  <button id="task-detail-start-btn" class="mr-2 text-green-400 hover:text-green-300 transition" title="Start Normal Timer"><i class="fas fa-play"></i></button>
                  <input id="task-detail-title" class="text-xl font-semibold bg-transparent w-full border-none focus:ring-0 p-0" value="${selectedTask.title}">
                  <div class="relative">
                    <button id="task-detail-priority-btn" class="${priorityClasses[priority]} hover:opacity-80 transition" title="Set Priority">
                      <i class="fas fa-flag"></i>
                    </button>
                    <div id="task-priority-menu" class="hidden absolute right-0 mt-2 w-32 bg-gray-700 rounded-md shadow-lg z-10">
                      <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600" data-priority="high">High</a>
                      <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600" data-priority="medium">Medium</a>
                      <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600" data-priority="low">Low</a>
                      <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600" data-priority="none">None</a>
                    </div>
                  </div>
                  <button id="close-task-details" class="ml-2 p-1 rounded-full hover:bg-gray-700">&times;</button>
                </div>
          
                <!-- Main Content -->
                <div class="flex-grow overflow-y-auto pr-2 text-sm">
                  <button class="border border-gray-600 rounded-full px-3 py-1 text-gray-400 mb-4 hover:bg-gray-700">+ Tags</button>
          
                  <div class="space-y-3">
                    <div id="task-detail-pomodoro-btn" class="flex items-center cursor-pointer p-2 -ml-2 rounded-lg hover:bg-gray-700 transition" title="Start Pomodoro Timer">
                      <i class="fas fa-stopwatch text-gray-400 w-6 text-center mr-3"></i>
                      <span>Pomodoro</span>
                      <div class="ml-auto text-right">
                        <span class="text-green-400">0 / 0</span>
                        <p class="text-xs text-gray-500">= 25m</p>
                      </div>
                    </div>
          
                    <div class="flex items-center">
                      <i class="fas fa-calendar-day text-gray-400 w-6 text-center mr-3"></i>
                      <span>Due Date</span>
                      <input
                        type="date"
                        id="task-detail-due-date"
                        class="ml-auto bg-transparent text-right p-0 border-none focus:ring-0"
                        value="${selectedTask.due_date ? new Date(selectedTask.due_date).toISOString().split('T')[0] : ''}">
                    </div>
          
                    <div id="task-detail-project-btn" class="flex items-center cursor-pointer p-2 -ml-2 rounded-lg hover:bg-gray-700 transition">
                      <i class="fas fa-tasks text-gray-400 w-6 text-center mr-3"></i>
                      <span>Project</span>
                      <span class="ml-auto text-gray-300">${listName}</span>
                    </div>
          
                    <div class="flex items-center">
                      <i class="fas fa-bell text-gray-400 w-6 text-center mr-3"></i>
                      <span>Reminder</span>
                      <span class="ml-auto text-gray-500">None</span>
                    </div>
          
                    <div id="task-detail-repeat-btn" class="flex items-center cursor-pointer p-2 -ml-2 rounded-lg hover:bg-gray-700 transition">
                      <i class="fas fa-redo text-gray-400 w-6 text-center mr-3"></i>
                      <span>Repeat</span>
                      <span class="ml-auto ${repeatTextColor}">${repeatText}</span>
                    </div>
          
                    <div class="flex items-center text-gray-400">
                      <i class="fas fa-plus w-6 text-center mr-3"></i>
                      <input class="bg-transparent w-full border-none p-0 focus:ring-0" placeholder="Add a subtask...">
                    </div>
                  </div>
          
                  <textarea id="task-detail-notes" class="w-full bg-transparent p-0 mt-4 h-24 border-none focus:ring-0" placeholder="Add a note...">${selectedTask.notes || ''}</textarea>
                </div>
          
                <!-- Footer -->
                <div class="flex-shrink-0 pt-2 flex justify-between items-center text-xs text-gray-500">
                  <button><i class="fas fa-arrow-left"></i></button>
                  <span>Created on ${createdDate}</span>
                  <button id="delete-task-btn" class="text-gray-400 hover:text-red-500 text-base"><i class="fas fa-trash-alt"></i></button>
                </div>
              </div>
            `;
          }
          
          /** SUPABASE-ONLY IMPLEMENTATION **/
          
          async function addPlannerTask(title, dueDateStr = null) {
            if (!currentUser || !title.trim()) return;
          
            // 'inbox' is a UI concept; DB wants either a UUID or null
            const listIdForDb = plannerState.activeListId === 'inbox' ? null : plannerState.activeListId;
          
            // Build minimal, safe payload (only columns you actually have)
            const payload = {
              title: title.trim(),
              completed: false,
              priority: 'none',
              list_id: listIdForDb,
              created_by: currentUser.id,
              notes: ''
              // add members / tags columns ONLY if your table has them
              // members: [currentUser.id],
              // tags: [],
            };
          
            if (dueDateStr) {
              // store as ISO timestamp (date-only at midnight UTC)
              payload.due_date = new Date(dueDateStr + 'T00:00:00Z').toISOString();
            }
          
            const { data, error } = await supabase
              .from('tasks')
              .insert([payload])
              .select()
              .single();
          
            if (error) {
              console.error('Error adding task:', error);
              showToast('Failed to add task.', 'error');
              return;
            }
          
            // Update your local state (optional)
            plannerState.tasks.push(data);
            plannerState.selectedTaskId = data.id;
            renderPlannerPage();            // refresh list/board/calendar
          }
          
          function camelToSnake(obj) {
            const map = { listId: 'list_id', createdAt: 'created_at', createdBy: 'created_by', dueDate: 'due_date' };
            const out = {};
            for (const [k, v] of Object.entries(obj || {})) out[map[k] || k] = v;
            return out;
          }
          
          async function updatePlannerTask(taskId, data) {
            if (!currentUser || !taskId) return;
          
            // FIX: When moving a task to the inbox, the list_id should be null, not the string "inbox".
            if (data.hasOwnProperty('listId') && data.listId === 'inbox') {
              data.listId = null;
            }

            const payload = camelToSnake(data);
          
            const { error } = await supabase
              .from('tasks')
              .update(payload)
              .eq('id', taskId);
          
            if (error) {
              console.error('Error updating task:', error);
              showToast('Failed to update task.', 'error');
            }
          }
          
          async function deletePlannerTask(taskId) {
            if (!currentUser || !taskId) return;
          
            const { error } = await supabase
              .from('tasks')
              .delete()
              .eq('id', taskId);
          
            if (error) {
              console.error('Error deleting task:', error);
              showToast('Failed to delete task.', 'error');
              return;
            }
          
            plannerState.selectedTaskId = null;
            plannerState.tasks = plannerState.tasks.filter(t => t.id !== taskId);
            renderPlannerTaskDetails();
          }          

        async function renderLeaderboard(period = 'weekly', containerId = 'ranking-list') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const periodTabsSelector = containerId === 'ranking-list' 
                ? '#ranking-period-tabs .ranking-tab-btn' 
                : '#group-ranking-period-tabs .ranking-tab-btn';
            
            const periodTabs = document.querySelectorAll(periodTabsSelector);
            if (periodTabs.length > 0) {
                periodTabs.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.period === period);
                });
            }

            container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';

            const { data: profiles, error: profilesError } = await supabase
                .from('profiles')
                .select('id, username, photo_url');
            if (profilesError) {
                console.error('Failed to load leaderboard users', profilesError);
                container.innerHTML = '<div class="empty-group"><i class="fas fa-exclamation-triangle"></i><h3>Unable to load leaderboard</h3></div>';
                return;
            }

            const now = getCurrentDate();
            let startDate;
            switch (period) {
                case 'daily':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'monthly':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 30);
                    break;
                case 'weekly':
                default:
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 7);
                    break;
            }
            startDate.setHours(0, 0, 0, 0);
            const startIso = startDate.toISOString();

            const userPromises = (profiles || []).map(async profile => {
                const sessions = await fetchSessionsSince(profile.id, startIso);
                const totalSeconds = sessions
                    .filter(session => session.type === 'study')
                    .reduce((sum, session) => sum + (session.durationSeconds || 0), 0);

                return {
                    id: profile.id,
                    username: profile.username || 'Anonymous',
                    photo_url: profile.photo_url,
                    total_study_seconds: totalSeconds
                };
            });

            const userScores = await Promise.all(userPromises);
            userScores.sort((a, b) => b.total_study_seconds - a.total_study_seconds);

            const periodText = period === 'daily' ? 'today' : period === 'weekly' ? 'in the last 7 days' : 'in the last 30 days';

            container.innerHTML = userScores.map((user, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                if (rank === 2) rankClass = 'rank-2';
                if (rank === 3) rankClass = 'rank-3';

                const avatarHTML = user.photo_url 
                    ? `<img src="${user.photo_url}" class="w-full h-full object-cover">`
                    : `<span>${(user.username || 'U').charAt(0).toUpperCase()}</span>`;

                return `
                    <div class="ranking-item ${currentUser.id === user.id ? 'bg-blue-900/30' : ''}" data-user-id="${user.id}">
                        <div class="rank ${rankClass}">${rank}</div>
                        <div class="user-avatar bg-gray-600 overflow-hidden">${avatarHTML}</div>
                        <div class="user-info">
                            <div class="user-name">${user.username}</div>
                            <div class="user-time">${formatTime(user.total_study_seconds, false)} ${periodText}</div>
                        </div>
                    </div>
                `;
            }).join('') || `<div class="empty-group"><i class="fas fa-trophy"></i><h3>Leaderboard is Empty</h3><p>Start studying to see your rank!</p></div>`;
        }

        // ---- Public API ----
        // Call renderStatsPage() when you open the Stats page.
        // Call disposeStatsPage() when you leave the page to clean subscriptions/intervals.
        
        let __stats = { subSessions: null, subUser: null, liveInterval: null, cachedSessions: [], liveStudying: null, charts: {} };
        
        function disposeStatsPage() {
          if (__stats.subSessions) { supabase.removeChannel(__stats.subSessions); __stats.subSessions = null; }
          if (__stats.subUser) { supabase.removeChannel(__stats.subUser); __stats.subUser = null; }
          if (__stats.liveInterval) { clearInterval(__stats.liveInterval); __stats.liveInterval = null; }
          __destroyAllCharts();
        }
        
        function renderStatsPage(/* focusSessions (ignored now) */) {
          const insightsContainer = document.getElementById('insights-container');
          if (!insightsContainer) return;
        
          insightsContainer.innerHTML = `
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
              <div>
                <h1 class="text-4xl font-bold text-white">Study Insights</h1>
                <p class="text-slate-400 mt-1">Welcome back, let's analyze your progress.</p>
              </div>
              <div class="w-full sm:w-auto overflow-x-auto no-scrollbar">
                <nav id="dashboard-nav-bar" class="flex space-x-2 mt-4 sm:mt-0 bg-slate-800 p-2 rounded-xl flex-nowrap" style="white-space: nowrap;">
                  <button class="nav-btn active" data-view="day">Day</button>
                  <button class="nav-btn" data-view="trend">Trend</button>
                  <button class="nav-btn" data-view="month">Month</button>
                  <button class="nav-btn" data-view="period">Period</button>
                </nav>
              </div>
            </header>
            <main>
              <div id="day-view" class="view active grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
              <div id="trend-view" class="view grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
              <div id="month-view" class="view grid grid-cols-1 lg:grid-cols-3 gap-6"></div>
              <div id="period-view" class="view grid grid-cols-1 lg:grid-cols-3 gap-6"></div>
            </main>
          `;
        
          // wire nav
          const navBar = insightsContainer.querySelector('#dashboard-nav-bar');
          const views = insightsContainer.querySelectorAll('.view');
          navBar.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const viewName = e.target.dataset.view;
            navBar.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            views.forEach(v => v.classList.toggle('active', v.id === `${viewName}-view`));
            __renderActiveView(); // render current tab from current data
          });
        
          if (typeof lucide !== 'undefined') lucide.createIcons();
        
          // start realtime + initial load
          __startStatsRealtime();
        }
        
        /* ---------------- internals ---------------- */
        
        const CHART_COLORS = {
          cyan:   'rgba(34, 211, 238, 0.6)',
          sky:    'rgba(56, 189, 248, 0.6)',
          indigo: 'rgba(129, 140, 248, 0.6)',
          pink:   'rgba(244, 114, 182, 0.6)',
          orange: 'rgba(251, 146, 60, 0.6)',
        };
        const CHART_BORDERS = {
          cyan:   'rgba(34, 211, 238, 1)',
          sky:    'rgba(56, 189, 248, 1)',
          indigo: 'rgba(129, 140, 248, 1)',
          pink:   'rgba(244, 114, 182, 1)',
          orange: 'rgba(251, 146, 60, 1)',
        };
        const COLOR_LIST = Object.values(CHART_COLORS);
        const withDataLabels = (typeof ChartDataLabels !== 'undefined') ? [ChartDataLabels] : [];
        
        function __palette(n){ const out=[]; for(let i=0;i<n;i++) out.push(COLOR_LIST[i%COLOR_LIST.length]); return out; }
        function __toDateSafe(v){ if(!v) return null; const d=(v instanceof Date)?v:new Date(v); return isNaN(d.getTime())?null:d; }
        function __today(){ return new Date(); }
        function __fmtHMS(minutes){
          if (!isFinite(minutes) || minutes < 0) return '00:00:00';
          const h = Math.floor(minutes/60), m=Math.floor(minutes%60), s=Math.floor((minutes*60)%60);
          return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }
        function __destroyChart(id){ if (__stats.charts[id]) { __stats.charts[id].destroy(); delete __stats.charts[id]; } }
        function __destroyAllCharts(){ Object.keys(__stats.charts).forEach(__destroyChart); }
        
        function __normalizeSessions(rows){
          return (rows||[])
            .map(s=>{
              const durSec = Number(s.durationSeconds ?? s.duration_seconds ?? 0);
              const end = __toDateSafe(s.endedAt ?? s.ended_at);
              if (!end || !isFinite(durSec) || durSec <= 0) return null;
              const start = new Date(end.getTime() - durSec*1000);
              return {
                id: s.id,
                subject: s.subject || 'General',
                startTime: start,
                endTime: end,
                duration: durSec/60,
                durationSeconds: durSec,
                type: s.type || 'study',
              };
            })
            .filter(Boolean)
            .sort((a,b)=>a.startTime-b.startTime);
        }
        
        // merge a live virtual session into normalized list
        function __mergeLiveVirtual(norm){
          const live = __stats.liveStudying; // {type, startTime, subject?}
          if (!live) return norm;
        
          const start = __toDateSafe(live.startTime);
          if (!start) return norm;
        
          const now = __today();
          const durMin = (now - start) / 60000;
          if (durMin <= 0) return norm;
        
          const virtual = {
            id: '__live__',
            subject: live.subject || 'Focus',
            startTime: start,
            endTime: now,
            duration: durMin,
            durationSeconds: Math.floor(durMin*60),
            type: live.type || 'study',
          };
        
          // donâ€™t double-count if a session row is already being written continuously;
          // but normally ongoing timer has no finished session row, so we just add.
          return [...norm, virtual].sort((a,b)=>a.startTime-b.startTime);
        }
        
        /* ---------- realtime wiring ---------- */
        
        async function __startStatsRealtime() {
          if (!currentUser) return;
        
          // initial fetch
          await __reloadSessions();
          await __loadLiveStudying();
          __renderActiveView();
          __setupLiveTicker();
        
          // subscribe to my sessions changes
          if (__stats.subSessions) supabase.removeChannel(__stats.subSessions);
          __stats.subSessions = supabase
            .channel(`sessions:me:${currentUser.id}`)
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'sessions', filter: `profile_id=eq.${currentUser.id}` },
                async () => {
                  await __reloadSessions();
                  __renderActiveView();
                })
            .subscribe();
        
          // subscribe to my profile row to track studying start/stop and subject/type flips (normal vs pomodoro)
          if (__stats.subUser) supabase.removeChannel(__stats.subUser);
          __stats.subUser = supabase
            .channel(`profiles:me:${currentUser.id}`) // Channel name updated for clarity
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'profiles', filter: `id=eq.${currentUser.id}` }, // Changed from 'users'
                (payload) => {
                  const row = payload.new || payload.old || {};
                  __stats.liveStudying = row.studying || null;
                  __setupLiveTicker();     // restart/stop ticking depending on state
                  __renderActiveView();    // re-render quickly (subject/type may change)
                })
            .subscribe();
        }
        
        async function __reloadSessions() {
          const { data, error } = await supabase
            .from('sessions')
            .select('id, profile_id, subject, durationSeconds, endedAt, type')
            .eq('profile_id', currentUser.id)
            .order('endedAt', { ascending: true });
          if (error) { console.error('stats: load sessions failed', error); return; }
          __stats.cachedSessions = data || [];
        }
        
        async function __loadLiveStudying() {
          const { data, error } = await supabase
            .from('profiles') // Changed from 'users'
            .select('studying')
            .eq('id', currentUser.id)
            .single();
          if (error) { console.warn('stats: load user studying failed', error); }
          __stats.liveStudying = data?.studying || null;
        }
        
        function __setupLiveTicker() {
          // if currently studying/break, tick every 1s; else stop
          if (__stats.liveInterval) { clearInterval(__stats.liveInterval); __stats.liveInterval = null; }
          if (!__stats.liveStudying || !__stats.liveStudying.startTime) return;
          __stats.liveInterval = setInterval(() => {
            // update only the active tab; charts update too
            __renderActiveView(true /*tick*/);
          }, 1000);
        }
        
        /* ---------- render routing ---------- */
        
        function __renderActiveView(isTick=false) {
          const container = document.getElementById('insights-container');
          if (!container) return;
        
          // normalize + merge virtual live
          const base = __normalizeSessions(__stats.cachedSessions);
          const appData = __mergeLiveVirtual(base);
          const today = __today();
        
          // simple inner helpers reused across views
          const genInsight = __makeInsightGenerator(today);
          const destroyChart = __destroyChart;
        
          // Which tab?
          const activeBtn = container.querySelector('#dashboard-nav-bar .nav-btn.active');
          const view = activeBtn ? activeBtn.dataset.view : 'day';
        
          if (view === 'day') return __renderDay(appData, today, genInsight, destroyChart);
          if (view === 'trend') return __renderTrend(appData, today, destroyChart);
          if (view === 'month') return __renderMonth(appData, today, destroyChart);
          return __renderPeriod(appData, today, genInsight, destroyChart);
        }
        
        /* ---------- insight generator ---------- */
        function __makeInsightGenerator(today){
          return function generateAIInsight(sessions, elementId='ai-insight-text'){
            const el = document.getElementById(elementId); if (!el) return;
            const study = sessions.filter(s=>s.type==='study');
            if (study.length < 3) { el.textContent = 'Start logging more sessions to unlock personalized insights!'; return; }
            const cands = [
              ()=>{ const tot=study.reduce((a,s)=>(a[s.subject]=(a[s.subject]||0)+s.duration,a),{}); const top=Object.entries(tot).sort((x,y)=>y[1]-x[1])[0]; return (top&&top[1]>60)?`You're putting a lot of effort into '${top[0]}'. Keep it up!`:null; },
              ()=>{ const tot=study.reduce((a,s)=>(a[s.subject]=(a[s.subject]||0)+s.duration,a),{}); const arr=Object.entries(tot).sort((x,y)=>x[1]-y[1]); return (arr.length>1&&arr.at(-1)[1]>arr[0][1]*3)?`Don't forget '${arr[0][0]}'. A quick review could help.`:null; },
              ()=>{ const hourly=Array(24).fill(0); study.forEach(s=>hourly[s.startTime.getHours()]+=s.duration); const peak=hourly.indexOf(Math.max(...hourly)); const tod=peak>=5&&peak<12?'in the morning':peak<17?'in the afternoon':peak<21?'in the evening':'late at night'; return `You seem most productive ${tod}. Plan key tasks accordingly!`; },
              ()=>{ const avg=study.reduce((sum,s)=>sum+s.duration,0)/study.length; if (avg>90) return 'Long sessions! Remember short breaks to maintain focus.'; if (avg<25) return 'Sessions are short and sharp. Try a longer block for deep work.'; return null; },
              ()=>{ const days=new Set(); study.forEach(s=>{ if ((today - s.startTime)/86400000 <= 7) days.add(s.startTime.getDay()); }); if (days.size>=5) return `Great consistency! You studied on ${days.size} days this week.`; if (days.size>0&&days.size<3) return 'Build the habit â€” aim for short daily sessions.'; return null; }
            ];
            let msg=null, tries=0; while(!msg && tries<cands.length){ msg=cands[Math.floor(Math.random()*cands.length)](); tries++; }
            if (!msg) {
              const tot=study.reduce((a,s)=>(a[s.subject]=(a[s.subject]||0)+s.duration,a),{}); const top=Object.entries(tot).sort((x,y)=>y[1]-x[1])[0];
              msg = top ? `You've been focusing well on '${top[0]}'. Consistency is building!` : 'Keep going â€” more sessions unlock deeper insights.';
            }
            el.textContent = msg;
          };
        }
        
        /* ---------- Views (reuse your original visuals; just fed by appData) ---------- */
        
        function __renderPeriod(appData, today, generateAIInsight, destroyChart) {
          const el = document.getElementById('period-view'); if (!el) return;
          el.innerHTML = `
            <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div class="card flex flex-col justify-center items-center p-6"><h3 class="text-slate-400 text-lg font-medium">Total Time</h3><p id="period-total-time" class="text-4xl font-bold text-cyan-400 mt-2">--:--:--</p></div>
              <div class="card flex flex-col justify-center items-center p-6"><h3 class="text-slate-400 text-lg font-medium">Daily Average</h3><p id="period-daily-avg" class="text-4xl font-bold text-cyan-400 mt-2">--:--:--</p></div>
              <div class="card flex flex-col justify-center items-center p-6"><h3 class="text-slate-400 text-lg font-medium">Focus Score</h3><p id="period-focus-score" class="text-4xl font-bold text-cyan-400 mt-2">--</p></div>
              <div class="card bg-gradient-to-br from-sky-500 to-indigo-600 p-6"><h3 class="text-white text-lg font-medium flex items-center"><i data-lucide="brain-circuit" class="mr-2"></i>AI Insight</h3><p id="ai-insight-text" class="text-white mt-2 text-sm">Analyzing your study patterns...</p></div>
            </div>
            <div class="card lg:col-span-1"><h3 class="font-semibold text-xl mb-4">Subject Ratio</h3><div class="chart-container" style="height: 250px;"><canvas id="subject-ratio-chart"></canvas></div></div>
            <div class="card lg:col-span-2"><h3 class="font-semibold text-xl mb-4">Time Per Day (Last 28 Days)</h3><div class="chart-container"><canvas id="time-per-day-chart"></canvas></div></div>
            <div class="card lg:col-span-3"><h3 class="font-semibold text-xl mb-4">Cumulative Study Time</h3><div class="chart-container"><canvas id="cumulative-time-chart"></canvas></div></div>
          `;
          if (typeof lucide !== 'undefined') lucide.createIcons();
        
          const last28 = appData.filter(d => (today - d.startTime)/86400000 <= 28 && d.type==='study');
          const totalMin = last28.reduce((s,x)=>s+x.duration,0);
          const dailyAvg = totalMin/28;
          const focusScore = last28.length ? Math.round((totalMin/last28.length)/60*100) : 0;
        
          document.getElementById('period-total-time').textContent = __fmtHMS(totalMin);
          document.getElementById('period-daily-avg').textContent = __fmtHMS(dailyAvg);
          document.getElementById('period-focus-score').textContent = String(isNaN(focusScore)?0:focusScore);
        
          const subjAgg = last28.reduce((a,s)=> (a[s.subject]=(a[s.subject]||0)+s.duration, a), {});
          destroyChart('subject-ratio-chart');
          __stats.charts['subject-ratio-chart'] = new Chart(document.getElementById('subject-ratio-chart'), {
            type:'doughnut', plugins: withDataLabels,
            data:{ labels:Object.keys(subjAgg), datasets:[{ data:Object.values(subjAgg), backgroundColor: __palette(Object.keys(subjAgg).length), borderColor:'#1e293b', borderWidth:4 }] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{
              legend:{ position:'right', labels:{ color:'#cbd5e1' } },
              tooltip:{ callbacks:{ label(ctx){ const t=(ctx.dataset.data||[]).reduce((a,b)=>a+b,0)||1; const pct=((ctx.parsed/t)*100).toFixed(1)+'%'; return `${ctx.label}: ${pct}`; } } },
              datalabels: withDataLabels.length ? { formatter:(v,ctx)=>{ const s=(ctx.dataset.data||[]).reduce((a,b)=>a+b,0)||1; return ((v*100/s).toFixed(1))+'%'; }, color:'#fff', font:{weight:'bold'} } : undefined
            } }
          });
        
          const perDay = Array(28).fill(0);
          appData.filter(d=>d.type==='study').forEach(s=>{
            const idx = 27 - Math.floor((today - s.startTime)/86400000);
            if (idx>=0 && idx<28) perDay[idx] += s.duration;
          });
          const labels28 = Array.from({length:28},(_,i)=>{ const d=new Date(); d.setDate(d.getDate()-(27-i)); return `${d.getMonth()+1}/${d.getDate()}`; });
        
          destroyChart('time-per-day-chart');
          __stats.charts['time-per-day-chart'] = new Chart(document.getElementById('time-per-day-chart'), {
            type:'bar',
            data:{ labels: labels28, datasets:[{ label:'Minutes Studied', data: perDay, backgroundColor: CHART_COLORS.sky, borderColor: CHART_BORDERS.sky, borderWidth:1, borderRadius:5 }] },
            options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, grid:{color:'#334155'}, ticks:{color:'#94a3b8'} }, x:{ grid:{color:'#334155'}, ticks:{color:'#94a3b8', maxRotation:90, minRotation:45} } }, plugins:{ legend:{ display:false } } }
          });
        
          let cum = 0; const cumulative = perDay.map(v => (cum += v));
          destroyChart('cumulative-time-chart');
          __stats.charts['cumulative-time-chart'] = new Chart(document.getElementById('cumulative-time-chart'), {
            type:'line',
            data:{ labels: labels28, datasets:[{ label:'Cumulative Minutes', data:cumulative, fill:true, backgroundColor: CHART_COLORS.cyan, borderColor: CHART_BORDERS.cyan, tension:0.4, pointRadius:0 }] },
            options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, grid:{color:'#334155'}, ticks:{color:'#94a3b8'} }, x:{ grid:{color:'#334155'}, ticks:{color:'#94a3b8'} } }, plugins:{ legend:{ display:false } } }
          });
        
          generateAIInsight(last28);
        }
        
        function __renderMonth(appData, today, destroyChart) {
          const el = document.getElementById('month-view'); if (!el) return;
          el.innerHTML = `
            <div class="card lg:col-span-1"><h3 class="font-semibold text-xl mb-4">Study vs. Break</h3><div class="chart-container"><canvas id="study-break-chart"></canvas></div></div>
            <div class="card lg:col-span-2"><h3 class="font-semibold text-xl mb-4">Study Time by Subject (This Month)</h3><div class="chart-container"><canvas id="study-time-by-subject-chart"></canvas></div></div>
            <div class="card lg:col-span-3"><h3 class="font-semibold text-xl mb-4">Start/End Time Distribution</h3><div class="chart-container"><canvas id="start-end-distribution-chart"></canvas></div></div>
          `;
        
          const thisMonth = appData.filter(d => d.startTime.getMonth()===today.getMonth() && d.startTime.getFullYear()===today.getFullYear());
          const studyMin = thisMonth.filter(s=>s.type==='study').reduce((sum,s)=>sum+s.duration,0);
          const breakMin = thisMonth.filter(s=>s.type==='break').reduce((sum,s)=>sum+s.duration,0);
        
          destroyChart('study-break-chart');
          __stats.charts['study-break-chart'] = new Chart(document.getElementById('study-break-chart'), {
            type:'doughnut', plugins: withDataLabels,
            data:{ labels:['Study','Break'], datasets:[{ data:[studyMin,breakMin], backgroundColor:[CHART_COLORS.indigo, '#475569'], borderColor:'#1e293b', borderWidth:4 }] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{
              legend:{ position:'top', labels:{ color:'#cbd5e1' }},
              tooltip:{ callbacks:{ label(ctx){ const t=(ctx.dataset.data||[]).reduce((a,b)=>a+b,0)||1; const pct=((ctx.parsed/t)*100).toFixed(1)+'%'; return `${ctx.label}: ${pct}`; } } },
              datalabels: withDataLabels.length ? { formatter:(v,ctx)=>{ const s=(ctx.dataset.data||[]).reduce((a,b)=>a+b,0)||1; return ((v*100/s).toFixed(1))+'%'; }, color:'#fff', font:{weight:'bold'} } : undefined
            } }
          });
        
          const bySubject = thisMonth.filter(s=>s.type==='study').reduce((a,s)=> (a[s.subject]=(a[s.subject]||0)+s.duration, a), {});
          destroyChart('study-time-by-subject-chart');
          __stats.charts['study-time-by-subject-chart'] = new Chart(document.getElementById('study-time-by-subject-chart'), {
            type:'bar',
            data:{ labels:Object.keys(bySubject), datasets:[{ label:'Minutes Studied', data:Object.values(bySubject), backgroundColor: __palette(Object.keys(bySubject).length) }] },
            options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, scales:{ x:{ grid:{color:'#334155'}, ticks:{color:'#94a3b8'} }, y:{ grid:{color:'#334155'}, ticks:{color:'#94a3b8'} } }, plugins:{ legend:{ display:false } } }
          });
        
          const dist = thisMonth.filter(s=>s.type==='study').map(s => ({
            x: s.startTime, y: s.startTime.getHours()+s.startTime.getMinutes()/60, yEnd: s.endTime.getHours()+s.endTime.getMinutes()/60
          }));
          destroyChart('start-end-distribution-chart');
          __stats.charts['start-end-distribution-chart'] = new Chart(document.getElementById('start-end-distribution-chart'), {
            type:'scatter',
            data:{ datasets:[
              { label:'Start Time', data: dist.map(d=>({x:d.x,y:d.y})), backgroundColor: CHART_COLORS.sky },
              { label:'End Time',   data: dist.map(d=>({x:d.x,y:d.yEnd})), backgroundColor: CHART_COLORS.pink }
            ]},
            options:{ responsive:true, maintainAspectRatio:false, scales:{
              x:{ type:'time', time:{ unit:'day' }, grid:{color:'#334155'}, ticks:{color:'#94a3b8'} },
              y:{ beginAtZero:true, max:24, grid:{color:'#334155'}, ticks:{color:'#94a3b8', stepSize:2, callback:(v)=>`${v}:00` } }
            }, plugins:{ legend:{ labels:{ color:'#cbd5e1' } } } }
          });
        }
        
        function __renderTrend(appData, today, destroyChart) {
          const el = document.getElementById('trend-view'); if (!el) return;
          el.innerHTML = `
            <div class="card lg:col-span-1"><h3 class="font-semibold text-xl mb-4">Study Time Regularity</h3><div class="chart-container"><canvas id="regularity-chart"></canvas></div></div>
            <div class="card lg:col-span-1"><h3 class="font-semibold text-xl mb-4">Performance Forecast</h3><div class="chart-container"><canvas id="forecast-chart"></canvas></div></div>
            <div class="card lg:col-span-2"><h3 class="font-semibold text-xl mb-4">Recent Session Log</h3><div id="session-log-container-trend" class="max-h-80 overflow-y-auto pr-2"></div></div>
          `;
        
          const reg = appData.filter(s=>s.type==='study').slice(-50).map(s => ({
            x: s.startTime, y: s.startTime.getHours()+s.startTime.getMinutes()/60, r: Math.max(3, s.duration/10)
          }));
          destroyChart('regularity-chart');
          __stats.charts['regularity-chart'] = new Chart(document.getElementById('regularity-chart'), {
            type:'bubble',
            data:{ datasets:[{ label:'Study Session', data: reg, backgroundColor: CHART_COLORS.indigo }] },
            options:{ responsive:true, maintainAspectRatio:false, scales:{
              x:{ type:'time', time:{ unit:'day' }, grid:{color:'#334155'}, ticks:{color:'#94a3b8'} },
              y:{ min:6, max:24, grid:{color:'#334155'}, ticks:{color:'#94a3b8', stepSize:3, callback:(v)=>`${v}:00` } }
            }, plugins:{ legend:{ display:false } } }
          });
        
          const last14 = Array(14).fill(0);
          appData.filter(d => (today - d.startTime)/86400000 <= 14 && d.type==='study')
            .forEach(s => { const idx = 13 - Math.floor((today - s.startTime)/86400000); if (idx>=0) last14[idx] += s.duration; });
          const avg = last14.reduce((a,b)=>a+b,0)/14;
          const base = last14.reduce((a,b)=>a+b,0);
          const forecastData = Array.from({length:7},(_,i)=> base + avg*(i+1));
          const forecastLabels = Array.from({length:7},(_,i)=>{ const d=new Date(); d.setDate(d.getDate()+i+1); return `${d.getMonth()+1}/${d.getDate()}`; });
        
          destroyChart('forecast-chart');
          __stats.charts['forecast-chart'] = new Chart(document.getElementById('forecast-chart'), {
            type:'line',
            data:{ labels: forecastLabels, datasets:[{ label:'Projected Study Minutes', data: forecastData, borderColor: CHART_BORDERS.orange, backgroundColor: CHART_COLORS.orange, borderDash:[5,5], tension:0.2 }] },
            options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, grid:{color:'#334155'}, ticks:{color:'#94a3b8'} }, x:{ grid:{color:'#334155'}, ticks:{color:'#94a3b8'} } }, plugins:{ legend:{ display:false } } }
          });
        
          __renderSessionLog(appData.filter(s=>s.type==='study').slice().reverse().slice(0,20), 'session-log-container-trend');
        }
        
        function __renderDay(appData, today, generateAIInsight, destroyChart) {
          const el = document.getElementById('day-view'); if (!el) return;
          el.innerHTML = `
            <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div class="card flex flex-col justify-center items-center p-6"><h3 class="text-slate-400 text-lg font-medium">Total Time Today</h3><p id="day-total-time" class="text-4xl font-bold text-cyan-400 mt-2">--:--:--</p></div>
              <div class="card flex flex-col justify-center items-center p-6"><h3 class="text-slate-400 text-lg font-medium">Sessions Today</h3><p id="day-session-count" class="text-4xl font-bold text-cyan-400 mt-2">--</p></div>
              <div class="card flex flex-col justify-center items-center p-6"><h3 class="text-slate-400 text-lg font-medium">Avg. Session</h3><p id="day-avg-session" class="text-4xl font-bold text-cyan-400 mt-2">--m</p></div>
              <div class="card bg-gradient-to-br from-sky-500 to-indigo-600 p-6"><h3 class="text-white text-lg font-medium flex items-center"><i data-lucide="brain-circuit" class="mr-2"></i>AI Insight</h3><p id="day-ai-insight-text" class="text-white mt-2 text-sm">Analyzing today's patterns...</p></div>
            </div>
            <div class="card lg:col-span-1"><h3 class="font-semibold text-xl mb-4">Today's Subject Ratio</h3><div class="chart-container" style="height:250px;"><canvas id="day-subject-ratio-chart"></canvas></div></div>
            <div class="card lg:col-span-1"><h3 class="font-semibold text-xl mb-4">Time Per Hour Today</h3><div class="chart-container"><canvas id="day-time-per-hour-chart"></canvas></div></div>
            <div class="card lg:col-span-2"><h3 class="font-semibold text-xl mb-4">Today's Session Log</h3><div id="session-log-container-day" class="max-h-80 overflow-y-auto pr-2"></div></div>
          `;
        
          const todayStr = today.toISOString().split('T')[0];
          const todayData = appData.filter(d => d.type==='study' && d.startTime.toISOString().split('T')[0]===todayStr);
        
          const totalMin = todayData.reduce((s,x)=>s+x.duration,0);
          const count = todayData.length;
          const avg = count ? totalMin / count : 0;
        
          document.getElementById('day-total-time').textContent = __fmtHMS(totalMin);
          document.getElementById('day-session-count').textContent = count;
          document.getElementById('day-avg-session').textContent = `${avg.toFixed(0)}m`;
        
          generateAIInsight(todayData, 'day-ai-insight-text');
          if (typeof lucide !== 'undefined') lucide.createIcons();
        
          const subjToday = todayData.reduce((a,s)=> (a[s.subject]=(a[s.subject]||0)+s.duration, a), {});
          destroyChart('day-subject-ratio-chart');
          __stats.charts['day-subject-ratio-chart'] = new Chart(document.getElementById('day-subject-ratio-chart'), {
            type:'pie', plugins: withDataLabels,
            data:{ labels:Object.keys(subjToday), datasets:[{ data:Object.values(subjToday), backgroundColor: __palette(Object.keys(subjToday).length), borderColor:'#1e293b', borderWidth:4 }] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{
              legend:{ position:'right', labels:{ color:'#cbd5e1' } },
              datalabels: withDataLabels.length ? { formatter:(v,ctx)=>{ const s=(ctx.dataset.data||[]).reduce((a,b)=>a+b,0)||1; return ((v*100/s).toFixed(0))+'%'; }, color:'#fff', font:{weight:'bold'} } : undefined
            } }
          });
        
          const perHour = Array(24).fill(0);
          todayData.forEach(s => { perHour[s.startTime.getHours()] += s.duration; });
          destroyChart('day-time-per-hour-chart');
          __stats.charts['day-time-per-hour-chart'] = new Chart(document.getElementById('day-time-per-hour-chart'), {
            type:'bar',
            data:{ labels: Array.from({length:24},(_,i)=>`${String(i).padStart(2,'0')}:00`), datasets:[{ label:'Minutes Studied', data:perHour, backgroundColor: CHART_COLORS.sky, borderRadius:5 }] },
            options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, grid:{color:'#334155'}, ticks:{color:'#94a3b8'} }, x:{ grid:{color:'#334155'}, ticks:{color:'#94a3b8', maxRotation:90, minRotation:45} } }, plugins:{ legend:{ display:false } } }
          });
        
          __renderSessionLog(todayData.slice().reverse(), 'session-log-container-day');
        }
        
        function __renderSessionLog(list, containerId) {
          const wrap = document.getElementById(containerId); if (!wrap) return;
          wrap.innerHTML = '';
          list.forEach(s => {
            const item = document.createElement('div');
            item.className = 'session-log-item p-3 mb-2 bg-slate-700/50 rounded-lg flex justify-between items-center';
            item.innerHTML = `
              <div>
                <p class="font-semibold text-white">${s.subject} <span class="text-sm text-gray-500">(${s.type})</span></p>
                <p class="text-sm text-slate-400">${s.startTime.toLocaleString()}</p>
              </div>
              <div class="flex items-center">
                <div class="text-lg font-bold text-sky-400 mr-4">${s.duration.toFixed(0)} min</div>
                <button class="log-options-btn p-2 rounded-full hover:bg-slate-600"
                        data-session-id="${s.id}"
                        data-duration-seconds="${s.durationSeconds}"
                        data-ended-at="${s.endTime.toISOString()}">
                  <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                </button>
                <div class="log-options-menu">
                  <button class="log-edit-btn">Edit</button>
                  <button class="log-delete-btn">Delete</button>
                </div>
              </div>`;
            wrap.appendChild(item);
          });
          if (typeof lucide !== 'undefined') lucide.createIcons();
        
          // delegate actions (delete/edit) â€” uses your existing deleteSession handler
          wrap.addEventListener('click', e => {
            const optionsBtn = e.target.closest('.log-options-btn');
            if (optionsBtn) {
              const menu = optionsBtn.nextElementSibling;
              wrap.querySelectorAll('.log-options-menu').forEach(m => { if (m !== menu) m.classList.remove('active'); });
              menu.classList.toggle('active'); return;
            }
            const del = e.target.closest('.log-delete-btn');
            if (del) {
              const btn = del.closest('.session-log-item').querySelector('.log-options-btn');
              const id = btn.dataset.sessionId;
              const duration = parseInt(btn.dataset.durationSeconds, 10);
              const endedAt = new Date(btn.dataset.endedAt);
              showConfirmationModal('Delete Session?', 'Are you sure you want to permanently delete this study session?', () => {
                deleteSession(id, duration, endedAt);
              });
            }
            const edit = e.target.closest('.log-edit-btn');
            if (edit) {
              const btn = edit.closest('.session-log-item').querySelector('.log-options-btn');
              const id = btn.dataset.sessionId;
              const duration = parseInt(btn.dataset.durationSeconds, 10);
              const endedAtISO = btn.dataset.endedAt;
              const modal = document.getElementById('edit-session-modal');
              document.getElementById('edit-session-id').value = id;
              document.getElementById('edit-session-duration').value = Math.round(duration/60);
              document.getElementById('edit-session-old-duration').value = duration;
              document.getElementById('edit-session-ended-at').value = endedAtISO;
              modal.classList.add('active');
            }
          }, { once: true }); // avoid stacking handlers
        }
                 
        
          // REPLACE your existing deleteSession with this Supabase version
          async function deleteSession(sessionId, durationSecondsArg, endedAtArg) {
            if (!currentUser || !sessionId) return;
          
            // 1) Load the session so we trust type/duration/time
            const { data: session, error: sErr } = await supabase
              .from('sessions')
              .select('id, profile_id, type, durationSeconds, endedAt')
              .eq('id', sessionId)
              .eq('profile_id', currentUser.id)
              .single();
          
            if (sErr || !session) {
              console.error('fetch session failed', sErr);
              showToast('Could not find that session.', 'error');
              return;
            }
          
            const durSec = Number(session.durationSec ?? durationSecondsArg ?? 0) || 0;
            const endedAt = session.endedAt
              ? new Date(session.endedAt)
              : (endedAtArg ? new Date(endedAtArg) : null);
            const type = session.type || 'study';
          
            // 2) Delete the session row
            const { error: dErr } = await supabase
              .from('sessions')
              .delete()
              .eq('id', sessionId)
              .eq('profile_id', currentUser.id);
          
            if (dErr) {
              console.error('delete failed', dErr);
              showToast('Failed to delete session.', 'error');
              return;
            }
          
            // 3) Read current user aggregates
            const { data: userRow, error: uErr } = await supabase
              .from('profiles') // Changed from 'users'
              .select('total_study_seconds, total_break_seconds, total_time_today, total_break_time_today')
              .eq('id', currentUser.id)
              .single();
          
            if (uErr) {
              console.warn('deleted session, but failed to load user aggregates', uErr);
              showToast('Session deleted, but failed to update totals.', 'warning');
              // We still continue; UI will recalc from sessions anyway.
            }
          
            // 4) Compute updates safely
            const updates = {};
            if (userRow) {
              if (type === 'study') {
                updates.total_study_seconds = Math.max(0, Number(userRow.total_study_seconds || 0) - durSec);
              } else {
                updates.total_break_seconds = Math.max(0, Number(userRow.total_break_seconds || 0) - durSec);
              }
          
              const todayStr = new Date().toISOString().split('T')[0];
              const endedStr = endedAt ? endedAt.toISOString().split('T')[0] : null;
          
              if (endedStr === todayStr) {
                if (type === 'study') {
                  const ttt = userRow.total_time_today || {};
                  const seconds = Math.max(0, Number(ttt.seconds || 0) - durSec);
                  updates.total_time_today = { date: todayStr, seconds };
                } else {
                  const tbt = userRow.total_break_time_today || {};
                  const seconds = Math.max(0, Number(tbt.seconds || 0) - durSec);
                  updates.total_break_time_today = { date: todayStr, seconds };
                }
              }
            }
          
            // 5) Apply aggregate updates (if we managed to load userRow)
            if (Object.keys(updates).length) {
              const { error: upErr } = await supabase
                .from('profiles') // Changed from 'users'
                .update(updates)
                .eq('id', currentUser.id);
              if (upErr) {
                console.warn('totals update failed', upErr);
                showToast('Session deleted, but failed to update totals.', 'warning');
              }
            }
          
            showToast('Session deleted successfully', 'success');
          
            // 6) Refresh the Stats view data so charts/logs update
            try {
              const { data: freshSessions } = await supabase
                .from('sessions')
                .select('id, subject, durationSeconds, endedAt, type')
                .eq('profile_id', currentUser.id)
                .order('endedAt', { ascending: true });
              if (Array.isArray(freshSessions)) {
                renderStatsPage(freshSessions);
              }
            } catch (e) {
              console.warn('stats refresh failed', e);
            }
          }          

        async function renderJoinedGroups() {
            if (!currentUser) return;
            const container = document.getElementById('my-groups-list');
            if (!container) return;
        
            container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
        
            try {
                // Find my group IDs
                const { data: memRows, error: mErr } = await supabase
                    .from('group_members')
                    .select('group_id')
                    .eq('profile_id', currentUser.id);
        
                if (mErr) throw mErr;
        
                const joinedGroupIds = (memRows || []).map(r => r.group_id);
                currentUserData.joined_groups = joinedGroupIds;
        
                if (joinedGroupIds.length === 0) {
                    container.innerHTML = `<div class="empty-group"><i class="fas fa-users-slash"></i><h3>No Groups Joined Yet</h3><p>You haven't joined any study groups. Join a group or create your own to get started!</p><button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition mt-4" id="explore-groups-btn">Explore Groups</button></div>`;
                    return;
                }
        
                // Call the Edge Function to get enriched data for only the groups I've joined
                const { data: enriched, error: fnError } = await supabase.functions.invoke('get-enriched-groups', {
                    body: { groupIds: joinedGroupIds }
                });
        
                if (fnError) throw fnError;
        
                if (!enriched || enriched.length === 0) {
                    container.innerHTML = `<div class="empty-group"><i class="fas fa-users-slash"></i><h3>No Groups Joined Yet</h3><p>You haven't joined any study groups. Join a group or create your own to get started!</p><button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition mt-4" id="explore-groups-btn">Explore Groups</button></div>`;
                    return;
                }
        
                container.innerHTML = '<div class="space-y-4">' + enriched.map(group => {
                    const started = group.created_at ? new Date(group.created_at) : new Date();
                    const category = pick(group.category, 'General');
                    const leader = pick(group.leaderName, group.leader_name, 'â€”');
                    const timeGoal = pick(group.timeGoal, group.time_goal, 0);
        
                    return `
                        <div class="group-card bg-gray-800 rounded-2xl overflow-hidden shadow-lg cursor-pointer" data-group-id="${group.id}">
                          <div class="p-5">
                            <div class="flex justify-between items-start">
                              <div>
                                <div class="text-xs uppercase text-blue-400 font-semibold">${category}</div>
                                <h3 class="text-xl font-bold text-white truncate">${group.name}</h3>
                                <div class="text-sm text-gray-400 mt-1">Goal: ${timeGoal} hours/day</div>
                              </div>
                              <div class="text-xs text-gray-500 text-right flex-shrink-0 ml-2">Leader: ${leader}</div>
                            </div>
                            <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                              <div><div class="text-2xl font-bold text-green-400">${group.attendance}%</div><div class="text-xs text-gray-400">Attendance</div></div>
                              <div><div class="text-2xl font-bold text-cyan-400">${formatTime(group.avgTime, false)}</div><div class="text-xs text-gray-400">Avg. Time</div></div>
                              <div><div class="text-2xl font-bold text-white">${group.membersCount}/${group.capacity}</div><div class="text-xs text-gray-400">Members</div></div>
                            </div>
                          </div>
                          <div class="bg-gray-700/50 px-5 py-3 flex justify-between items-center text-sm">
                            <span class="text-gray-400">Started: ${started.toLocaleDateString()}</span>
                            ${group.newMessages > 0 ? `<span class="flex items-center gap-2 text-blue-400 animate-pulse"><i class="fas fa-comment-dots"></i> ${group.newMessages} new</span>` : `<span class="text-gray-500">No new messages</span>`}
                          </div>
                        </div>`;
                }).join('') + '</div>';
        
            } catch (error) {
                console.error('Error in renderJoinedGroups:', error);
                container.innerHTML = `<div class="text-center text-red-400 py-6">Failed to load your groups. Please try again.</div>`;
            }
        }

        function timeSince(date) {
            if (!date) return 'N/A';
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m";
            return Math.floor(seconds) + "s";
        }

        async function renderGroupRankings() {
            if (!currentUser) return;
            const container = document.getElementById('all-groups-list');
            if (!container) return;
            container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
        
            const sortMethod = document.querySelector('#group-ranking-sort-tabs .active')?.dataset.sort || 'studytime';
            const filters = {
                univ: document.querySelector('[data-filter="univ"]')?.checked,
                available: document.querySelector('[data-filter="available"]')?.checked,
                public: document.querySelector('[data-filter="public"]')?.checked,
            };
        
            try {
                // Call the Edge Function to get all enriched group data
                const { data: enriched, error: fnError } = await supabase.functions.invoke('get-enriched-groups', {
                    body: {} // No groupIds means fetch all
                });
        
                if (fnError) throw fnError;
        
                // Client-side filtering
                let filtered = enriched.filter(g => {
                    if (filters.univ && g.category !== 'University') return false;
                    if (filters.available && g.membersCount >= g.capacity) return false;
                    if (filters.public && g.password) return false;
                    return true;
                });
        
                // Client-side sorting
                filtered.sort((a, b) => {
                    switch (sortMethod) {
                        case 'attendance': return (b.attendance - a.attendance) || (b.membersCount - a.membersCount);
                        case 'new': {
                            const da = a.created_at ? new Date(a.created_at) : new Date(0);
                            const db = b.created_at ? new Date(b.created_at) : new Date(0);
                            return db - da;
                        }
                        case 'studytime':
                        default:
                            return (b.avgTime - a.avgTime) || (b.membersCount - a.membersCount);
                    }
                });
        
                if (filtered.length === 0) {
                    container.innerHTML = `<div class="empty-group"><i class="fas fa-search-minus"></i><h3>No Groups Found</h3><p>Try adjusting your filters or create a new group!</p></div>`;
                    return;
                }
        
                container.innerHTML = '<div class="flex flex-col gap-4">' + filtered.map((g, idx) => {
                    const rank = idx + 1;
                    const isFull = g.membersCount >= g.capacity;
                    const isJoined = (currentUserData?.joined_groups || []).includes(g.id);
                    const createdDate = g.created_at ? new Date(g.created_at) : new Date();
                    const category = pick(g.category, 'General');
                    const leaderName = pick(g.leaderName, g.leader_name, 'â€”');
                    const timeGoal = pick(g.timeGoal, g.time_goal, 0);
        
                    return `
                        <div class="group-card ranking bg-gray-800 rounded-xl overflow-hidden shadow-lg" data-group-id="${g.id}">
                          <div class="p-4">
                            <div class="flex justify-between items-center text-xs text-gray-400 mb-2">
                              <span class="font-bold text-base ${rank===1?'text-yellow-400':rank===2?'text-gray-300':rank===3?'text-yellow-600':'text-blue-400'}">
                                Ranked #${rank} <span class="text-white">${category.substring(0,2).toUpperCase()}</span>
                              </span>
                              <span class="flex items-center gap-2">
                                <span>${timeSince(createdDate)} ago</span>
                              </span>
                            </div>
                            <h3 class="text-lg font-bold truncate mb-2 text-white">${g.name}</h3>
                            <div class="grid grid-cols-3 gap-x-2 gap-y-1 text-xs mb-3">
                              <span class="text-gray-400">Goal <b class="text-white">${timeGoal}h</b></span>
                              <span class="text-gray-400 col-span-2">Members <b class="text-white">${g.membersCount}/${g.capacity} people</b></span>
                              <span class="text-gray-400 col-span-3">Leader <b class="text-white">${leaderName}</b></span>
                              <span class="text-gray-400">Attendance <b class="text-white">${g.attendance}%</b></span>
                              <span class="text-gray-400 col-span-2">Time <b class="text-white">${formatTime(g.avgTime, false)}</b></span>
                              <span class="text-gray-400 col-span-3">Started <b class="text-white">${createdDate.toLocaleDateString()}</b></span>
                            </div>
                            <p class="text-gray-400 text-sm mb-3 h-8 overflow-hidden">${g.description || ''}</p>
                            <button class="join-btn w-full mt-2 ${isJoined ? 'bg-blue-600' : 'bg-green-500 hover:bg-green-600'}" data-id="${g.id}" data-private="${!!g.password}" ${isFull && !isJoined ? 'disabled' : ''}>
                              ${isJoined ? 'Joined' : (isFull ? 'Group Full' : 'Join Group')}
                            </button>
                          </div>
                        </div>`;
                }).join('') + '</div>';
        
                // Attach event listeners after rendering
                document.querySelectorAll('.join-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const groupId = this.dataset.id;
                        const isPrivate = this.dataset.private === 'true';
                        if ((currentUserData?.joined_groups || []).includes(groupId)) {
                            showToast("You've already joined this group.", 'info');
                            return;
                        }
                        if (this.disabled) {
                            showToast("This group is currently full.", "info");
                            return;
                        }
        
                        if (isPrivate) {
                            const modal = document.getElementById('password-prompt-modal');
                            modal.classList.add('active');
                            document.getElementById('password-prompt-form').onsubmit = async (e) => {
                                e.preventDefault();
                                const password = document.getElementById('group-password-prompt-input').value;
                                const { data: g } = await supabase.from('groups').select('password').eq('id', groupId).single();
                                if (!g || password !== g.password) {
                                    showToast('Incorrect password', 'error');
                                    return;
                                }
                                modal.classList.remove('active');
                                await joinGroup(groupId);
                                renderGroupRankings();
                            };
                        } else {
                            await joinGroup(groupId);
                            renderGroupRankings();
                        }
                    });
                });
        
                document.querySelectorAll('.group-card.ranking').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (e.target.classList.contains('join-btn')) return;
                        const groupId = card.dataset.groupId;
                        if ((currentUserData?.joined_groups || []).includes(groupId)) {
                            renderGroupDetail(groupId);
                            showPage('page-group-detail');
                        } else {
                            showToast('Join the group to see details.', 'info');
                        }
                    });
                });
        
            } catch (error) {
                console.error('Error in renderGroupRankings:', error);
                container.innerHTML = `<div class="empty-group"><i class="fas fa-exclamation-triangle"></i><h3>Unable to load rankings</h3><p>There might be an issue with the server. Please try again later.</p></div>`;
            }
        }

          async function joinGroup(groupId) {
            if (!currentUser) return;
          
            // (optional) capacity check
            const [{ data: capRow, error: gErr }, { data: memRows, error: mErr }] = await Promise.all([
              supabase.from('groups').select('capacity').eq('id', groupId).single(),
              supabase.from('group_members').select('profile_id', { count: 'exact' }).eq('group_id', groupId)
            ]);
            if (gErr || mErr) { console.error(gErr || mErr); showToast('Could not join group.', 'error'); return; }
            const currentCount = (memRows || []).length;
            if (capRow && currentCount >= capRow.capacity) {
              showToast('This group is currently full.', 'info');
              return;
            }
          
            // do the join
            const { error } = await supabase
              .from('group_members')
              .insert([{ group_id: groupId, profile_id: currentUser.id }]);
          
            // handle "already joined"
            if (error) {
              // Postgres unique violation (if you set PK (group_id, profile_id))
              if (error.code === '23505') {
                showToast("You've already joined this group.", 'info');
              } else {
                console.error('joinGroup error', error);
                showToast('Failed to join group.', 'error');
              }
              return;
            }
          
            // keep your in-memory cache consistent for buttons/labels
            currentUserData.joined_groups = Array.from(new Set([...(currentUserData.joined_groups || []), groupId]));
          
            showToast('Group joined successfully!', 'success');
          
            // refresh whichever UI youâ€™re on
            if (document.getElementById('my-groups-list')) renderJoinedGroups();
            if (document.getElementById('all-groups-list')) renderGroupRankings();
          }          

        function renderSubjectSelectionList(subjects, newlyAddedSubjectName = null) {
            const container = document.getElementById('subject-selection-list');
            if (!container) return;
            if (subjects.length === 0) {
                container.innerHTML = `<p class="text-gray-400 text-center">No subjects added yet. Add one below!</p>`;
                return;
            }
            container.innerHTML = subjects.map(subject => `
                <div class="subject-item p-3 rounded-lg flex items-center gap-3" 
                     draggable="true" 
                     data-subject-id="${subject.id}" 
                     data-subject-name="${subject.name}"
                     data-order="${subject.order || 0}">
                    <div class="flex-grow flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full ${subject.color}"></div>
                        <span>${subject.name}</span>
                    </div>
                    <button class="subject-options-btn"><i class="fas fa-ellipsis-v"></i></button>
                    <div class="subject-options-menu">
                        <button class="edit-subject-btn">Edit</button>
                        <button class="delete-subject-btn delete-btn">Delete</button>
                    </div>
                </div>
            `).join('');

            // Auto-select the newly added subject if provided
            if (newlyAddedSubjectName) {
                const newSubjectElement = container.querySelector(`[data-subject-name="${newlyAddedSubjectName}"]`);
                if (newSubjectElement) {
                    // Remove 'selected' from any previously selected subject
                    container.querySelectorAll('.subject-item.selected').forEach(el => el.classList.remove('selected'));
                    // Add 'selected' to the new subject
                    newSubjectElement.classList.add('selected');
                    newSubjectElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            } else {
                // If no new subject, ensure no subject is selected by default
                container.querySelectorAll('.subject-item.selected').forEach(el => el.classList.remove('selected'));
            }
        }
        
        function renderPlanner(tasks) {
            const container = document.getElementById('planner-list');
            if (!container) return;
            if (tasks.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-8">No tasks scheduled. Add one to get started!</div>`;
                return;
            }

            const groupedTasks = tasks.reduce((acc, task) => {
                const date = task.date;
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(task);
                return acc;
            }, {});

            container.innerHTML = Object.keys(groupedTasks).sort().map(dateStr => {
                const date = new Date(dateStr + 'T00:00:00');
                const dayHeader = `
                    <div class="day-header">
                        <span>${date.toLocaleDateString(undefined, { weekday: 'long' })}</span>
                        <span>${date.toLocaleDateString(undefined, { month: 'long', day: 'numeric' })}</span>
                    </div>
                `;

                const tasksHtml = groupedTasks[dateStr].map(task => `
                    <div class="planner-task">
                        <input type="checkbox" class="task-checkbox w-5 h-5 bg-gray-700 rounded text-blue-500 focus:ring-blue-500" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                        <div class="task-name ${task.completed ? 'completed' : ''}">${task.name}</div>
                    </div>
                `).join('');

                return `<div class="planner-day">${dayHeader}${tasksHtml}</div>`;
            }).join('');
        }
        
        async function renderGroupDetail(groupId) {
            currentGroupId = groupId;
          
            // Populate selector with my groups
            const { data: myGroups } = await supabase
              .from('group_members')
              .select('group_id, groups!inner(id, name)')
              .eq('profile_id', currentUser.id);
            const groupSelector = document.getElementById('group-selector');
            if (groupSelector) {
              groupSelector.innerHTML = '';
              (myGroups || []).forEach(row => {
                const g = row.groups;
                const opt = document.createElement('option');
                opt.value = g.id; opt.textContent = g.name;
                if (g.id === groupId) opt.selected = true;
                groupSelector.appendChild(opt);
              });
              groupSelector.value = groupId;
              groupSelector.onchange = (e) => renderGroupDetail(e.target.value);
            }
          
            // Load group
            const { data: group, error } = await supabase.from('groups').select('*').eq('id', groupId).single();
            if (error || !group) { showPage('page-my-groups'); return; }
          
            // Settings icons
            const settingsBtnContainer = document.getElementById('group-settings-btn-container');
            const settingsBtnContainerMobile = document.getElementById('group-settings-btn-container-mobile');
            if (settingsBtnContainer) settingsBtnContainer.innerHTML = `<button id="group-settings-btn" class="text-gray-400 hover:text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700"><i class="fas fa-cog"></i></button>`;
            if (settingsBtnContainerMobile) settingsBtnContainerMobile.innerHTML = `<button id="group-settings-btn-mobile" class="text-gray-400 hover:text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-700"><i class="fas fa-cog"></i></button>`;
          
            // Subscribe to group and membership changes
            groupDetailUnsubscribers.forEach(unsub => unsub());
            groupDetailUnsubscribers = [];
          
            const grpChan = supabase
              .channel(`groups:${groupId}`)
              .on('postgres_changes', { event: '*', schema: 'public', table: 'groups', filter: `id=eq.${groupId}` }, () => {
                const sub = document.querySelector('#group-detail-nav .active')?.dataset.subpage || 'home';
                renderGroupSubPage(sub);
              })
              .subscribe();
            groupDetailUnsubscribers.push(() => supabase.removeChannel(grpChan));
          
            const memChan = supabase
              .channel(`group_members:${groupId}`)
              .on('postgres_changes', { event: '*', schema: 'public', table: 'group_members', filter: `group_id=eq.${groupId}` },
                async () => {
                  const { data: rows } = await supabase.from('group_members').select('profile_id').eq('group_id', groupId);
                  const memberIds = (rows || []).map(r => r.profile_id);
                  setupGroupMemberListeners(memberIds);
                })
              .subscribe();
            groupDetailUnsubscribers.push(() => supabase.removeChannel(memChan));
          
            // Initial members
            const { data: rows } = await supabase.from('group_members').select('profile_id').eq('group_id', groupId);
            setupGroupMemberListeners((rows || []).map(r => r.profile_id));
          
            const activeSubPage = document.querySelector('#group-detail-nav .active')?.dataset.subpage || 'home';
            renderGroupSubPage(activeSubPage);
          }
          
        function renderGroupMembers() {
            const container = document.getElementById('group-detail-content');
            if (!container) return;

            // Clear any existing intervals to prevent memory leaks
            memberTimerIntervals.forEach(clearInterval);
            memberTimerIntervals = [];

            const membersArray = Object.values(groupRealtimeData.members || {});

            membersArray.sort((a, b) => {
                const aIsStudying = a.studying && a.studying.type === 'study';
                const bIsStudying = b.studying && b.studying.type === 'study';
                if (aIsStudying && !bIsStudying) return -1;
                if (!aIsStudying && bIsStudying) return 1;
                return (a.username || '').localeCompare(b.username || '');
            });
            
            if (membersArray.length === 0) {
                 container.innerHTML = `<div class="empty-group"><i class="fas fa-users"></i><h3>Group is Empty</h3><p>Invite some friends to study with you!</p></div>`;
                 return;
            }

            container.innerHTML = `
                <div class="p-4 space-y-3">
                    ${membersArray.map(member => {
                        if (!member) return '';
                        const isStudying = member.studying && member.studying.type === 'study';
                        const avatarHTML = member.photo_url
                            ? `<img src="${member.photo_url}" class="w-full h-full object-cover">`
                            : `<span>${(member.username || 'U').charAt(0).toUpperCase()}</span>`;

                        const lastSession = (groupRealtimeData.sessions[member.id] || [])[0];
                        const lastActiveDate = lastSession ? lastSession.endedAt : null;
                        
                        const todayStr = new Date().toISOString().split('T')[0];
                        let totalTodaySeconds = 0;
                        if (member.total_time_today && member.total_time_today.date === todayStr) {
                            totalTodaySeconds = member.total_time_today.seconds || 0;
                        }
                        
                        return `
                            <div class="member-list-card member-profile-link" data-user-id="${member.id}">
                                <div class="member-avatar ${isStudying ? 'studying' : ''} overflow-hidden">
                                    ${avatarHTML}
                                    ${isStudying ? '<div class="member-status-icon"></div>' : ''}
                                </div>
                                <div class="flex-grow min-w-0">
                                    <div class="member-name">${member.username || 'Anonymous'}</div>
                                    <div class="member-time" id="member-time-${member.id}">
                                        ${isStudying 
                                            ? `Studying: ${member.studying.subject}` 
                                            : (lastActiveDate ? `Idle since ${lastActiveDate.toLocaleTimeString()}` : 'Idle')
                                        }
                                    </div>
                                </div>
                                <div class="ml-auto flex items-center gap-4">
                                    <div class="text-right">
                                        <div class="font-semibold text-lg" id="member-total-today-${member.id}">
                                            ${formatTime(totalTodaySeconds)}
                                        </div>
                                        <div class="text-xs text-gray-400">Total Today</div>
                                    </div>
                                    ${!isStudying && member.id !== currentUser.id ? `
                                        <button class="wake-up-btn px-3 py-1.5 bg-sky-500 text-white rounded-full text-xs font-semibold hover:bg-sky-600 transition flex items-center gap-1.5" data-target-user-id="${member.id}" data-target-user-name="${member.username || 'Anonymous'}">
                                            <i class="fas fa-bell"></i> Wake Up
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            // Now, set up intervals to update the time displays
            membersArray.forEach(member => {
                const timeEl = document.getElementById(`member-time-${member.id}`);
                const totalTodayEl = document.getElementById(`member-total-today-${member.id}`);
                if (!timeEl || !totalTodayEl) return;
                
                const interval = setInterval(() => {
                    const latestMemberData = groupRealtimeData.members[member.id];
                    if (!latestMemberData) { clearInterval(interval); return; }

                    const isStudying = latestMemberData.studying && latestMemberData.studying.type === 'study';

                    // Update Total Today display on every tick
                    const todayStr = new Date().toISOString().split('T')[0];
                    let totalTodaySeconds = 0;
                    if (latestMemberData.total_time_today && latestMemberData.total_time_today.date === todayStr) {
                        totalTodaySeconds = latestMemberData.total_time_today.seconds || 0;
                    }
                    totalTodayEl.textContent = formatTime(totalTodaySeconds);

                    // Update status/running timer under the name
                    if (isStudying) {
                        const startTime = new Date(latestMemberData.studying.startTime);
                        const durationSeconds = Math.floor((Date.now() - startTime.getTime()) / 1000);
                        timeEl.textContent = `Studying: ${latestMemberData.studying.subject} for ${formatTime(durationSeconds)}`;
                        timeEl.classList.add('text-green-400');
                        timeEl.classList.remove('text-gray-400');
                    } else {
                         const lastSession = (groupRealtimeData.sessions[member.id] || [])[0];
                         const lastActiveDate = lastSession ? lastSession.endedAt : null;
                         timeEl.textContent = lastActiveDate ? `Idle for ${timeSince(lastActiveDate)}` : 'Idle';
                         timeEl.classList.remove('text-green-400');
                         timeEl.classList.add('text-gray-400');
                    }
                }, 1000);
                memberTimerIntervals.push(interval);
            });
        }

        function renderGroupStudiconView() {
            const container = document.getElementById('group-detail-content');
            if (!container) return;

            // Clear previous intervals to prevent memory leaks and duplicate timers
            memberTimerIntervals.forEach(clearInterval);
            memberTimerIntervals = [];

            const membersArray = Object.values(groupRealtimeData.members || {});
            const totalMembers = membersArray.length;
            const studyingCount = membersArray.filter(m => m && m.studying && m.studying.type === 'study').length;

            container.innerHTML = `
                <div class="p-4">
                    <div class="text-center mb-6">
                        <h2 id="studicon-studying-count" class="text-3xl font-bold text-sky-400">${studyingCount} / ${totalMembers}</h2>
                        <p class="text-gray-400 mt-1">Members Currently Studying</p>
                    </div>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-x-4 gap-y-6">
                        ${membersArray.map(member => {
                            if (!member) return '';
                            const isStudying = member.studying && member.studying.type === 'study';
                            const studiconUrl = member.studicon_url || `https://api.dicebear.com/8.x/miniavs/svg?seed=${encodeURIComponent(member.username || 'user')}`;
                            const subject = isStudying ? member.studying.subject : 'Idle';
                            
                            const todayStr = new Date().toISOString().split('T')[0];
                            let totalTodaySeconds = 0;
                            if (member.total_time_today && member.total_time_today.date === todayStr) {
                                totalTodaySeconds = member.total_time_today.seconds || 0;
                            }

                            return `
                                <div class="studicon-member-card text-center cursor-pointer member-profile-link" data-user-id="${member.id}">
                                    <div class="relative w-20 h-20 sm:w-24 sm:h-24 mx-auto">
                                        <img src="${studiconUrl}" class="w-full h-full rounded-full bg-gray-700 p-1 ${isStudying ? 'ring-4 ring-green-500' : 'ring-4 ring-gray-600'}" alt="${member.username || 'User'}">
                                        ${isStudying ? `<div class="absolute bottom-0 right-0 w-5 h-5 sm:w-6 sm:h-6 bg-green-500 border-2 border-gray-900 rounded-full"></div>` : ''}
                                    </div>
                                    <p class="mt-2 font-semibold text-white truncate">${member.username || 'Anonymous'}</p>
                                    <p class="text-xs truncate" id="studicon-subject-${member.id}">${subject}</p>
                                    <p class="text-sm font-bold text-sky-400" id="studicon-total-today-${member.id}">${formatTime(totalTodaySeconds)}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Set up a single interval to update all dynamic elements
            const interval = setInterval(() => {
                const currentMembers = Object.values(groupRealtimeData.members || {});
                const currentStudyingCount = currentMembers.filter(m => m && m.studying && m.studying.type === 'study').length;

                const countEl = document.getElementById('studicon-studying-count');
                if (countEl) {
                    countEl.textContent = `${currentStudyingCount} / ${currentMembers.length}`;
                }

                currentMembers.forEach(member => {
                    if (!member) return;

                    const totalTodayEl = document.getElementById(`studicon-total-today-${member.id}`);
                    const subjectEl = document.getElementById(`studicon-subject-${member.id}`);
                    if (!totalTodayEl || !subjectEl) return;
                    
                    const isStudying = member.studying && member.studying.type === 'study';

                    // Update Total Today
                    const todayStr = new Date().toISOString().split('T')[0];
                    let totalTodaySeconds = (member.total_time_today && member.total_time_today.date === todayStr) 
                        ? (member.total_time_today.seconds || 0) 
                        : 0;
                    totalTodayEl.textContent = formatTime(totalTodaySeconds);

                    // Update Subject/Status
                    subjectEl.textContent = isStudying ? member.studying.subject : 'Idle';
                    subjectEl.classList.toggle('text-green-400', isStudying);
                    subjectEl.classList.toggle('text-gray-400', !isStudying);
                });

            }, 1000);
            memberTimerIntervals.push(interval);
        }

        function renderGroupSubPage(subpage) {
            const container = document.getElementById('group-detail-content');
            if (!container) return;
            
            // Show/hide controls based on subpage
            const rankingScopeSwitch = document.getElementById('ranking-scope-switch');
            const desktopHomeControls = document.getElementById('group-desktop-controls');
            const mobileHomeControls = document.getElementById('group-mobile-controls');

            if (rankingScopeSwitch) {
                rankingScopeSwitch.classList.toggle('hidden', subpage !== 'rankings');
                rankingScopeSwitch.classList.toggle('flex', subpage === 'rankings');
            }
            if (desktopHomeControls && mobileHomeControls) {
                const showHomeControls = (subpage === 'home');
                desktopHomeControls.classList.toggle('hidden', !showHomeControls);
                mobileHomeControls.classList.toggle('hidden', !showHomeControls);
            }

            document.querySelectorAll('.group-nav-item').forEach(i => i.classList.remove('active'));
            const activeNavItem = document.querySelector(`.group-nav-item[data-subpage="${subpage}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
            
            // Render content based on subpage
            switch (subpage) {
                case 'home':
                    const isStudiconView = document.getElementById('studicon-view-btn')?.classList.contains('active');
                    if (isStudiconView) {
                        renderGroupStudiconView();
                    } else {
                        renderGroupMembers();
                    }
                    break;
                case 'attendance':
                    container.innerHTML = `
                        <div class="attendance-container">
                            <div class="attendance-header">
                                <button id="prev-month-btn" class="attendance-nav-btn"><i class="fas fa-chevron-left"></i></button>
                                <h2 id="current-month-display" class="attendance-title">Loading...</h2>
                                <button id="next-month-btn" class="attendance-nav-btn"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="grid grid-cols-7 gap-2 text-center text-xs text-gray-400 mb-2">
                                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
                            <div class="attendance-stats mt-4">
                                <h3 class="font-semibold text-lg mb-2">Monthly Stats</h3>
                                <div class="stats-grid">
                                    <div class="stat-box"><div id="total-hours" class="stat-value">--</div><div class="stat-label">Total Hours</div></div>
                                    <div class="stat-box"><div id="days-studied" class="stat-value">--</div><div class="stat-label">Days Studied</div></div>
                                    <div class="stat-box"><div id="attendance-rate" class="stat-value">--%</div><div class="stat-label">Attendance</div></div>
                                </div>
                            </div>
                            <div class="attendance-member-list mt-4">
                                <h3 class="font-semibold text-lg mb-2">Member Details</h3>
                                <div id="attendance-member-grid" class="space-y-2"></div>
                            </div>
                        </div>
                    `;
                    renderGroupAttendance();
                    break;
                case 'rankings':
                    container.innerHTML = `
                        <div class="px-4 pt-4">
                            <div class="flex space-x-1" id="group-ranking-period-tabs">
                                <button class="ranking-tab-btn flex-1 py-2 px-4 rounded-t-lg font-semibold text-sm active" data-period="weekly">Last 7 Days</button>
                                <button class="ranking-tab-btn flex-1 py-2 px-4 rounded-t-lg font-semibold text-sm" data-period="daily">Daily</button>
                                <button class="ranking-tab-btn flex-1 py-2 px-4 rounded-t-lg font-semibold text-sm" data-period="monthly">Last 30 Days</button>
                            </div>
                        </div>
                        <div id="group-ranking-list" class="ranking-list"></div>
                    `;
                    // Add event listener for the newly created tabs
                    document.getElementById('group-ranking-period-tabs').addEventListener('click', e => {
                        if (e.target.matches('.ranking-tab-btn')) {
                            const period = e.target.dataset.period;
                            const isGlobal = document.getElementById('global-ranking-scope-btn')?.classList.contains('active');
                            if (isGlobal) {
                                renderLeaderboard(period, 'group-ranking-list');
                            } else {
                                renderGroupLeaderboard(period);
                            }
                        }
                    });
                    renderGroupLeaderboard('weekly');
                    break;
                case 'invite':
                    container.innerHTML = `
                        <div class="p-6 text-center">
                            <i class="fas fa-share-alt text-5xl text-blue-400 mb-4"></i>
                            <h2 class="text-2xl font-bold mb-2">Invite Friends</h2>
                            <p class="text-gray-400 mb-6">Share this group ID with your friends to let them join.</p>
                            <div class="bg-gray-800 p-4 rounded-lg flex items-center justify-between">
                                <span id="group-invite-id" class="text-lg font-mono text-gray-300">${currentGroupId}</span>
                                <button id="copy-group-id-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700">Copy ID</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('copy-group-id-btn').addEventListener('click', () => {
                        navigator.clipboard.writeText(currentGroupId).then(() => {
                            showToast('Group ID copied to clipboard!', 'success');
                        }).catch(err => {
                            showToast('Failed to copy ID.', 'error');
                        });
                    });
                    break;
                case 'chat':
                    container.innerHTML = `
                        <div class="flex flex-col h-full" style="height: calc(100vh - 73px - 57px);">
                            <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4 no-scrollbar">
                                <!-- Messages will be rendered here -->
                            </div>
                            <form id="chat-form" class="p-4 border-t border-gray-700 flex items-center gap-2">
                                <div class="relative flex-grow">
                                    <input id="chat-input" type="text" class="w-full bg-gray-700 rounded-full py-3 px-5 text-white" placeholder="Type a message..." autocomplete="off">
                                </div>
                                <button type="submit" class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white flex-shrink-0 hover:bg-blue-700 transition">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    `;
                    setupGroupChat(currentGroupId);
                    break;
            }
        }

          function setupGroupMemberListeners(memberIds) {
            // clear previous
            groupDetailUnsubscribers.forEach(unsub => unsub());
            groupDetailUnsubscribers = [];
            memberTimerIntervals.forEach(clearInterval);
            memberTimerIntervals = [];
            groupRealtimeData = { members: {}, sessions: {} };
          
            memberIds.forEach(async (memberId) => {
              // initial user
              const { data: u } = await supabase.from('profiles').select('*').eq('id', memberId).single();
              if (u) {
                groupRealtimeData.members[memberId] = u;
                const activeSubPage = document.querySelector('#group-detail-nav .active')?.dataset.subpage || 'home';
                if (activeSubPage === 'home') {
                    const isStudiconView = document.getElementById('studicon-view-btn')?.classList.contains('active');
                    if (isStudiconView) {
                        renderGroupStudiconView();
                    } else {
                        renderGroupMembers();
                    }
                }
              }
          
              // initial sessions
              const { data: sRows } = await supabase
                .from('sessions')
                .select('id,subject,durationSeconds,endedAt,type')
                .eq('profile_id', memberId)
                .order('endedAt', { ascending: false });
              groupRealtimeData.sessions[memberId] = (sRows || []).map(s => ({ ...s, endedAt: s.endedAt ? new Date(s.endedAt) : null, type: s.type || 'study' }));
              const sp = document.querySelector('#group-detail-nav .active')?.dataset.subpage;
              if (sp === 'rankings') renderGroupLeaderboard();
              if (sp === 'attendance') renderGroupAttendance();
          
              // realtime user
              const uChan = supabase
                .channel(`profiles:${memberId}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles', filter: `id=eq.${memberId}` }, (payload) => {
                  groupRealtimeData.members[memberId] = payload.new || payload.old;
                  const activeSubPage = document.querySelector('#group-detail-nav .active')?.dataset.subpage || 'home';
                    if (activeSubPage === 'home') {
                        const isStudiconView = document.getElementById('studicon-view-btn')?.classList.contains('active');
                        if (isStudiconView) {
                            renderGroupStudiconView();
                        } else {
                            renderGroupMembers();
                        }
                    }
                })
                .subscribe();
              groupDetailUnsubscribers.push(() => supabase.removeChannel(uChan));
          
              // realtime sessions
              const sChan = supabase
                .channel(`sessions:${memberId}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sessions', filter: `profile_id=eq.${memberId}` }, (payload) => {
                    const { eventType, old: oldRecord, new: newRecord } = payload;
                    const record = newRecord || oldRecord;
                    const recordMemberId = record?.profile_id;
                    if (!recordMemberId || !groupRealtimeData.sessions[recordMemberId]) return;
                    
                    const sessions = groupRealtimeData.sessions[recordMemberId];
                    const recordId = record.id;
                    const existingIndex = sessions.findIndex(s => s.id === recordId);
                    
                    const processRecord = (rec) => ({ ...rec, endedAt: rec.endedAt ? new Date(rec.endedAt) : null, type: rec.type || 'study' });

                    if (eventType === 'INSERT') {
                        if (existingIndex === -1) sessions.unshift(processRecord(newRecord));
                    } else if (eventType === 'UPDATE') {
                        if (existingIndex > -1) sessions[existingIndex] = processRecord(newRecord);
                    } else if (eventType === 'DELETE') {
                        if (existingIndex > -1) sessions.splice(existingIndex, 1);
                    }
                    
                    sessions.sort((a, b) => (b.endedAt || 0) - (a.endedAt || 0));

                    const currentSubpage = document.querySelector('#group-detail-nav .active')?.dataset.subpage;
                    if (currentSubpage === 'rankings') {
                        const isGlobal = document.getElementById('global-ranking-scope-btn')?.classList.contains('active');
                        const period = document.querySelector('#group-ranking-period-tabs .ranking-tab-btn.active')?.dataset.period || 'weekly';
                        if (isGlobal) {
                            renderLeaderboard(period, 'group-ranking-list');
                        } else {
                            renderGroupLeaderboard(period);
                        }
                    }
                    if (currentSubpage === 'attendance') {
                        renderGroupAttendance();
                    }
                })
                .subscribe();
              groupDetailUnsubscribers.push(() => supabase.removeChannel(sChan));
            });
          }          

        function renderGroupLeaderboard(period) {
            const container = document.getElementById('group-ranking-list');
            if (!container) return;

            if (!period) {
                period = document.querySelector('#group-ranking-period-tabs .ranking-tab-btn.active')?.dataset.period || 'weekly';
            }
            
            document.querySelectorAll('#group-ranking-period-tabs .ranking-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });

            const userScores = Object.keys(groupRealtimeData.members).map(memberId => {
                const memberData = groupRealtimeData.members[memberId];
                const memberSessions = groupRealtimeData.sessions[memberId] || [];

                const now = getCurrentDate();
                let startDate;
                switch (period) {
                    case 'daily': 
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); 
                        break;
                    case 'monthly': // Last 30 days
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - 30);
                        break;
                    case 'weekly': // Last 7 days
                    default:
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - 7);
                        break;
                }
                startDate.setHours(0,0,0,0);

                const totalSeconds = memberSessions
                    .filter(s => s.endedAt && s.endedAt >= startDate && s.type === 'study') // Only count study sessions for ranking
                    .reduce((sum, s) => sum + s.durationSeconds, 0);

                return {
                    id: memberId,
                    username: memberData.username || 'Anonymous',
                    photo_url: memberData.photo_url,
                    total_study_seconds: totalSeconds
                };
            });

            userScores.sort((a, b) => b.total_study_seconds - a.total_study_seconds);
            const periodText = period === 'daily' ? 'today' : period === 'weekly' ? 'in the last 7 days' : 'in the last 30 days';

            container.innerHTML = userScores.map((user, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                if (rank === 2) rankClass = 'rank-2';
                if (rank === 3) rankClass = 'rank-3';

                const avatarHTML = user.photo_url
                    ? `<img src="${user.photo_url}" class="w-full h-full object-cover">`
                    : `<span>${(user.username || 'U').charAt(0).toUpperCase()}</span>`;

                return `
                    <div class="ranking-item ${currentUser.id === user.id ? 'bg-blue-900/30' : ''}" data-user-id="${user.id}">
                        <div class="rank ${rankClass}">${rank}</div>
                        <div class="user-avatar bg-gray-600 overflow-hidden">${avatarHTML}</div>
                        <div class="user-info">
                            <div class="user-name">${user.username}</div>
                            <div class="user-time">${formatTime(user.total_study_seconds, false)} ${periodText}</div>
                        </div>
                    </div>
                `;
            }).join('') || `<div class="empty-group"><i class="fas fa-trophy"></i><h3>Leaderboard is Empty</h3><p>Start studying to see your rank!</p></div>`;
        }

        function renderGroupAttendance() {
            const container = document.getElementById('calendar-grid');
            if (!container) return;
            
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('current-month-display').textContent = `${monthNames[attendanceMonth]} ${attendanceYear}`;
            
            const firstDayOfMonth = new Date(attendanceYear, attendanceMonth, 1);
            const lastDayOfMonth = new Date(attendanceYear, attendanceMonth + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDay = firstDayOfMonth.getDay();
            
            container.innerHTML = Array(startDay).fill('<div class="calendar-day empty"></div>').join('');
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${attendanceYear}-${(attendanceMonth+1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                container.innerHTML += `
                    <div class="calendar-day ${isToday(attendanceYear, attendanceMonth, day) ? 'today' : ''}" data-date="${dateStr}">
                        <div class="day-number">${day}</div>
                        <div class="day-time">0h 0m</div>
                    </div>
                `;
            }
            
            const attendanceData = {};
            const memberAttendanceData = {};
            
            for(const memberId in groupRealtimeData.sessions) {
                memberAttendanceData[memberId] = { totalTime: 0, daysStudied: new Set() };
                const memberSessions = groupRealtimeData.sessions[memberId];
                memberSessions.forEach(session => {
                    // Check if session.endedAt is a Date object before using it
                    const sessionDate = session.endedAt instanceof Date ? session.endedAt : null;
                    if(sessionDate && sessionDate.getFullYear() === attendanceYear && sessionDate.getMonth() === attendanceMonth && session.type === 'study') { // Filter for study sessions
                        const dateStr = sessionDate.toISOString().split('T')[0];
                        attendanceData[dateStr] = (attendanceData[dateStr] || 0) + session.durationSeconds;
                        memberAttendanceData[memberId].totalTime += session.durationSeconds;
                        memberAttendanceData[memberId].daysStudied.add(dateStr);
                    }
                });
            }

            const calendarDays = document.querySelectorAll('.calendar-day:not(.empty)');
            let totalGroupTime = 0;
            let daysWithStudy = 0;
            
            calendarDays.forEach(dayEl => {
                const date = dayEl.dataset.date;
                const daySeconds = attendanceData[date] || 0;
                totalGroupTime += daySeconds;
                
                if (daySeconds > 0) {
                    daysWithStudy++;
                    dayEl.classList.add('active');
                }
                
                const hours = Math.floor(daySeconds / 3600);
                const minutes = Math.floor((daySeconds % 3600) / 60);
                dayEl.querySelector('.day-time').textContent = `${hours}h ${minutes}m`;
            });
            
            document.getElementById('total-hours').textContent = formatTime(totalGroupTime, false);
            document.getElementById('days-studied').textContent = daysWithStudy;
            const attendanceRate = Math.round((daysWithStudy / daysInMonth) * 100);
            document.getElementById('attendance-rate').textContent = `${attendanceRate}%`;
            
            const memberGrid = document.getElementById('attendance-member-grid');
            if (memberGrid) {
                memberGrid.innerHTML = Object.keys(groupRealtimeData.members).map(memberId => {
                    const userData = groupRealtimeData.members[memberId];
                    if (!userData) return '';
                    const memberStats = memberAttendanceData[memberId] || { totalTime: 0, daysStudied: new Set() };
                    const memberAttendanceRate = Math.round((memberStats.daysStudied.size / daysInMonth) * 100);
                    
                    const avatarHTML = userData.photo_url
                        ? `<img src="${userData.photo_url}" class="w-full h-full object-cover">`
                        : `<span>${(userData.username || 'U').charAt(0).toUpperCase()}</span>`;

                    return `
                        <div class="member-row">
                            <div class="member-avatar-sm overflow-hidden">${avatarHTML}</div>
                            <div class="member-info">
                                <div class="member-name-sm">${userData.username || 'Anonymous'}</div>
                                <div class="member-time-sm">${formatTime(memberStats.totalTime, false)} total</div>
                                <div class="attendance-progress">
                                    <div class="progress-bar" style="width: ${memberAttendanceRate}%"></div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold">${memberAttendanceRate}%</div>
                                <div class="text-xs text-gray-500">${memberStats.daysStudied.size}/${daysInMonth} days</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('prev-month-btn').onclick = () => {
                attendanceMonth--;
                if (attendanceMonth < 0) {
                    attendanceMonth = 11;
                    attendanceYear--;
                }
                renderGroupAttendance();
            };
            
            document.getElementById('next-month-btn').onclick = () => {
                attendanceMonth++;
                if (attendanceMonth > 11) {
                    attendanceMonth = 0;
                    attendanceYear++;
                }
                renderGroupAttendance();
            };
        }
        
        function isToday(year, month, day) {
            const today = getCurrentDate();
            return today.getFullYear() === year && 
                   today.getMonth() === month && 
                   today.getDate() === day;
        }
        
        function setupGroupChat(groupId) {
            const chatMessagesContainer = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            if (!chatMessagesContainer || !chatForm) return;
          
            async function loadMessages() {
              const { data: msgs, error } = await supabase
                .from('group_messages')
                .select('*')
                .eq('group_id', groupId)
                .order('created_at', { ascending: true });
              if (error) { console.error('load messages failed', error); return; }
          
              chatMessagesContainer.innerHTML = '';
              (msgs || []).forEach(msg => {
                const isSent = msg.sender_id === currentUser.id;
                const el = document.createElement('div');
                el.classList.add('chat-message', isSent ? 'sent' : 'received');
          
                let content = '';
                if (msg.text) content = `<div>${msg.text}</div>`;
                else if (msg.image_url) content = `<img src="${msg.image_url}" class="rounded-lg max-w-full h-auto cursor-pointer" style="max-height: 300px;" onclick="viewImage(this.src)">`;
          
                const ts = msg.created_at ? new Date(msg.created_at) : null;
                const timeText = ts ? ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
          
                el.innerHTML = `
                  <div class="chat-bubble ${isSent ? 'sent' : 'received'}">
                    ${!isSent ? `<div class="chat-sender">${msg.sender_name || ''}</div>` : ''}
                    ${content}
                    <div class="text-xs ${isSent ? 'text-blue-200' : 'text-gray-400'} text-right mt-1">${timeText}</div>
                  </div>`;
                chatMessagesContainer.appendChild(el);
              });
              chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }
          
            loadMessages();
          
            const chatChan = supabase
              .channel(`group_messages:${groupId}`)
              .on('postgres_changes', { event: '*', schema: 'public', table: 'group_messages', filter: `group_id=eq.${groupId}` }, loadMessages)
              .subscribe();
            groupDetailUnsubscribers.push(() => supabase.removeChannel(chatChan));
          
            chatForm.onsubmit = async (e) => {
              e.preventDefault();
              const text = chatInput.value.trim();
              if (!text || !currentUser) return;
          
              const senderName = currentUserData?.username || currentUser.email || 'Anonymous';
              const { error } = await supabase
                .from('group_messages')
                .insert([{ group_id: groupId, sender_id: currentUser.id, sender_name: senderName, text }]);
              if (error) { console.error('send msg failed', error); return; }
              chatInput.value = '';
            };
          }          

        // --- Event Listeners ---
        const ael = (id, event, callback) => {
            const el = document.getElementById(id);
            if (el) el.addEventListener(event, callback);
        };

        // --- START: NEW EVENT LISTENERS FOR GUEST MODE ---
        // Anonymous Auth
        ael('anonymous-signin-btn', 'click', async () => {
            try {
                await auth.signInAnonymously();
            } catch (error) {
                console.error("Anonymous sign-in failed:", error);
                if(authError) authError.textContent = "Could not sign in as guest. Please try again.";
            }
        });

        ael('go-to-auth-btn', 'click', async () => {
            // Sign out the anonymous user and show the auth screen
            await auth.signOut();
            // showPage will be called by onAuthStateChanged
        });
        // --- END: NEW EVENT LISTENERS FOR GUEST MODE ---

        // Auth
        ael('login-form', 'submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';

            const email = document.getElementById('login-email')?.value?.trim() || '';
            const password = document.getElementById('login-password')?.value || '';

            if (!email || !password) {
                authError.textContent = 'Email and password are required.';
                return;
            }

            try {
                const { data, error } = await auth.signInWithPassword({ email, password });
                if (error) {
                    authError.textContent =
                        error.message || 'Login failed. Check credentials or confirm your email.';
                    return;
                }
                await routeAfterAuth();
            } catch (err) {
                console.error('Login failed:', err);
                authError.textContent = 'Login failed. Please check your credentials.';
            }
        });

        ael('signup-form', 'submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';

            const email = document.getElementById('signup-email')?.value?.trim() || '';
            const password = document.getElementById('signup-password')?.value || '';

            // Client-side checks to avoid 422
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                authError.textContent = 'Please enter a valid email address.';
                return;
            }
            if ((password || '').length < 6) {
                authError.textContent = 'Password must be at least 6 characters long.';
                return;
            }

            try {
                const { data, error } = await auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: 'https://pulsepom.github.io/pulsepom1/',
                    },
                });
                if (error) {
                    authError.textContent = error.message;
                    return;
                }
                // If email confirmation is ON, session may be null until user verifies.
                await routeAfterAuth();
            } catch (error) {
                authError.textContent = error.message || 'Signup failed.';
            }
        });

        ael('auth-toggle-btn', 'click', () => {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const toggleText = document.getElementById('login-toggle-text');
            const toggleBtn = document.getElementById('auth-toggle-btn');
            authError.textContent = '';

            if (loginForm.classList.contains('hidden')) {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                toggleText.textContent = "Don't have an account?";
                toggleBtn.textContent = 'Sign Up';
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                toggleText.textContent = 'Already have an account?';
                toggleBtn.textContent = 'Sign In';
            }
        });

        const googleBtn = document.getElementById('google-signin-btn');
        if (googleBtn) {
            googleBtn.addEventListener('click', async () => {
                try {
                    const { data, error } = await supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: 'https://pulsepom.github.io/pulsepom1/',
                        },
                    });
                    if (error) throw error;
                } catch (err) {
                    console.error('Google sign-in error:', err);
                    alert('Google login failed: ' + err.message);
                }
            });
        }
        
        ael('username-setup-form', 'submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const usernameInput = document.getElementById('username-input');
            const username = usernameInput.value.trim();
            const usernameError = document.getElementById('username-error');
            const selectedAvatarEl = document.querySelector('#username-avatar-picker .avatar-option.selected img');
            const photoURL = selectedAvatarEl ? selectedAvatarEl.src : PRESET_AVATARS[0];

            if (username.length < 3) {
                usernameError.textContent = 'Username must be at least 3 characters.';
                return;
            }
            usernameError.textContent = '';

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ username, photo_url: photoURL })
                    .eq('id', currentUser.id);
                if (error) throw error;

                await supabase.from('profiles')
                    .update({ completed_setup: true })
                    .eq('id', currentUser.id);

                await loadMyProfile();
                showToast('Profile set! Welcome ðŸŽ‰', 'success');
                routeAfterAuth();

            } catch (error) {
                console.error("Error setting username:", error);
                usernameError.textContent = 'Failed to save profile. Please try again.';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Save Profile';
            }
        });

        ael('sign-out-btn', 'click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Sign out error", error);
                showToast("Failed to sign out.", "error");
            }
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', function() {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            const pageName = this.dataset.page;
            showPage(`page-${pageName}`);
        }));

        document.querySelectorAll('.back-button').forEach(button => button.addEventListener('click', function() {
            const targetPage = this.getAttribute('data-target');
            showPage(`page-${targetPage}`);
            const navItem = document.querySelector(`.nav-item[data-page="${targetPage}"]`);
            if (navItem) {
                 document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                 navItem.classList.add('active');
            }
        }));

        // --- START: ADDED GUARDS FOR GUEST USERS ---
        ael('groups-btn', 'click', () => { 
            if (currentUser && currentUser.isAnonymous) {
                showToast('Please create an account to use study groups.', 'info');
                showPage('page-profile');
                return;
            }
            renderJoinedGroups(); 
            showPage('page-my-groups'); 
        });
        ael('go-to-find-groups-btn', 'click', () => { 
             if (currentUser && currentUser.isAnonymous) {
                showToast('Please create an account to use study groups.', 'info');
                return;
            }
            renderGroupRankings(); 
            showPage('page-find-groups'); 
        });
        ael('go-to-create-group-btn', 'click', () => { 
             if (currentUser && currentUser.isAnonymous) {
                showToast('Please create an account to use study groups.', 'info');
                return;
            }
            showPage('page-create-group'); 
        });
        // --- END: ADDED GUARDS FOR GUEST USERS ---
        ael('profile-btn', 'click', () => { showPage('page-profile'); });
        
        // --- FIXES START HERE ---

        // Timer Controls
        ael('start-studying-btn', 'click', () => {
            document.getElementById('start-session-modal').classList.add('active');
        });
        
        ael('stop-studying-btn', 'click', () => {
             showConfirmationModal(
                'Stop Studying?',
                'Are you sure you want to end this study session?',
                () => stopTimer()
            );
        });

        ael('pause-btn', 'click', pauseTimer);
        ael('resume-btn', 'click', resumeTimer);
        
        ael('start-session-form', 'submit', (e) => {
            e.preventDefault();
            const selectedSubjectEl = document.querySelector('#subject-selection-list .subject-item.selected');
            if (selectedSubjectEl) {
                const subjectName = selectedSubjectEl.dataset.subjectName;
                startTimer(subjectName);
                document.getElementById('start-session-modal').classList.remove('active');
            } else {
                showToast("Please select a subject to start studying.", "error");
            }
        });

        // This listener replaces the original 'subject-selection-list' click listener
        // to handle more actions like edit and delete using event delegation.
        ael('start-session-modal', 'click', async (e) => {
            const subjectItem = e.target.closest('.subject-item');
            
            // Handle clicking the options button (...)
            if (e.target.closest('.subject-options-btn')) {
                const menu = e.target.closest('.subject-options-btn').nextElementSibling;
                // Close other menus before opening the new one
                document.querySelectorAll('.subject-options-menu').forEach(m => {
                    if (m !== menu) m.classList.remove('active');
                });
                menu.classList.toggle('active');
                return;
            }

            // Handle clicking the delete button
            if (e.target.closest('.delete-subject-btn')) {
                const subjectId = subjectItem.dataset.subjectId;
                const subjectName = subjectItem.dataset.subjectName;
                showConfirmationModal(
                    `Delete "${subjectName}"?`,
                    'This subject will be removed. This action cannot be undone.',
                    async () => {
                        const { error } = await supabase
                            .from('subjects')
                            .delete()
                            .eq('id', subjectId);
                        
                        if (error) {
                            console.error('Failed to delete subject', error);
                            showToast('Failed to delete subject.', 'error');
                        } else {
                            showToast('Subject deleted.', 'success');
                            loadSubjects(); // Manually refresh the list
                        }
                    }
                );
                return;
            }
            
            // Handle clicking the edit button
            if (e.target.closest('.edit-subject-btn')) {
                const subjectId = subjectItem.dataset.subjectId;
                const { data: subject, error } = await supabase
                    .from('subjects')
                    .select('id, name, color')
                    .eq('id', subjectId)
                    .single();

                if (error || !subject) {
                    showToast('Could not load subject data to edit.', 'error');
                    return;
                }
                
                // Configure and show the "Add/Edit" modal for editing
                const modal = document.getElementById('add-subject-modal');
                document.getElementById('add-subject-modal-title').textContent = 'Edit Subject';
                document.getElementById('add-subject-submit-btn').textContent = 'Save Changes';
                document.getElementById('edit-subject-id').value = subject.id;
                document.getElementById('add-subject-name').value = subject.name;
                
                // Set the correct color
                modal.querySelectorAll('.color-dot').forEach(el => {
                    el.classList.toggle('selected', el.dataset.color === subject.color);
                });
                
                document.getElementById('start-session-modal').classList.remove('active');
                modal.classList.add('active');
                return;
            }

            // Handle selecting a subject (original functionality)
            if (subjectItem && !e.target.closest('button')) {
                document.querySelectorAll('#subject-selection-list .subject-item.selected').forEach(el => el.classList.remove('selected'));
                subjectItem.classList.add('selected');
            }
        });

        // Timer Mode Switch
        function switchTimerMode(mode) {
            if (timerMode === mode || pomodoroState !== 'idle') {
                if (pomodoroState !== 'idle') {
                    showToast('Cannot switch modes during an active session.', 'error');
                }
                return;
            }

            timerMode = mode;
            document.getElementById('normal-timer-btn').classList.toggle('active', mode === 'normal');
            document.getElementById('pomodoro-timer-btn').classList.toggle('active', mode === 'pomodoro');

            if (mode === 'pomodoro') {
                sessionTimerDisplay.textContent = formatPomodoroTime(pomodoroSettings.work * 60);
                pomodoroStatusDisplay.textContent = 'Ready for Pomodoro';
                pomodoroStatusDisplay.style.color = '#9ca3af';
            } else { // 'normal'
                sessionTimerDisplay.textContent = formatTime(0);
                pomodoroStatusDisplay.textContent = '';
            }
        }
        
        ael('normal-timer-btn', 'click', () => switchTimerMode('normal'));
        ael('pomodoro-timer-btn', 'click', () => switchTimerMode('pomodoro'));

        // --- NEW UNIFIED PLANNER EVENT LISTENERS ---
        // This single block handles all interactions within the planner for robustness
        const plannerPage = document.getElementById('page-planner');
        if (plannerPage) {
            let detailUpdateDebounceTimer;

            // Main click handler
            plannerPage.addEventListener('click', e => {
                const target = e.target;
                
                // --- NEW: Category List Item Click ---
                const categoryItem = target.closest('.planner-list-item');
                if (categoryItem) {
                    const category = categoryItem.dataset.category;
                    if(category) {
                        plannerState.activeCategory = category;
                        renderPlannerMainContent();
                    }
                    return;
                }
                
                // --- NEW: Category View Back Button ---
                if (target.closest('.category-back-btn')) {
                    plannerState.activeCategory = 'list';
                    plannerState.showCompletedInCategory = false; // Reset toggle on exit
                    renderPlannerMainContent();
                    return;
                }

                // --- NEW: Category View Checkbox ---
                const categoryCheckbox = target.closest('.task-checkbox-category');
                if (categoryCheckbox) {
                    const taskItem = categoryCheckbox.closest('.category-task-item');
                    const taskId = taskItem.dataset.taskId;
                    const isCompleted = !categoryCheckbox.classList.contains('completed');
                    updatePlannerTask(taskId, {
                        completed: isCompleted,
                        completedAt: isCompleted ? nowIso() : null
                    });
                    return;
                }

                // --- NEW: Completed Tasks Toggle ---
                if (target.closest('.completed-tasks-toggle')) {
                    plannerState.showCompletedInCategory = !plannerState.showCompletedInCategory;
                    renderPlannerCategoryView(plannerState.activeCategory);
                    return;
                }

                // --- Calendar day click for adding task ---
                const dayCell = target.closest('.calendar-day-cell:not(.other-month)');
                if (dayCell && !target.closest('.calendar-task')) {
                    const dateStr = dayCell.dataset.date;
                    if (dateStr) {
                        const modal = document.getElementById('quick-add-task-modal');
                        document.getElementById('quick-add-task-date').textContent = new Date(dateStr + 'T00:00:00').toLocaleDateString(undefined, { month: 'long', day: 'numeric' });
                        document.getElementById('quick-add-task-date-input').value = dateStr;
                        modal.classList.add('active');
                        document.getElementById('quick-add-task-title-input').focus();
                    }
                    return; 
                }

                // View switcher
                const viewBtn = target.closest('.planner-view-btn');
                if (viewBtn && !viewBtn.classList.contains('active')) {
                    plannerState.currentView = viewBtn.dataset.view;
                    renderPlannerMainContent();
                    return;
                }

                // Sidebar list selection
                const sidebarItem = target.closest('.planner-sidebar-item');
                if (sidebarItem && !sidebarItem.classList.contains('active')) {
                    plannerState.activeListId = sidebarItem.dataset.listId;
                    plannerState.selectedTaskId = null; // Deselect task when changing lists
                    renderPlannerPage();
                    return;
                }
                
                // Calendar navigation
                const calNavBtn = target.closest('.calendar-nav-btn');
                if (calNavBtn) {
                    const direction = calNavBtn.dataset.direction;
                    if (direction === 'today') {
                        plannerState.calendarYear = new Date().getFullYear();
                        plannerState.calendarMonth = new Date().getMonth();
                    } else if (direction === 'next') {
                        plannerState.calendarMonth++;
                        if (plannerState.calendarMonth > 11) {
                            plannerState.calendarMonth = 0;
                            plannerState.calendarYear++;
                        }
                    } else if (direction === 'prev') {
                        plannerState.calendarMonth--;
                        if (plannerState.calendarMonth < 0) {
                            plannerState.calendarMonth = 11;
                            plannerState.calendarYear--;
                        }
                    }
                    renderPlannerCalendarView(plannerState.tasks.filter(t => t.listId === plannerState.activeListId));
                    return;
                }

                // Task item selection (to open details)
                const taskItem = target.closest('.task-item, .kanban-card, .calendar-task, .category-task-item');
                if (taskItem && !target.matches('input[type="checkbox"]') && !target.closest('.task-play-btn')) {
                    const taskId = taskItem.dataset.taskId;
                    if (taskId !== plannerState.selectedTaskId) {
                        plannerState.selectedTaskId = taskId;
                        renderPlannerPage();
                    }
                    return;
                }

                // Task details panel buttons
                const detailsPanel = target.closest('#planner-task-details');
                if(detailsPanel) {
                    const taskId = plannerState.selectedTaskId;
                    if (!taskId) return;
                    
                    // Priority menu toggle
                    if (target.closest('#task-detail-priority-btn')) {
                        const menu = detailsPanel.querySelector('#task-priority-menu');
                        if (menu) menu.classList.toggle('hidden');
                        return; 
                    }

                    // Priority menu item selection
                    if (target.closest('#task-priority-menu a')) {
                        e.preventDefault();
                        const newPriority = target.closest('a').dataset.priority;
                        updatePlannerTask(taskId, { priority: newPriority });
                        detailsPanel.querySelector('#task-priority-menu').classList.add('hidden');
                        return;
                    }

                    // Start Timer Buttons (Normal or Pomodoro)
                    if (target.closest('#task-detail-start-btn') || target.closest('#task-detail-pomodoro-btn')) {
                        const task = plannerState.tasks.find(t => t.id === taskId);
                        if (task) {
                            const subjectName = task.title;
                            showPage('page-timer');
                            const navItem = document.querySelector(`.nav-item[data-page="timer"]`);
                            if (navItem) {
                                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                                navItem.classList.add('active');
                            }

                            const pomodoroBtnClicked = target.closest('#task-detail-pomodoro-btn');
                            if (pomodoroBtnClicked) {
                                switchTimerMode('pomodoro');
                            } else {
                                switchTimerMode('normal');
                            }
                            startTimer(subjectName);
                        }
                        return;
                    }

                    // Project button click
                    if (target.closest('#task-detail-project-btn')) {
                        const modal = document.getElementById('project-select-modal');
                        const listContainer = document.getElementById('project-select-list');
                        const selectedTask = plannerState.tasks.find(t => t.id === taskId);
                        
                        listContainer.innerHTML = `
                            <div class="planner-sidebar-item cursor-pointer ${selectedTask.listId === 'inbox' ? 'active' : ''}" data-list-id="inbox">
                                <i class="fas fa-inbox w-5 mr-3"></i>
                                <span>Inbox</span>
                            </div>
                            ${plannerState.lists.map(list => `
                                <div class="planner-sidebar-item cursor-pointer ${selectedTask.listId === list.id ? 'active' : ''}" data-list-id="${list.id}">
                                    <i class="fas fa-folder w-5 mr-3"></i>
                                    <span>${list.name}</span>
                                </div>
                            `).join('')}
                        `;
                        modal.classList.add('active');
                        return;
                    }

                    // Repeat button click
                    if (target.closest('#task-detail-repeat-btn')) {
                        const modal = document.getElementById('repeat-settings-modal');
                        const select = document.getElementById('repeat-type-select');
                        const selectedTask = plannerState.tasks.find(t => t.id === taskId);
                        
                        select.value = selectedTask.repeat?.type || 'none';
                        
                        modal.classList.add('active');
                        return;
                    }

                    if (target.closest('#close-task-details')) {
                        plannerState.selectedTaskId = null;
                        renderPlannerTaskDetails(); 
                    }
                    else if (target.closest('#delete-task-btn')) {
                        showConfirmationModal('Delete Task?', 'This task will be permanently deleted.', () => deletePlannerTask(taskId));
                    }
                }

                 // Hide priority menu if clicking outside
                const priorityMenu = document.getElementById('task-priority-menu');
                if (priorityMenu && !priorityMenu.classList.contains('hidden') && !target.closest('#task-detail-priority-btn')) {
                    priorityMenu.classList.add('hidden');
                }
            });

            // Handler for form inputs that change value
            plannerPage.addEventListener('change', e => {
                const target = e.target;

                // Task checkbox in list view
                if (target.classList.contains('task-checkbox-planner')) {
                    const taskId = target.closest('.task-item, #planner-task-details').dataset.taskId || plannerState.selectedTaskId;
                    if (taskId) {
                        const isCompleted = target.checked;
                        updatePlannerTask(taskId, {
                            completed: isCompleted,
                            completedAt: isCompleted ? nowIso() : null
                        });
                    }
                }
                
                // Due date change in details panel
                if (target.matches('#task-detail-due-date')) {
                    const taskId = plannerState.selectedTaskId;
                    if (taskId) {
                        const newDate = target.value ? new Date(target.value + 'T00:00:00') : null;
                        updatePlannerTask(taskId, { dueDate: newDate });
                    }
                }
            });

            // Handler for form inputs that change value
            plannerPage.addEventListener('change', e => {
                const target = e.target;

                // Task checkbox in list view
                if (target.classList.contains('task-checkbox-planner')) {
                    const taskId = target.closest('.task-item').dataset.taskId;
                    const isCompleted = target.checked;
                    updatePlannerTask(taskId, {
                        completed: isCompleted,
                        completedAt: isCompleted ? nowIso() : null // Add/remove completion timestamp
                    });
                }
            });

            // Handler for form inputs that change value
            plannerPage.addEventListener('change', e => {
                const target = e.target;
                if(target.closest('#planner-task-details')) {
                    const taskId = plannerState.selectedTaskId;
                    if (!taskId) return;

                    if (target.matches('#task-detail-title, #task-detail-notes')) {
                        clearTimeout(detailUpdateDebounceTimer);
                        detailUpdateDebounceTimer = setTimeout(() => {
                            const updateData = {};
                            if (target.id === 'task-detail-title') updateData.title = target.value;
                            if (target.id === 'task-detail-notes') updateData.notes = target.value;
                            updatePlannerTask(taskId, updateData);
                        }, 750); // Debounce by 750ms
                    }
                }
            });
        }
        // --- END OF UNIFIED PLANNER LISTENERS ---

        ael('quick-add-task-form', 'submit', async (e) => {
            e.preventDefault();
            const modal = document.getElementById('quick-add-task-modal');
            const titleInput = document.getElementById('quick-add-task-title-input');
            const dateInput = document.getElementById('quick-add-task-date-input');
            
            const title = titleInput.value.trim();
            const date = dateInput.value;

            if (title && date) {
                await addPlannerTask(title, date);
                titleInput.value = '';
                modal.classList.remove('active');
            } else {
                showToast('Please enter a title for the task.', 'error');
            }
        });

        // Add Subject Modal
        ael('add-subject-btn', 'click', () => {
            isAddingSubjectFromStartSession = false; // Reset flag
            resetAndShowAddSubjectModal();
        });

        ael('open-add-subject-modal-from-start', 'click', () => {
            isAddingSubjectFromStartSession = true; // Set flag
            document.getElementById('start-session-modal').classList.remove('active');
            resetAndShowAddSubjectModal();
        });

        ael('add-subject-form', 'submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const subjectNameInput = document.getElementById('add-subject-name');
            const subjectName = subjectNameInput.value.trim();
            const colorEl = document.querySelector('#add-subject-modal .color-dot.selected');
            const editId = document.getElementById('edit-subject-id').value;

            if (!subjectName || !colorEl) {
                showToast('Please provide a name and select a color.', 'error');
                return;
            }
            const color = colorEl.dataset.color;

            try {
                if (editId) {
                    // Update existing subject
                    const { error } = await supabase
                        .from('subjects')
                        .update({ name: subjectName, color: color })
                        .eq('id', editId);
                    if (error) throw error;
                    showToast('Subject updated!', 'success');
                } else {
                    // Add new subject
                    const { data: lastSubject } = await supabase
                        .from('subjects')
                        .select('order')
                        .eq('profile_id', currentUser.id)
                        .order('order', { ascending: false })
                        .limit(1)
                        .maybeSingle();
                    const lastOrder = lastSubject?.order ?? -1;

                    const { error } = await supabase.from('subjects').insert({
                        profile_id: currentUser.id,
                        name: subjectName,
                        color,
                        order: lastOrder + 1
                    });
                    if (error) throw error;
                    showToast(`Subject "${subjectName}" added!`, 'success');
                }

                loadSubjects(); // Manually refresh the list for immediate feedback.

                // Close and reset modal
                const modal = document.getElementById('add-subject-modal');
                modal.classList.remove('active');
                
                if (isAddingSubjectFromStartSession && !editId) {
                     setTimeout(() => {
                        document.getElementById('start-session-modal').classList.add('active');
                    }, 300);
                }

            } catch (error) {
                console.error('Error saving subject:', error);
                showToast('Could not save subject.', 'error');
            }
        });
        
        // Add Subject Modal Color Picker
        ael('add-subject-modal', 'click', (e) => {
            if (e.target.classList.contains('color-dot')) {
                document.querySelectorAll('#add-subject-modal .color-dot').forEach(el => el.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });


        // NEW: Project Selection Modal
        ael('project-select-modal', 'click', (e) => {
            const projectItem = e.target.closest('.planner-sidebar-item');
            if (projectItem) {
                const newListId = projectItem.dataset.listId;
                const taskId = plannerState.selectedTaskId;
                if (taskId && newListId) {
                    updatePlannerTask(taskId, { listId: newListId });
                    document.getElementById('project-select-modal').classList.remove('active');
                }
            }
        });

        // NEW: Repeat Settings Form
        ael('repeat-settings-form', 'submit', (e) => {
            e.preventDefault();
            const taskId = plannerState.selectedTaskId;
            const repeatType = document.getElementById('repeat-type-select').value;
            
            if (taskId) {
                const newRepeatValue = repeatType === 'none' ? null : { type: repeatType };
                updatePlannerTask(taskId, { repeat: newRepeatValue });
                document.getElementById('repeat-settings-modal').classList.remove('active');
            }
        });


        // Create Group Controls
        ael('create-group-done-btn', 'click', async () => {
            const form = document.getElementById('create-group-form');
            const nameInput = document.getElementById('group-name-input');
            const descriptionInput = document.getElementById('group-description-input');
            
            if (!nameInput.value.trim() || !descriptionInput.value.trim()) {
                showToast('Group Name and Description are required.', 'error');
                if (!nameInput.value.trim()) nameInput.focus();
                else if (!descriptionInput.value.trim()) descriptionInput.focus();
                return;
            }
        
            const name = nameInput.value.trim();
            const password = document.getElementById('group-password-input').value.trim();
            const category = form.querySelector('.category-option.selected').textContent;
            const time_goal = parseInt(form.querySelector('.time-option.selected').textContent, 10);
            const capacity = parseInt(document.getElementById('capacity-value').textContent, 10);
            const description = descriptionInput.value.trim();
            
            const doneBtn = document.getElementById('create-group-done-btn');
            doneBtn.disabled = true;
            doneBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        
            try {
                const { data: newGroup, error: createError } = await supabase
                    .from('groups')
                    .insert({
                        name,
                        password: password || null,
                        category,
                        time_goal,
                        capacity,
                        description,
                        leaderId: currentUser.id,
                        leaderName: currentUserData.username,
                        created_at: nowIso(),
                        avgTime: '0h 0m',
                        attendance: 0,
                        members: [currentUser.id]
                    })
                    .select()
                    .single();
                if (createError) throw createError;

                const { error: joinError } = await supabase.from('group_members').insert({
                    group_id: newGroup.id,
                    profile_id: currentUser.id
                });
                if (joinError) throw joinError;

                const { data: profileData, error: profileErr } = await supabase
                    .from('profiles')
                    .select('joined_groups')
                    .eq('id', currentUser.id)
                    .single();
                if (profileErr) throw profileErr;
                const joinedGroups = Array.isArray(profileData.joined_groups) ? profileData.joined_groups.slice() : [];
                if (!joinedGroups.includes(newGroup.id)) {
                    joinedGroups.push(newGroup.id);
                }
                await updateProfile(currentUser.id, { joined_groups: joinedGroups });

                showToast('Group created successfully!', 'success');
                renderGroupRankings();
                showPage('page-find-groups');
                form.reset();
            } catch (error) {
                console.error('Error creating group:', error);
                showToast('Failed to create group.', 'error');
            } finally {
                doneBtn.disabled = false;
                doneBtn.textContent = 'Done';
            }
        });

        ael('create-group-form', 'click', (e) => {
            if (e.target.classList.contains('category-option')) {
                document.querySelectorAll('#create-group-form .category-option').forEach(el => el.classList.remove('selected'));
                e.target.classList.add('selected');
            }
            if (e.target.classList.contains('time-option')) {
                document.querySelectorAll('#create-group-form .time-option').forEach(el => el.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });
        
        ael('increase-capacity', 'click', () => {
            const capacityEl = document.getElementById('capacity-value');
            let current = parseInt(capacityEl.textContent, 10);
            if (current < 100) capacityEl.textContent = current + 1;
        });
        
        ael('decrease-capacity', 'click', () => {
            const capacityEl = document.getElementById('capacity-value');
            let current = parseInt(capacityEl.textContent, 10);
            if (current > 2) capacityEl.textContent = current - 1;
        });

        // --- FIXES END HERE ---

        ael('page-my-groups', 'click', (e) => {
            // Handle clicking on a group card to enter the detail view
            const groupCard = e.target.closest('.group-card');
            if (groupCard) {
                const groupId = groupCard.dataset.groupId;
                if (groupId) {
                    renderGroupDetail(groupId); // Render first to have content when page shows
                    showPage('page-group-detail');
                }
            }

            // Handle the "Explore Groups" button on the empty state
            if (e.target.id === 'explore-groups-btn') {
                renderGroupRankings(); 
                showPage('page-find-groups');
            }
        });
        
        // Profile Settings Modals
        const editProfileModal = document.getElementById('edit-profile-modal');
        ael('settings-account', 'click', () => {
            document.getElementById('edit-username-input').value = currentUserData.username || '';
            const profileAvatarContainer = document.querySelector('.profile-header .profile-avatar');
            profileAvatarContainer.style.cursor = 'pointer';
            
            editProfileModal.classList.add('active');
        });
        
        const studyGoalModal = document.getElementById('study-goal-modal');
        ael('settings-study-goal', 'click', () => {
            if (studyGoalModal) {
                document.getElementById('study-goal-input').value = currentUserData.study_goal_hours || '';
                studyGoalModal.classList.add('active');
            }
        });

        const pomodoroSettingsModal = document.getElementById('pomodoro-settings-modal');
        ael('settings-pomodoro', 'click', () => {
            document.getElementById('pomodoro-work-duration').value = pomodoroSettings.work;
            document.getElementById('pomodoro-short-break-duration').value = pomodoroSettings.short_break;
            document.getElementById('pomodoro-long-break-duration').value = pomodoroSettings.long_break;
            document.getElementById('pomodoro-long-break-interval').value = pomodoroSettings.long_break_interval;
            document.getElementById('pomodoro-auto-start-focus').checked = pomodoroSettings.autoStartFocus;
            document.getElementById('pomodoro-auto-start-break').checked = pomodoroSettings.autoStartBreak;
            document.getElementById('pomodoro-volume').value = pomodoroSounds.volume;
            
            const soundDropdowns = [
                { id: 'pomodoro-start-sound', key: 'start' },
                { id: 'pomodoro-focus-sound', key: 'focus' },
                { id: 'pomodoro-break-sound', key: 'break' }
            ];
            soundDropdowns.forEach(dd => {
                const selectEl = document.getElementById(dd.id);
                selectEl.innerHTML = '';
                for (const [name, url] of Object.entries(availableSounds)) {
                    const option = document.createElement('option');
                    option.value = url;
                    option.textContent = name;
                    if (url === pomodoroSounds[dd.key]) {
                        option.selected = true;
                    }
                    selectEl.appendChild(option);
                }
            });
            pomodoroSettingsModal.classList.add('active');
        });
        
        async function openEditGroupInfoModal() {
            if (!currentGroupId) return;
            const modal = document.getElementById('edit-group-info-modal');
            if (!modal) {
                console.error("Fatal: The entire 'edit-group-info-modal' is missing from the DOM.");
                return;
            }

            const groupData = await fetchGroup(currentGroupId);

            if (groupData) {
                
                // Helper to safely set the value of an element
                const setValue = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.value = value;
                    } else {
                        // This log will help find the exact missing element id
                        console.error(`Element with ID '${id}' not found inside openEditGroupInfoModal.`);
                    }
                };

                setValue('edit-group-id-input', currentGroupId);
                setValue('edit-group-name', groupData.name);
                setValue('edit-group-description', groupData.description);
                setValue('edit-group-category', groupData.category);
                setValue('edit-group-goal', groupData.time_goal);
                setValue('edit-group-capacity', groupData.capacity);
                setValue('edit-group-password', groupData.password || '');

                modal.classList.add('active');
            } else {
                showToast('Could not load group data.', 'error');
            }
        }

        ael('study-goal-form', 'submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const goal = parseInt(document.getElementById('study-goal-input').value, 10);
            if (isNaN(goal) || goal < 1 || goal > 24) {
                showToast('Please enter a valid goal between 1 and 24.', 'error');
                return;
            }
            const { error: upErr } = await supabase
                .from('profiles')
                .update({ study_goal_hours: goal })
                .eq('id', currentUser.id);
            if (upErr) {
                showToast('Failed to update study goal.', 'error');
                return;
            }
            currentUserData.study_goal_hours = goal;
            studyGoalModal.classList.remove('active');
            showToast('Study goal updated!', 'success');
        });

        ael('page-find-groups', 'click', (e) => {
            const sortBtn = e.target.closest('#group-ranking-sort-tabs .group-filter-btn');
            if (sortBtn && !sortBtn.classList.contains('active')) {
                document.querySelectorAll('#group-ranking-sort-tabs .group-filter-btn').forEach(btn => btn.classList.remove('active'));
                sortBtn.classList.add('active');
                renderGroupRankings();
            }
            const filterCheckbox = e.target.closest('#group-ranking-filters input[type="checkbox"]');
            if (filterCheckbox) {
                renderGroupRankings();
            }
        });

        ael('group-detail-nav', 'click', (e) => {
            const navItem = e.target.closest('.group-nav-item');
            if (navItem && !navItem.classList.contains('active')) {
                const subpage = navItem.dataset.subpage;
                renderGroupSubPage(subpage);
            }
        });
        
        ael('page-group-detail', 'click', async e => {
            const settingsBtn = e.target.closest('#group-settings-btn, #group-settings-btn-mobile');
            if (settingsBtn) {
                const groupData = await fetchGroup(currentGroupId);
                if (groupData) {
                    openGroupSettingsModal(groupData);
                }
                return;
            }

            const rulesBtn = e.target.closest('#group-rules-header-btn');
            if (rulesBtn) {
                openGroupRulesModal();
                return;
            }

            const wakeUpBtn = e.target.closest('.wake-up-btn');
            if (wakeUpBtn && !wakeUpBtn.disabled) {
                const targetUserId = wakeUpBtn.dataset.targetUserId;
                const targetUserName = wakeUpBtn.dataset.targetUserName;
                
                showConfirmationModal(
                    `Send Wake Up Call?`,
                    `This will send a notification to ${targetUserName}.`,
                    async () => {
                        try {
                            wakeUpBtn.disabled = true;
                            wakeUpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                            
                            const { data, error } = await supabase.functions.invoke('send-wake-up-notification', {
                                body: {
                                    targetUserId,
                                    senderName: currentUserData.username,
                                    appId
                                }
                            });

                            if (!error && data?.success) {
                                showToast(`Wake up call sent to ${targetUserName}!`, 'success');
                            } else {
                                showToast(data?.message || 'Could not send wake up call.', 'error');
                            }
                        } catch (error) {
                            console.error("Error sending wake up call:", error);
                            showToast('An error occurred.', 'error');
                        } finally {
                            wakeUpBtn.disabled = false;
                            wakeUpBtn.innerHTML = '<i class="fas fa-bell"></i> Wake Up';
                        }
                    }
                );
                return;
            }

            // Studicon Store Button
            const storeBtn = e.target.closest('#studicon-store-btn, #studicon-store-btn-mobile');
            if (storeBtn) {
                openStudiconStore();
                return;
            }

            // View Switcher Button
            const viewBtn = e.target.closest('[data-view-target]');
            if (viewBtn && !viewBtn.classList.contains('active')) {
                const targetView = viewBtn.dataset.viewTarget;

                // Update both desktop and mobile switches to stay in sync
                document.querySelectorAll('[data-view-target]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.viewTarget === targetView);
                });

                renderGroupSubPage('home'); // Re-render the home subpage with the new view
                return;
            }
            
            const attachBtn = e.target.closest('#chat-attach-btn');
            if (attachBtn) {
                document.getElementById('chat-attachment-menu').classList.toggle('hidden');
            } else if (!e.target.closest('#chat-attachment-menu')) {
                 const menu = document.getElementById('chat-attachment-menu');
                 if(menu) menu.classList.add('hidden');
            }

            const chatAction = e.target.closest('[data-chat-action]');
            if (chatAction) {
                const action = chatAction.dataset.chatAction;
                if (action === 'album') {
                    document.getElementById('image-upload-input').click();
                } else {
                    showToast(`${action.charAt(0).toUpperCase() + action.slice(1)} upload coming soon!`, 'info');
                }
                 document.getElementById('chat-attachment-menu').classList.add('hidden');
            }

            const userProfileTrigger = e.target.closest('.member-profile-link, .studicon-member-card');
            if (userProfileTrigger) {
                const userId = userProfileTrigger.closest('[data-user-id]').dataset.userId;
                if (userId && userId !== currentUser.id) {
                    showUserProfileModal(userId);
                }
            }
        });

        function openGroupSettingsModal(groupData) {
            const modal = document.getElementById('group-settings-modal');
            const isLeader = currentUser.id === groupData.leaderId;

            modal.querySelectorAll('.group-settings-item').forEach(item => {
                const action = item.dataset.action;
                const leaderActions = ['edit-info', 'kick-member', 'promote-member', 'member-logs', 'group-settings', 'wake-up-group'];
                
                if (leaderActions.includes(action) && !isLeader) {
                    item.style.opacity = '0.5';
                    item.style.cursor = 'not-allowed';
                    item.dataset.disabled = 'true';
                } else {
                    item.style.opacity = '1';
                    item.style.cursor = 'pointer';
                    item.dataset.disabled = 'false';
                }
            });
            
            modal.classList.add('active');
        }

        async function openGroupRulesModal() {
            if (!currentGroupId) return;

            const modal = document.getElementById('group-rules-modal');
            const displayEl = document.getElementById('group-rules-display');
            const editContainer = document.getElementById('group-rules-edit-container');
            const textarea = document.getElementById('group-rules-textarea');
            const controlsEl = document.getElementById('group-rules-controls');
            const saveBtn = document.getElementById('save-group-rules-btn');

            try {
                const groupData = await fetchGroup(currentGroupId);

                if (!groupData) {
                    showToast('Could not load group rules.', 'error');
                    return;
                }

                const rules = groupData.rules || 'No rules have been set for this group yet.';
                const isLeader = currentUser.id === groupData.leaderId;

                // Reset state
                displayEl.textContent = rules;
                textarea.value = rules;
                displayEl.classList.remove('hidden');
                editContainer.classList.add('hidden');
                controlsEl.innerHTML = '';

                if (isLeader) {
                    controlsEl.innerHTML = '<button id="edit-group-rules-btn" class="text-sm text-blue-400 hover:text-blue-300 font-semibold">Edit</button>';
                    
                    const editBtn = document.getElementById('edit-group-rules-btn');
                    editBtn.onclick = () => {
                        displayEl.classList.add('hidden');
                        editContainer.classList.remove('hidden');
                        editBtn.classList.add('hidden');
                    };
                }

                saveBtn.onclick = async () => {
                    const newRules = textarea.value.trim();
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                    
                    try {
                        await updateGroup(currentGroupId, { rules: newRules });
                        showToast('Group rules updated!', 'success');
                        modal.classList.remove('active');
                    } catch (error) {
                        console.error("Error saving group rules:", error);
                        showToast('Failed to save rules.', 'error');
                    } finally {
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save Rules';
                    }
                };

                modal.classList.add('active');

            } catch (error) {
                console.error("Error opening group rules modal:", error);
                showToast('An error occurred.', 'error');
            }
        }

        ael('pomodoro-settings-form', 'submit', async (e) => {
            e.preventDefault();
            const newSettings = {
                work: parseInt(document.getElementById('pomodoro-work-duration').value, 10),
                short_break: parseInt(document.getElementById('pomodoro-short-break-duration').value, 10),
                long_break: parseInt(document.getElementById('pomodoro-long-break-duration').value, 10),
                long_break_interval: parseInt(document.getElementById('pomodoro-long-break-interval').value, 10),
                autoStartFocus: document.getElementById('pomodoro-auto-start-focus').checked,
                autoStartBreak: document.getElementById('pomodoro-auto-start-break').checked,
            };
            const newSounds = {
                start: document.getElementById('pomodoro-start-sound').value,
                focus: document.getElementById('pomodoro-focus-sound').value,
                break: document.getElementById('pomodoro-break-sound').value,
                volume: parseFloat(document.getElementById('pomodoro-volume').value)
            };

            if (Object.values(newSettings).some(v => typeof v === 'number' && (isNaN(v) || v < 1))) {
                showToast("Please enter valid, positive numbers for all duration settings.", "error");
                return;
            }
            
            if (currentUser) {
                await updateUserPrivate(currentUser.id, {
                    pomodoro_settings: newSettings,
                    pomodoro_sounds: newSounds
                });
            }

            pomodoroSettings = newSettings;
            pomodoroSounds = newSounds;
            pomodoroWorker.postMessage({ command: 'updateSettings', newSettings: pomodoroSettings });
            pomodoroSettingsModal.classList.remove('active');
                showToast("Pomodoro settings saved!", "success");
        });
        
        function renderStudiconPicker(category) {
            const pickerContainer = document.getElementById('studicon-picker');
            if (!pickerContainer) return;
            
            pickerContainer.innerHTML = STUDICONS[category].map(url => `
                <div class="avatar-option" data-url="${url}">
                    <img src="${url}" alt="Studicon">
                </div>
            `).join('');
            
            const currentStudicon = (currentUserData && groupRealtimeData.members[currentUser.id]) ? groupRealtimeData.members[currentUser.id].studicon_url : null;

            if (currentStudicon) {
                const selectedOption = pickerContainer.querySelector(`.avatar-option[data-url="${currentStudicon}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }
        }

        function openStudiconStore() {
            const modal = document.getElementById('studicon-store-modal');
            const categoryTabsContainer = document.getElementById('studicon-category-tabs');
            const categories = Object.keys(STUDICONS);
            
            categoryTabsContainer.innerHTML = categories.map((cat, index) => `
                <button class="studicon-category-tab flex-1 py-2 px-4 rounded-t-lg font-semibold text-sm ${index === 0 ? 'ranking-tab-btn active' : 'ranking-tab-btn'}" data-category="${cat}">${cat}</button>
            `).join('');
            
            renderStudiconPicker(categories[0]);
            modal.classList.add('active');
        }
        
        ael('studicon-store-modal', 'click', async (e) => {
            const tab = e.target.closest('.studicon-category-tab');
            if (tab && !tab.classList.contains('active')) {
                document.querySelectorAll('.studicon-category-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                renderStudiconPicker(tab.dataset.category);
                return;
            }
            
            const option = e.target.closest('.avatar-option');
            if (option) {
                document.querySelectorAll('#studicon-picker .avatar-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                return;
            }

            const saveBtn = e.target.closest('#save-studicon-btn');
            if (saveBtn) {
                const selectedStudicon = document.querySelector('#studicon-picker .avatar-option.selected')?.dataset.url;
                if (selectedStudicon && currentUser) {
                    try {
                        const { error } = await supabase
                            .from('profiles')
                            .update({ studicon_url: selectedStudicon })
                            .eq('id', currentUser.id);
                        if (error) throw error;
                        document.getElementById('studicon-store-modal').classList.remove('active');
                        showToast('Studicon updated!', 'success');
                    } catch (error) {
                        console.error("Studicon update failed:", error);
                        showToast('Failed to update studicon.', 'error');
                    }
                } else {
                    showToast('Please select a studicon.', 'info');
                }
            }
        });

        ael('edit-group-info-form', 'submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            const groupId = document.getElementById('edit-group-id-input').value;
            const updatedData = {
                name: document.getElementById('edit-group-name').value.trim(),
                description: document.getElementById('edit-group-description').value.trim(),
                category: document.getElementById('edit-group-category').value,
                timeGoal: parseInt(document.getElementById('edit-group-goal').value, 10),
                capacity: parseInt(document.getElementById('edit-group-capacity').value, 10),
                password: document.getElementById('edit-group-password').value.trim()
            };

            try {
                await updateGroup(groupId, updatedData);
                showToast('Group info updated successfully!', 'success');
                document.getElementById('edit-group-info-modal').classList.remove('active');
            } catch (error) {
                console.error('Error updating group info:', error);
                showToast('Failed to update group info.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        });

        ael('edit-profile-form', 'submit', async(e) => {
             e.preventDefault();
            if (!currentUser) return;
            const newUsername = document.getElementById('edit-username-input').value.trim();
            if (newUsername.length < 3) {
                showToast('Username must be at least 3 characters long.', 'error');
                return;
            }

            try {
                await updateUsername(newUsername);
                editProfileModal.classList.remove('active');
            } catch (error) {
                console.error('Error updating profile:', error);
                if (typeof showToast === 'function') showToast('Failed to update profile.', 'error');
            }
        });

        ael('edit-session-form', 'submit', async (e) => {
            e.preventDefault();
            const modal = document.getElementById('edit-session-modal');
            const sessionId = document.getElementById('edit-session-id').value;
            const newDurationMinutes = parseInt(document.getElementById('edit-session-duration').value, 10);
            const oldDurationSeconds = parseInt(document.getElementById('edit-session-old-duration').value, 10);
            const endedAt = new Date(document.getElementById('edit-session-ended-at').value);
            
            if (isNaN(newDurationMinutes) || newDurationMinutes < 1) {
                showToast('Please enter a valid duration.', 'error');
                return;
            }
            
            const newDurationSeconds = newDurationMinutes * 60;
            const durationDifference = newDurationSeconds - oldDurationSeconds;

            try {
                // Determine if the session being edited is a study or break session
                const { data: sessionRow, error: sessionErr } = await supabase
                    .from('sessions')
                    .select('type, profile_id')
                    .eq('id', sessionId)
                    .single();
                if (sessionErr) throw sessionErr;

                const sessionType = sessionRow?.type || 'study';

                const { error: updateSessionErr } = await supabase
                    .from('sessions')
                    .update({ durationSeconds: newDurationSeconds })
                    .eq('id', sessionId);
                if (updateSessionErr) throw updateSessionErr;

                const profile = await fetchProfile(currentUser.id);
                const profileUpdates = {};

                const sessionDateStr = endedAt.toISOString().split('T')[0];
                const todayStr = getCurrentDate().toISOString().split('T')[0];
                if (sessionDateStr === todayStr) {
                    if (sessionType === 'study') {
                        const currentToday = profile?.total_time_today?.seconds || 0;
                        totalTimeTodayInSeconds = Math.max(0, currentToday + durationDifference);
                        profileUpdates.total_time_today = { date: todayStr, seconds: totalTimeTodayInSeconds };
                    } else { // 'break'
                        const currentBreak = profile?.total_break_time_today?.seconds || 0;
                        totalBreakTimeTodayInSeconds = Math.max(0, currentBreak + durationDifference);
                        profileUpdates.total_break_time_today = { date: todayStr, seconds: totalBreakTimeTodayInSeconds };
                    }
                }

                if (sessionType === 'study') {
                    const totalStudy = Math.max(0, (profile?.total_study_seconds || 0) + durationDifference);
                    profileUpdates.total_study_seconds = totalStudy;
                } else {
                    const totalBreak = Math.max(0, (profile?.total_break_seconds || 0) + durationDifference);
                    profileUpdates.total_break_seconds = totalBreak;
                }

                await updateProfile(currentUser.id, profileUpdates);

                modal.classList.remove('active');
                showToast("Session updated successfully!", "success");
            } catch (error) {
                 console.error("Error updating session:", error);
                showToast("Failed to update session.", "error");
            }
        });

        ael('study-goal-form', 'submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const goal = parseInt(document.getElementById('study-goal-input').value, 10);
            if (isNaN(goal) || goal < 1 || goal > 24) {
                showToast('Please enter a valid goal between 1 and 24.', 'error');
                return;
            }
            const { error: upErr } = await supabase
                .from('profiles')
                .update({ study_goal_hours: goal })
                .eq('id', currentUser.id);
            if (upErr) {
                showToast('Failed to update study goal.', 'error');
                return;
            }
            currentUserData.study_goal_hours = goal;
            studyGoalModal.classList.remove('active');
            showToast('Study goal updated!', 'success');
        });

        // Ranking Scope Switch Listeners
        ael('group-ranking-scope-btn', 'click', () => {
            if (!document.getElementById('group-ranking-scope-btn').classList.contains('active')) {
                document.getElementById('global-ranking-scope-btn').classList.remove('active');
                document.getElementById('group-ranking-scope-btn').classList.add('active');
                const activePeriod = document.querySelector('#group-ranking-period-tabs .ranking-tab-btn.active')?.dataset.period || 'weekly';
                renderGroupLeaderboard(activePeriod);
            }
        });

        ael('global-ranking-scope-btn', 'click', () => {
            if (!document.getElementById('global-ranking-scope-btn').classList.contains('active')) {
                document.getElementById('group-ranking-scope-btn').classList.remove('active');
                document.getElementById('global-ranking-scope-btn').classList.add('active');
                const activePeriod = document.querySelector('#group-ranking-period-tabs .ranking-tab-btn.active')?.dataset.period || 'weekly';
                renderLeaderboard(activePeriod, 'group-ranking-list');
            }
        });

        ael('group-settings-modal', 'click', async (e) => {
            const item = e.target.closest('.group-settings-item');
            if (!item) return;

            if (item.dataset.disabled === 'true') {
                showToast('Only the group leader can access this setting.', 'info');
                return;
            }

            const action = item.dataset.action;
            const modal = document.getElementById('group-settings-modal');

            switch(action) {
                case 'leave-group':
                    modal.classList.remove('active'); // Close settings modal first
                    showConfirmationModal(
                        'Leave Group?',
                        'Are you sure you want to leave this group? This action cannot be undone.',
                        async () => {
                            if (!currentUser || !currentGroupId) return;

                            const { data: groupData, error: groupErr } = await supabase
                                .from('groups')
                                .select('leaderId, members')
                                .eq('id', currentGroupId)
                                .single();
                            if (groupErr) {
                                console.error('Error fetching group:', groupErr);
                                showToast('Failed to leave the group.', 'error');
                                return;
                            }
                            if (groupData.leaderId === currentUser.id && (groupData.members?.length || 0) > 1) {
                                showToast('Please transfer leadership or kick all members before leaving.', 'error');
                                return;
                            }

                            const { data: userData, error: userErr } = await supabase
                                .from('profiles')
                                .select('joined_groups')
                                .eq('id', currentUser.id)
                                .single();
                            if (userErr) {
                                console.error('Error fetching user profile:', userErr);
                                showToast('Failed to leave the group.', 'error');
                                return;
                            }

                            const updatedJoinedGroups = (userData.joined_groups || []).filter(id => id !== currentGroupId);
                            const updatedMembers = (groupData.members || []).filter(id => id !== currentUser.id);

                            const { error: upUserErr } = await supabase
                                .from('profiles')
                                .update({ joined_groups: updatedJoinedGroups })
                                .eq('id', currentUser.id);
                            const { error: upGroupErr } = await supabase
                                .from('groups')
                                .update({ members: updatedMembers })
                                .eq('id', currentGroupId);

                            if (upUserErr || upGroupErr) {
                                console.error('Error leaving group:', upUserErr || upGroupErr);
                                showToast('Failed to leave the group.', 'error');
                                return;
                            }

                            showToast('You have left the group.', 'success');
                            renderJoinedGroups();
                            showPage('page-my-groups');
                        }
                    );
                    break;
                case 'wake-up-group':
                    modal.classList.remove('active');
                    showConfirmationModal(
                        'Wake Up All Idle Members?',
                        'This will send a notification to every member who is not currently studying.',
                        async () => {
                            try {
                                const { data, error } = await supabase.functions.invoke('send-group-wake-up-notification', {
                                    body: {
                                        groupId: currentGroupId,
                                        senderId: currentUser.id,
                                        appId
                                    }
                                });
                                if (!error && data?.success) {
                                    showToast(`Wake up call sent to ${data.sentCount} members.`, 'success');
                                } else {
                                    showToast(data?.message || 'Could not send wake up call.', 'error');
                                }
                            } catch (error) {
                                console.error('Error sending group wake up call:', error);
                                showToast('An error occurred.', 'error');
                            }
                        }
                    );
                    break;
                case 'edit-info':
                    openEditGroupInfoModal();
                    modal.classList.remove('active');
                    break;
                case 'group-rules':
                    openGroupRulesModal();
                    modal.classList.remove('active');
                    break;
                default:
                    showToast(`'${item.textContent.trim()}' feature is coming soon!`, 'info');
                    modal.classList.remove('active');
                    break;
            }
        });


        window.addEventListener('click', (e) => {
            if (!e.target.closest('.subject-options-btn')) {
                document.querySelectorAll('.subject-options-menu').forEach(m => m.classList.remove('active'));
            }
            if (!e.target.closest('.log-options-btn')) {
                document.querySelectorAll('.log-options-menu').forEach(m => m.classList.remove('active'));
            }
        });
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
            modal.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => { modal.classList.remove('active'); });
            });
        });

        window.onload = () => {
            restoreUser().then(routeAfterAuth);
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // FIX: Add the missing event listener for profile picture uploads.
            ael('profile-picture-upload', 'change', e => {
                const file = e.target.files?.[0];
                if (file) {
                    uploadProfilePicture(file);
                }
            });

            const pomodoroSettingsForm = document.getElementById('pomodoro-settings-form');
            if (pomodoroSettingsForm) {
                pomodoroSettingsForm.addEventListener('change', (e) => {
                    const target = e.target;
                    if (target.matches('select[id^="pomodoro-"]')) {
                        const soundUrl = target.value;
                        const volume = parseFloat(document.getElementById('pomodoro-volume').value);
                        playSound(soundUrl, volume);
                    } else if (target.id === 'pomodoro-volume') {
                        const sampleSoundUrl = document.getElementById('pomodoro-focus-sound').value;
                        const volume = parseFloat(target.value);
                        playSound(sampleSoundUrl, volume);
                    }
                });
            }

            ael('group-study-timer-btn', 'click', async () => {
                if (currentUserData.joined_groups && currentUserData.joined_groups.length > 0) {
                    const targetGroupId = currentGroupId && currentUserData.joined_groups.includes(currentGroupId) ? currentGroupId : currentUserData.joined_groups[0];
                    currentGroupId = targetGroupId;
                    showPage('page-group-detail');
                    renderGroupDetail(targetGroupId);
                } else {
                    showPage('page-my-groups');
                }
            });

            // Handler for form submissions
            plannerPage.addEventListener('submit', e => {
                 if (e.target.id === 'category-add-task-form') {
                    e.preventDefault();
                    const input = document.getElementById('category-add-task-input');
                    const title = input.value.trim();
                    if (title) {
                        let dueDate = null;
                        const today = new Date();
                        if (plannerState.activeCategory === 'today') {
                            dueDate = today;
                        } else if (plannerState.activeCategory === 'tomorrow') {
                            const tomorrow = new Date();
                            tomorrow.setDate(today.getDate() + 1);
                            dueDate = tomorrow;
                        }
                        
                        addPlannerTask(title, dueDate ? dueDate.toISOString().split('T')[0] : null);
                        input.value = '';
                    }
                }
            });

        // --- END OF UNIFIED PLANNER LISTENERS ---

        ael('quick-add-task-form', 'submit', async (e) => {
            e.preventDefault();
                if (!currentUser) return;
                const modal = document.getElementById('add-subject-modal');
                const subjectName = document.getElementById('add-subject-name').value.trim();
                const colorEl = document.querySelector('#add-subject-modal .color-dot.selected');
                
                if (!subjectName || !colorEl) {
                    showToast('Please provide a name and select a color.', 'error');
                    return;
                }
                const color = colorEl.dataset.color;

                const { data: lastSubject } = await supabase
                    .from('subjects')
                    .select('order')
                    .eq('profile_id', currentUser.id)
                    .order('order', { ascending: false })
                    .limit(1)
                    .maybeSingle();
                const lastOrder = lastSubject?.order ?? -1;

                await supabase.from('subjects').insert({
                    profile_id: currentUser.id,
                    name: subjectName,
                    color,
                    order: lastOrder + 1
                });
                modal.classList.remove('active');
                showToast(`Subject "${subjectName}" added!`, 'success');
            });

            // Ranking Page Tabs
            ael('page-ranking', 'click', (e) => {
                const tab = e.target.closest('.ranking-tab-btn');
                if (tab) {
                    const period = tab.dataset.period;
                    renderLeaderboard(period);
                    return;
                }

                const rankingItem = e.target.closest('.ranking-item[data-user-id]');
                if (rankingItem) {
                    const userId = rankingItem.dataset.userId;
                    if (userId && userId !== currentUser.id) {
                        showUserProfileModal(userId);
                    }
                }
            });

            // Planner Page Form Submission (Delegated)
            ael('page-planner', 'submit', (e) => {
                if (e.target.id === 'add-planner-task-form') {
                    e.preventDefault();
                    const input = document.getElementById('add-planner-task-input');
                    const title = input.value.trim();
                    if (title) {
                        addPlannerTask(title);
                        input.value = '';
                    }
                }
            });
            
            // Group Settings Modal Actions (Delegated)
            const groupSettingsModal = document.getElementById('group-settings-modal');
            if (groupSettingsModal) {
                groupSettingsModal.addEventListener('click', (e) => {
                    const item = e.target.closest('.group-settings-item');
                    if (item) {
                        const action = item.dataset.action;
                        switch(action) {
                            case 'edit-info':
                                openEditGroupInfoModal();
                                break;
                            default:
                                showToast(`'${item.textContent}' feature is coming soon!`, 'info');
                                break;
                        }
                        groupSettingsModal.classList.remove('active');
                    }
                });
            }

            // --- END: ADDED EVENT LISTENERS ---

            // --- Service Worker Registration (Robust Version) ---
        if ('serviceWorker' in navigator) {
            // Service Workers require a secure context (HTTPS or localhost) to register.
            // This check prevents the registration error in unsupported environments (like 'blob:').
            if (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                // IMPORTANT CHANGE HERE: Use './service-worker.js' or '/Focus-Clock/service-worker.js'
                // if your app is hosted in a subfolder like /Focus-Clock/
                // './service-worker.js' is generally preferred for relative paths.
                navigator.serviceWorker
                    .register('./service-worker.js', { scope: './' }) // Updated path and added scope
                    .then(registration => {
                        console.log('Service Worker registered successfully with scope:', registration.scope);
                        // --- START NEW CODE FOR SERVICE WORKER UPDATES ---
                        registration.onupdatefound = () => {
                            const installingWorker = registration.installing;
                            if (installingWorker) {
                                installingWorker.onstatechange = () => {
                                    if (installingWorker.state === 'installed') {
                                        if (navigator.serviceWorker.controller) {
                                            showToast('New version available! Refresh for updates.', 'info', 5000);
                                            console.log('New content is available; please refresh.');
                                        } else {
                                            console.log('Content is cached for offline use.');
                                        }
                                    }
                                };
                            }
                        };
                        // --- END NEW CODE FOR SERVICE WORKER UPDATES ---
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });

                // --- START NEW CODE TO RELOAD PAGE ON CONTROLLER CHANGE ---
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('New service worker activated, reloading page for latest content.');
                    window.location.reload();
                });
                // --- END NEW CODE TO RELOAD PAGE ON CONTROLLER CHANGE ---

            } else {
                console.warn('Service Worker not registered. This feature requires a secure context (HTTPS or localhost). The Pomodoro timer will be less reliable in the background.');
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const usernameAvatarPicker = document.getElementById('username-avatar-picker');
            if (usernameAvatarPicker) {
                usernameAvatarPicker.innerHTML = PRESET_AVATARS.map((url, index) => `
                    <div class="avatar-option ${index === 0 ? 'selected' : ''}">
                        <img src="${url}" alt="Avatar ${index + 1}">
                    </div>
                `).join('');
                
                usernameAvatarPicker.addEventListener('click', e => {
                    const option = e.target.closest('.avatar-option');
                    if (option) {
                        usernameAvatarPicker.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                    }
                });
            }

            const profileAvatar = document.getElementById('profile-page-avatar');
            if (profileAvatar) {
                profileAvatar.addEventListener('click', () => {
                     showConfirmationModal(
                        'Change the profile image', 
                        '', // No message needed, buttons are the options
                        () => { // On Confirm (Choose from Album)
                            document.getElementById('profile-picture-upload').click();
                        },
                        () => { // On Cancel (Choose Character)
                            const characterPickerModal = document.getElementById('avatar-character-modal');
                            const picker = document.getElementById('avatar-character-picker');
                            picker.innerHTML = PRESET_AVATARS.map(url => {
                                const isSelected = currentUserData.photo_url === url;
                                return `<div class="avatar-option ${isSelected ? 'selected' : ''}"><img src="${url}" alt="Character"></div>`
                            }).join('');
                            characterPickerModal.classList.add('active');
                        },
                        'Choose image from the album', // Confirm button text
                        'Choose character' // Cancel button text
                    );
                });
            }

            const characterPicker = document.getElementById('avatar-character-picker');
            if(characterPicker) {
                characterPicker.addEventListener('click', e => {
                    const option = e.target.closest('.avatar-option');
                    if (option) {
                        characterPicker.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                    }
                });
            }

            ael('save-character-avatar-btn', 'click', async () => {
                const selectedAvatar = document.querySelector('#avatar-character-picker .avatar-option.selected img')?.src;
                if (selectedAvatar && currentUser) {
                    try {
                        const { error } = await supabase
                            .from('profiles')
                            .update({ photo_url: selectedAvatar })
                            .eq('id', currentUser.id);
                        if (error) throw error;
                        document.getElementById('avatar-character-modal').classList.remove('active');
                        showToast('Avatar updated!', 'success');
                        await loadMyProfile();
                    } catch (error) {
                        console.error("Avatar update failed:", error);
                        showToast('Failed to update avatar.', 'error');
                    }
                } else {
                    showToast('Please select a character.', 'info');
                }
            });

        });

// --- Guest sign-in using generated email/password (Supabase has no true anonymous auth) ---
async function signInAsGuest() {
  try {
    const id = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36) + Math.random().toString(36).slice(2));
    const guestEmail = `${id}@guest.pulsepom.app`;
    const guestPassword = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : (Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2));

    const { data, error } = await supabase.auth.signUp({ email: guestEmail, password: guestPassword });
    if (error) {
      console.error('Guest signup failed:', error);
      if (typeof showToast === 'function') showToast('Guest login not available right now', 'error');
      return;
    }

    if (typeof showToast === 'function') showToast('Signed in as guest', 'success');
    window.currentUser = data.user;
    if (typeof ensureProfileRow === 'function') await ensureProfileRow();
    if (typeof loadMyProfile === 'function') loadMyProfile();
  } catch (err) {
    console.error('signInAsGuest crashed:', err);
  }
}

// Backward-compat alias if your HTML calls signInAnonymously()
async function signInAnonymously(e) {
  if (e && typeof e.preventDefault === 'function') e.preventDefault();
  return signInAsGuest();
}


// --- Update username and refresh UI ---
async function updateUsername(newName) {
  try {
    const { data: userRes, error: uErr } = await supabase.auth.getUser();
    if (uErr || !userRes?.user) {
      if (typeof showToast === 'function') showToast('Please sign in first.', 'error');
      return;
    }
    const uid = userRes.user.id;
    newName = (newName || '').trim();
    if (newName.length < 3) {
      if (typeof showToast === 'function') showToast('Username must be at least 3 characters.', 'error');
      return;
    }

    const { data, error } = await supabase
      .from('profiles')
      .update({ username: newName, completed_setup: true })
      .eq('id', uid)
      .select('id, username')
      .maybeSingle();

    if (error) {
      console.error('Username update failed:', error);
      if (typeof showToast === 'function') showToast(error.message || 'Could not update username', 'error');
      return;
    }

    if (typeof showToast === 'function') showToast('Username updated!', 'success');
    if (typeof loadMyProfile === 'function') loadMyProfile();
  } catch (e) {
  console.error('updateUsername crashed:', e);
  }
}

</script>

</body>
</html>








